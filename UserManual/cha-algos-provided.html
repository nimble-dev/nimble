<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Sequential Monte Carlo, Particle MCMC, Iterated Filtering, and MCEM | NimbleUserManual.knit</title>
  <meta name="description" content="This is the NIMBLE User Manual." />
  <meta name="generator" content="bookdown 0.34 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Sequential Monte Carlo, Particle MCMC, Iterated Filtering, and MCEM | NimbleUserManual.knit" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/nimble-icon.png" />
  <meta property="og:description" content="This is the NIMBLE User Manual." />
  <meta name="github-repo" content="nimble-dev/nimble" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Sequential Monte Carlo, Particle MCMC, Iterated Filtering, and MCEM | NimbleUserManual.knit" />
  
  <meta name="twitter:description" content="This is the NIMBLE User Manual." />
  <meta name="twitter:image" content="/nimble-icon.png" />




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="cha-mcmc.html"/>
<link rel="next" href="cha-spatial.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<img src="./nimble-icon.png"
     width=100>
<li><a href="./cha-welcome-nimble.html">NIMBLE User Manual, Version 1.0.0</a></li>
<li><a href="https://github.com/nimble-dev/nimble">NIMBLE Development Team</a></li>
<li><a href="https://R-nimble.org">https://R-nimble.org</a></li>

<li class="divider"></li>
<li class="part"><span><b>I Introduction</b></span></li>
<li class="chapter" data-level="1" data-path="cha-welcome-nimble.html"><a href="cha-welcome-nimble.html"><i class="fa fa-check"></i><b>1</b> Welcome to NIMBLE</a>
<ul>
<li class="chapter" data-level="1.1" data-path="cha-welcome-nimble.html"><a href="cha-welcome-nimble.html#sec:what-is-nimble"><i class="fa fa-check"></i><b>1.1</b> What does NIMBLE do?</a></li>
<li class="chapter" data-level="1.2" data-path="cha-welcome-nimble.html"><a href="cha-welcome-nimble.html#how-to-use-this-manual"><i class="fa fa-check"></i><b>1.2</b> How to use this manual</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html"><i class="fa fa-check"></i><b>2</b> Lightning introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:brief-example"><i class="fa fa-check"></i><b>2.1</b> A brief example</a></li>
<li class="chapter" data-level="2.2" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:creating-model"><i class="fa fa-check"></i><b>2.2</b> Creating a model</a></li>
<li class="chapter" data-level="2.3" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:compiling-model"><i class="fa fa-check"></i><b>2.3</b> Compiling the model</a></li>
<li class="chapter" data-level="2.4" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:intro-runMCMC"><i class="fa fa-check"></i><b>2.4</b> One-line invocation of MCMC</a></li>
<li class="chapter" data-level="2.5" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:creating-mcmc"><i class="fa fa-check"></i><b>2.5</b> Creating, compiling and running a basic MCMC configuration</a></li>
<li class="chapter" data-level="2.6" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:customizing-mcmc"><i class="fa fa-check"></i><b>2.6</b> Customizing the MCMC</a></li>
<li class="chapter" data-level="2.7" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:running-mcem"><i class="fa fa-check"></i><b>2.7</b> Running MCEM</a></li>
<li class="chapter" data-level="2.8" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:creating-your-own"><i class="fa fa-check"></i><b>2.8</b> Creating your own functions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html"><i class="fa fa-check"></i><b>3</b> More introduction</a>
<ul>
<li class="chapter" data-level="3.1" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html#nimble-adopts-and-extends-the-bugs-language-for-specifying-models"><i class="fa fa-check"></i><b>3.1</b> NIMBLE adopts and extends the BUGS language for specifying models</a></li>
<li class="chapter" data-level="3.2" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html#sec:nimble-lang-writ"><i class="fa fa-check"></i><b>3.2</b> nimbleFunctions for writing algorithms</a></li>
<li class="chapter" data-level="3.3" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html#sec:nimble-algor-libr"><i class="fa fa-check"></i><b>3.3</b> The NIMBLE algorithm library</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html"><i class="fa fa-check"></i><b>4</b> Installing NIMBLE</a>
<ul>
<li class="chapter" data-level="4.1" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#sec:requ-run-nimble"><i class="fa fa-check"></i><b>4.1</b> Requirements to run NIMBLE</a></li>
<li class="chapter" data-level="4.2" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#sec:compiler"><i class="fa fa-check"></i><b>4.2</b> Installing a C++ compiler for NIMBLE to use</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#macos"><i class="fa fa-check"></i><b>4.2.1</b> MacOS</a></li>
<li class="chapter" data-level="4.2.2" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#linux"><i class="fa fa-check"></i><b>4.2.2</b> Linux</a></li>
<li class="chapter" data-level="4.2.3" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#windows"><i class="fa fa-check"></i><b>4.2.3</b> Windows</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#installing-the-nimble-package"><i class="fa fa-check"></i><b>4.3</b> Installing the NIMBLE package</a></li>
<li class="chapter" data-level="4.4" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#troubleshooting-installation-problems"><i class="fa fa-check"></i><b>4.4</b> Troubleshooting installation problems</a></li>
<li class="chapter" data-level="4.5" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#customizing-your-installation"><i class="fa fa-check"></i><b>4.5</b> Customizing your installation</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#using-your-own-copy-of-eigen"><i class="fa fa-check"></i><b>4.5.1</b> Using your own copy of Eigen</a></li>
<li class="chapter" data-level="4.5.2" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#using-libnimble"><i class="fa fa-check"></i><b>4.5.2</b> Using libnimble</a></li>
<li class="chapter" data-level="4.5.3" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#sec:blas"><i class="fa fa-check"></i><b>4.5.3</b> BLAS and LAPACK</a></li>
<li class="chapter" data-level="4.5.4" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#customizing-compilation-of-the-nimble-generated-c"><i class="fa fa-check"></i><b>4.5.4</b> Customizing compilation of the NIMBLE-generated C++</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Models in NIMBLE</b></span></li>
<li class="chapter" data-level="5" data-path="cha-writing-models.html"><a href="cha-writing-models.html"><i class="fa fa-check"></i><b>5</b> Writing models in NIMBLE’s dialect of BUGS</a>
<ul>
<li class="chapter" data-level="5.1" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:supp-feat-bugs"><i class="fa fa-check"></i><b>5.1</b> Comparison to BUGS dialects supported by WinBUGS, OpenBUGS and JAGS</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="cha-writing-models.html"><a href="cha-writing-models.html#supported-features-of-bugs-and-jags"><i class="fa fa-check"></i><b>5.1.1</b> Supported features of BUGS and JAGS</a></li>
<li class="chapter" data-level="5.1.2" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:extensions-bugs"><i class="fa fa-check"></i><b>5.1.2</b> NIMBLE’s Extensions to BUGS and JAGS</a></li>
<li class="chapter" data-level="5.1.3" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:not-yet-supported"><i class="fa fa-check"></i><b>5.1.3</b> Not-supported features of BUGS and JAGS</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="cha-writing-models.html"><a href="cha-writing-models.html#writing-models"><i class="fa fa-check"></i><b>5.2</b> Writing models</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="cha-writing-models.html"><a href="cha-writing-models.html#declaring-stochastic-and-deterministic-nodes"><i class="fa fa-check"></i><b>5.2.1</b> Declaring stochastic and deterministic nodes</a></li>
<li class="chapter" data-level="5.2.2" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:more-kinds-bugs"><i class="fa fa-check"></i><b>5.2.2</b> More kinds of BUGS declarations</a></li>
<li class="chapter" data-level="5.2.3" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:vectorized-versus-scalar-declarations"><i class="fa fa-check"></i><b>5.2.3</b> Vectorized versus scalar declarations</a></li>
<li class="chapter" data-level="5.2.4" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:dists-and-functions"><i class="fa fa-check"></i><b>5.2.4</b> Available distributions</a></li>
<li class="chapter" data-level="5.2.5" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:BUGS-lang-fxns"><i class="fa fa-check"></i><b>5.2.5</b> Available BUGS language functions</a></li>
<li class="chapter" data-level="5.2.6" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:BUGS-link"><i class="fa fa-check"></i><b>5.2.6</b> Available link functions</a></li>
<li class="chapter" data-level="5.2.7" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:trunc"><i class="fa fa-check"></i><b>5.2.7</b> Truncation, censoring, and constraints</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="cha-building-models.html"><a href="cha-building-models.html"><i class="fa fa-check"></i><b>6</b> Building and using models</a>
<ul>
<li class="chapter" data-level="6.1" data-path="cha-building-models.html"><a href="cha-building-models.html#creating-model-objects"><i class="fa fa-check"></i><b>6.1</b> Creating model objects</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="cha-building-models.html"><a href="cha-building-models.html#using-nimblemodel-to-create-a-model"><i class="fa fa-check"></i><b>6.1.1</b> Using <em>nimbleModel</em> to create a model</a></li>
<li class="chapter" data-level="6.1.2" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:readBUGSmodel"><i class="fa fa-check"></i><b>6.1.2</b> Creating a model from standard BUGS and JAGS input files</a></li>
<li class="chapter" data-level="6.1.3" data-path="cha-building-models.html"><a href="cha-building-models.html#sub:multiple-instances"><i class="fa fa-check"></i><b>6.1.3</b> Making multiple instances from the same model definition</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:nodes-and-variables"><i class="fa fa-check"></i><b>6.2</b> NIMBLE models are objects you can query and manipulate</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:what-are-nodes-and-variables"><i class="fa fa-check"></i><b>6.2.1</b> What are variables and nodes?</a></li>
<li class="chapter" data-level="6.2.2" data-path="cha-building-models.html"><a href="cha-building-models.html#determining-the-nodes-and-variables-in-a-model"><i class="fa fa-check"></i><b>6.2.2</b> Determining the nodes and variables in a model</a></li>
<li class="chapter" data-level="6.2.3" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:accessing-nodes"><i class="fa fa-check"></i><b>6.2.3</b> Accessing nodes</a></li>
<li class="chapter" data-level="6.2.4" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:how-nodes-are"><i class="fa fa-check"></i><b>6.2.4</b> How nodes are named</a></li>
<li class="chapter" data-level="6.2.5" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:why-use-node"><i class="fa fa-check"></i><b>6.2.5</b> Why use node names?</a></li>
<li class="chapter" data-level="6.2.6" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:cdisdata"><i class="fa fa-check"></i><b>6.2.6</b> Checking if a node holds data</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="cha-building-models.html"><a href="cha-building-models.html#using-models-in-parallel"><i class="fa fa-check"></i><b>6.3</b> Using models in parallel</a></li>
</ul></li>
<li class="part"><span><b>III Algorithms in NIMBLE</b></span></li>
<li class="chapter" data-level="7" data-path="cha-mcmc.html"><a href="cha-mcmc.html"><i class="fa fa-check"></i><b>7</b> MCMC</a>
<ul>
<li class="chapter" data-level="7.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:nimbleMCMC"><i class="fa fa-check"></i><b>7.1</b> One-line invocation of MCMC: <em>nimbleMCMC</em></a></li>
<li class="chapter" data-level="7.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:mcmc-configuration"><i class="fa fa-check"></i><b>7.2</b> The MCMC configuration</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:default-mcmc-conf"><i class="fa fa-check"></i><b>7.2.1</b> Default MCMC configuration</a></li>
<li class="chapter" data-level="7.2.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:customizing-mcmc-conf"><i class="fa fa-check"></i><b>7.2.2</b> Customizing the MCMC configuration</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:build-compile-mcmc"><i class="fa fa-check"></i><b>7.3</b> Building and compiling the MCMC</a></li>
<li class="chapter" data-level="7.4" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:initMCMC"><i class="fa fa-check"></i><b>7.4</b> Initializing MCMC</a></li>
<li class="chapter" data-level="7.5" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:runMCMC"><i class="fa fa-check"></i><b>7.5</b> User-friendly execution of MCMC algorithms: <em>runMCMC</em></a></li>
<li class="chapter" data-level="7.6" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:executing-the-mcmc-algorithm"><i class="fa fa-check"></i><b>7.6</b> Running the MCMC</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:mcmc-rerun"><i class="fa fa-check"></i><b>7.6.1</b> Rerunning versus restarting an MCMC</a></li>
<li class="chapter" data-level="7.6.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:sampler-time"><i class="fa fa-check"></i><b>7.6.2</b> Measuring sampler computation times: <em>getTimes</em></a></li>
<li class="chapter" data-level="7.6.3" data-path="cha-mcmc.html"><a href="cha-mcmc.html#assessing-the-adaption-process-of-rw-and-rw_block-samplers"><i class="fa fa-check"></i><b>7.6.3</b> Assessing the adaption process of <em>RW</em> and <em>RW_block</em> samplers</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:extracting-samples"><i class="fa fa-check"></i><b>7.7</b> Extracting MCMC samples</a></li>
<li class="chapter" data-level="7.8" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:WAIC"><i class="fa fa-check"></i><b>7.8</b> Calculating WAIC</a></li>
<li class="chapter" data-level="7.9" data-path="cha-mcmc.html"><a href="cha-mcmc.html#k-fold-cross-validation"><i class="fa fa-check"></i><b>7.9</b> k-fold cross-validation</a></li>
<li class="chapter" data-level="7.10" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:rjmcmc"><i class="fa fa-check"></i><b>7.10</b> Variable selection using Reversible Jump MCMC</a>
<ul>
<li class="chapter" data-level="7.10.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:rjmcmc-indicator"><i class="fa fa-check"></i><b>7.10.1</b> Using indicator variables</a></li>
<li class="chapter" data-level="7.10.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:rjmcmc-no-indicator"><i class="fa fa-check"></i><b>7.10.2</b> Without indicator variables</a></li>
</ul></li>
<li class="chapter" data-level="7.11" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:samplers-provided"><i class="fa fa-check"></i><b>7.11</b> Samplers provided with NIMBLE</a>
<ul>
<li class="chapter" data-level="7.11.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#conjugate-gibbs-samplers"><i class="fa fa-check"></i><b>7.11.1</b> Conjugate (‘Gibbs’) samplers</a></li>
<li class="chapter" data-level="7.11.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#subsec:HMC"><i class="fa fa-check"></i><b>7.11.2</b> Hamiltonian Monte Carlo (HMC)</a></li>
<li class="chapter" data-level="7.11.3" data-path="cha-mcmc.html"><a href="cha-mcmc.html#customized-log-likelihood-evaluations-rw_llfunction-sampler"><i class="fa fa-check"></i><b>7.11.3</b> Customized log-likelihood evaluations: <em>RW_llFunction sampler</em></a></li>
<li class="chapter" data-level="7.11.4" data-path="cha-mcmc.html"><a href="cha-mcmc.html#particle-mcmc-sampler"><i class="fa fa-check"></i><b>7.11.4</b> Particle MCMC sampler</a></li>
</ul></li>
<li class="chapter" data-level="7.12" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:mcmc-example-litters"><i class="fa fa-check"></i><b>7.12</b> Detailed MCMC example: <em>litters</em></a></li>
<li class="chapter" data-level="7.13" data-path="cha-mcmc.html"><a href="cha-mcmc.html#mcmc-suite-compare-mcmcs"><i class="fa fa-check"></i><b>7.13</b> Comparing different MCMCs with <em>MCMCsuite</em> and <em>compareMCMCs</em></a></li>
<li class="chapter" data-level="7.14" data-path="cha-mcmc.html"><a href="cha-mcmc.html#running-mcmc-chains-in-parallel"><i class="fa fa-check"></i><b>7.14</b> Running MCMC chains in parallel</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html"><i class="fa fa-check"></i><b>8</b> Sequential Monte Carlo, Particle MCMC, Iterated Filtering, and MCEM</a>
<ul>
<li class="chapter" data-level="8.1" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#particle-filters-sequential-monte-carlo-and-iterated-filtering"><i class="fa fa-check"></i><b>8.1</b> Particle filters / sequential Monte Carlo and iterated filtering</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#filtering-algorithms"><i class="fa fa-check"></i><b>8.1.1</b> Filtering algorithms</a></li>
<li class="chapter" data-level="8.1.2" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#sec:particle-mcmc"><i class="fa fa-check"></i><b>8.1.2</b> Particle MCMC (PMCMC)</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#monte-carlo-expectation-maximization-mcem"><i class="fa fa-check"></i><b>8.2</b> Monte Carlo Expectation Maximization (MCEM)</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#sec:estimate-mcem-cov"><i class="fa fa-check"></i><b>8.2.1</b> Estimating the asymptotic covariance From MCEM</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="cha-spatial.html"><a href="cha-spatial.html"><i class="fa fa-check"></i><b>9</b> Spatial models</a>
<ul>
<li class="chapter" data-level="9.1" data-path="cha-spatial.html"><a href="cha-spatial.html#intrinsic-gaussian-car-model-dcar_normal"><i class="fa fa-check"></i><b>9.1</b> Intrinsic Gaussian CAR model: <em>dcar_normal</em></a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="cha-spatial.html"><a href="cha-spatial.html#specification-and-density"><i class="fa fa-check"></i><b>9.1.1</b> Specification and density</a></li>
<li class="chapter" data-level="9.1.2" data-path="cha-spatial.html"><a href="cha-spatial.html#example"><i class="fa fa-check"></i><b>9.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="cha-spatial.html"><a href="cha-spatial.html#proper-gaussian-car-model-dcar_proper"><i class="fa fa-check"></i><b>9.2</b> Proper Gaussian CAR model: <em>dcar_proper</em></a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="cha-spatial.html"><a href="cha-spatial.html#specification-and-density-1"><i class="fa fa-check"></i><b>9.2.1</b> Specification and density</a></li>
<li class="chapter" data-level="9.2.2" data-path="cha-spatial.html"><a href="cha-spatial.html#example-1"><i class="fa fa-check"></i><b>9.2.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="cha-spatial.html"><a href="cha-spatial.html#sec:spatial-mcmc-sampling-car"><i class="fa fa-check"></i><b>9.3</b> MCMC Sampling of CAR models</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="cha-spatial.html"><a href="cha-spatial.html#initial-values"><i class="fa fa-check"></i><b>9.3.1</b> Initial values</a></li>
<li class="chapter" data-level="9.3.2" data-path="cha-spatial.html"><a href="cha-spatial.html#zero-neighbor-regions"><i class="fa fa-check"></i><b>9.3.2</b> Zero-neighbor regions</a></li>
<li class="chapter" data-level="9.3.3" data-path="cha-spatial.html"><a href="cha-spatial.html#zero-mean-constraint"><i class="fa fa-check"></i><b>9.3.3</b> Zero-mean constraint</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="cha-bnp.html"><a href="cha-bnp.html"><i class="fa fa-check"></i><b>10</b> Bayesian nonparametric models</a>
<ul>
<li class="chapter" data-level="10.1" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:bnpmixtures"><i class="fa fa-check"></i><b>10.1</b> Bayesian nonparametric mixture models</a></li>
<li class="chapter" data-level="10.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:crp"><i class="fa fa-check"></i><b>10.2</b> Chinese Restaurant Process model</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="cha-bnp.html"><a href="cha-bnp.html#specification-and-density-2"><i class="fa fa-check"></i><b>10.2.1</b> Specification and density</a></li>
<li class="chapter" data-level="10.2.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:excrp"><i class="fa fa-check"></i><b>10.2.2</b> Example</a></li>
<li class="chapter" data-level="10.2.3" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:extensionscrp"><i class="fa fa-check"></i><b>10.2.3</b> Extensions</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:sb"><i class="fa fa-check"></i><b>10.3</b> Stick-breaking model</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="cha-bnp.html"><a href="cha-bnp.html#specification-and-function"><i class="fa fa-check"></i><b>10.3.1</b> Specification and function</a></li>
<li class="chapter" data-level="10.3.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:exsb"><i class="fa fa-check"></i><b>10.3.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="cha-bnp.html"><a href="cha-bnp.html#mcmc-sampling-of-bnp-models"><i class="fa fa-check"></i><b>10.4</b> MCMC sampling of BNP models</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:mcmcdcrp"><i class="fa fa-check"></i><b>10.4.1</b> Sampling CRP models</a></li>
<li class="chapter" data-level="10.4.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:mcmcsb"><i class="fa fa-check"></i><b>10.4.2</b> Sampling stick-breaking models</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Programming with NIMBLE</b></span></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="11" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html"><i class="fa fa-check"></i><b>11</b> Writing simple nimbleFunctions</a>
<ul>
<li class="chapter" data-level="11.1" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:RC-intro"><i class="fa fa-check"></i><b>11.1</b> Introduction to simple nimbleFunctions</a></li>
<li class="chapter" data-level="11.2" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:r-fiunctions-implemented"><i class="fa fa-check"></i><b>11.2</b> R functions (or variants) implemented in NIMBLE</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#finding-help-for-nimbles-versions-of-r-functions"><i class="fa fa-check"></i><b>11.2.1</b> Finding help for NIMBLE’s versions of R functions</a></li>
<li class="chapter" data-level="11.2.2" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#basic-operations"><i class="fa fa-check"></i><b>11.2.2</b> Basic operations</a></li>
<li class="chapter" data-level="11.2.3" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:basic-math-linear"><i class="fa fa-check"></i><b>11.2.3</b> Math and linear algebra</a></li>
<li class="chapter" data-level="11.2.4" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:nimble-dist-funs"><i class="fa fa-check"></i><b>11.2.4</b> Distribution functions</a></li>
<li class="chapter" data-level="11.2.5" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:basic-flow-control"><i class="fa fa-check"></i><b>11.2.5</b> Flow control: <em>if-then-else</em>, <em>for</em>, <em>while</em>, and <em>stop</em></a></li>
<li class="chapter" data-level="11.2.6" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:print"><i class="fa fa-check"></i><b>11.2.6</b> <em>print</em> and <em>cat</em></a></li>
<li class="chapter" data-level="11.2.7" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:check-user-interr"><i class="fa fa-check"></i><b>11.2.7</b> Checking for user interrupts: <em>checkInterrupt</em></a></li>
<li class="chapter" data-level="11.2.8" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#optimization-optim-and-nimoptim"><i class="fa fa-check"></i><b>11.2.8</b> Optimization: <em>optim</em> and <em>nimOptim</em></a></li>
<li class="chapter" data-level="11.2.9" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:altern-keyw-some"><i class="fa fa-check"></i><b>11.2.9</b> ‘nim’ synonyms for some functions</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:how-nimble-handles"><i class="fa fa-check"></i><b>11.3</b> How NIMBLE handles types of variables</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:nimbleList-RCFuns"><i class="fa fa-check"></i><b>11.3.1</b> nimbleList data structures</a></li>
<li class="chapter" data-level="11.3.2" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:how-types-work"><i class="fa fa-check"></i><b>11.3.2</b> How numeric types work</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:decl-argum-return"><i class="fa fa-check"></i><b>11.4</b> Declaring argument and return types</a></li>
<li class="chapter" data-level="11.5" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:comp-nimbl-pass"><i class="fa fa-check"></i><b>11.5</b> Compiled nimbleFunctions pass arguments by reference</a></li>
<li class="chapter" data-level="11.6" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:calling-external-code"><i class="fa fa-check"></i><b>11.6</b> Calling external compiled code</a></li>
<li class="chapter" data-level="11.7" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:calling-R-code"><i class="fa fa-check"></i><b>11.7</b> Calling uncompiled R functions from compiled nimbleFunctions</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="cha-user-defined.html"><a href="cha-user-defined.html"><i class="fa fa-check"></i><b>12</b> Creating user-defined BUGS distributions and functions</a>
<ul>
<li class="chapter" data-level="12.1" data-path="cha-user-defined.html"><a href="cha-user-defined.html#sec:user-functions"><i class="fa fa-check"></i><b>12.1</b> User-defined functions</a></li>
<li class="chapter" data-level="12.2" data-path="cha-user-defined.html"><a href="cha-user-defined.html#sec:user-distributions"><i class="fa fa-check"></i><b>12.2</b> User-defined distributions</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="cha-user-defined.html"><a href="cha-user-defined.html#sec:registerDistributions"><i class="fa fa-check"></i><b>12.2.1</b> Using <em>registerDistributions</em> for alternative parameterizations and providing other information</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="cha-using-models.html"><a href="cha-using-models.html"><i class="fa fa-check"></i><b>13</b> Working with NIMBLE models</a>
<ul>
<li class="chapter" data-level="13.1" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:accessing-variables"><i class="fa fa-check"></i><b>13.1</b> The variables and nodes in a NIMBLE model</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:get-nodes"><i class="fa fa-check"></i><b>13.1.1</b> Determining the nodes in a model</a></li>
<li class="chapter" data-level="13.1.2" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:introduced-nodes"><i class="fa fa-check"></i><b>13.1.2</b> Understanding lifted nodes</a></li>
<li class="chapter" data-level="13.1.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:cdgetdependencies"><i class="fa fa-check"></i><b>13.1.3</b> Determining dependencies in a model</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:nodeInfo"><i class="fa fa-check"></i><b>13.2</b> Accessing information about nodes and variables</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="cha-using-models.html"><a href="cha-using-models.html#getting-distributional-information-about-a-node"><i class="fa fa-check"></i><b>13.2.1</b> Getting distributional information about a node</a></li>
<li class="chapter" data-level="13.2.2" data-path="cha-using-models.html"><a href="cha-using-models.html#getting-information-about-a-distribution"><i class="fa fa-check"></i><b>13.2.2</b> Getting information about a distribution</a></li>
<li class="chapter" data-level="13.2.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:getParam"><i class="fa fa-check"></i><b>13.2.3</b> Getting distribution parameter values for a node</a></li>
<li class="chapter" data-level="13.2.4" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:getBound"><i class="fa fa-check"></i><b>13.2.4</b> Getting distribution bounds for a node</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:cdcalc-cdsim-cdgetl"><i class="fa fa-check"></i><b>13.3</b> Carrying out model calculations</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="cha-using-models.html"><a href="cha-using-models.html#core-model-operations-calculation-and-simulation"><i class="fa fa-check"></i><b>13.3.1</b> Core model operations: calculation and simulation</a></li>
<li class="chapter" data-level="13.3.2" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:cdsimn-cdcalcn-cdget"><i class="fa fa-check"></i><b>13.3.2</b> Pre-defined nimbleFunctions for operating on model nodes: <em>simNodes</em>, <em>calcNodes</em>, and <em>getLogProbNodes</em></a></li>
<li class="chapter" data-level="13.3.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:access-log-prob"><i class="fa fa-check"></i><b>13.3.3</b> Accessing log probabilities via <em>logProb</em> variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="cha-data-structures.html"><a href="cha-data-structures.html"><i class="fa fa-check"></i><b>14</b> Data structures in NIMBLE</a>
<ul>
<li class="chapter" data-level="14.1" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:modelValues-struct"><i class="fa fa-check"></i><b>14.1</b> The modelValues data structure</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="cha-data-structures.html"><a href="cha-data-structures.html#creating-modelvalues-objects"><i class="fa fa-check"></i><b>14.1.1</b> Creating modelValues objects</a></li>
<li class="chapter" data-level="14.1.2" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:access-cont-modelv"><i class="fa fa-check"></i><b>14.1.2</b> Accessing contents of modelValues</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:nimbleLists"><i class="fa fa-check"></i><b>14.2</b> The nimbleList data structure</a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:predef-nimbleLists"><i class="fa fa-check"></i><b>14.2.1</b> Pre-defined nimbleList types</a></li>
<li class="chapter" data-level="14.2.2" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:eigen-nimFunctions"><i class="fa fa-check"></i><b>14.2.2</b> Using <em>eigen</em> and <em>svd</em> in nimbleFunctions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html"><i class="fa fa-check"></i><b>15</b> Writing nimbleFunctions to interact with models</a>
<ul>
<li class="chapter" data-level="15.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:writ-nimble-funct"><i class="fa fa-check"></i><b>15.1</b> Overview</a></li>
<li class="chapter" data-level="15.2" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:using-comp-nimbl"><i class="fa fa-check"></i><b>15.2</b> Using and compiling nimbleFunctions</a></li>
<li class="chapter" data-level="15.3" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#writing-setup-code"><i class="fa fa-check"></i><b>15.3</b> Writing setup code</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#useful-tools-for-setup-functions"><i class="fa fa-check"></i><b>15.3.1</b> Useful tools for setup functions</a></li>
<li class="chapter" data-level="15.3.2" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:access-modify-numer"><i class="fa fa-check"></i><b>15.3.2</b> Accessing and modifying numeric values from setup</a></li>
<li class="chapter" data-level="15.3.3" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#determining-numeric-types-in-nimblefunctions"><i class="fa fa-check"></i><b>15.3.3</b> Determining numeric types in nimbleFunctions</a></li>
<li class="chapter" data-level="15.3.4" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:determ-pers-texttts"><i class="fa fa-check"></i><b>15.3.4</b> Control of setup outputs</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:nimble-lang-comp"><i class="fa fa-check"></i><b>15.4</b> Writing run code</a>
<ul>
<li class="chapter" data-level="15.4.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:driv-models:-calc"><i class="fa fa-check"></i><b>15.4.1</b> Driving models: <em>calculate</em>, <em>calculateDiff</em>, <em>simulate</em>, <em>getLogProb</em></a></li>
<li class="chapter" data-level="15.4.2" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#getting-and-setting-variable-and-node-values"><i class="fa fa-check"></i><b>15.4.2</b> Getting and setting variable and node values</a></li>
<li class="chapter" data-level="15.4.3" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#getting-parameter-values-and-node-bounds"><i class="fa fa-check"></i><b>15.4.3</b> Getting parameter values and node bounds</a></li>
<li class="chapter" data-level="15.4.4" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:access-model-modelv"><i class="fa fa-check"></i><b>15.4.4</b> Using modelValues objects</a></li>
<li class="chapter" data-level="15.4.5" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:using-model-variable"><i class="fa fa-check"></i><b>15.4.5</b> Using model variables and modelValues in expressions</a></li>
<li class="chapter" data-level="15.4.6" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:incl-other-meth"><i class="fa fa-check"></i><b>15.4.6</b> Including other methods in a nimbleFunction</a></li>
<li class="chapter" data-level="15.4.7" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:using-other-nimbl"><i class="fa fa-check"></i><b>15.4.7</b> Using other nimbleFunctions</a></li>
<li class="chapter" data-level="15.4.8" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:virt-nimbl-nimbl"><i class="fa fa-check"></i><b>15.4.8</b> Virtual nimbleFunctions and nimbleFunctionLists</a></li>
<li class="chapter" data-level="15.4.9" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#character-objects"><i class="fa fa-check"></i><b>15.4.9</b> Character objects</a></li>
<li class="chapter" data-level="15.4.10" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:user-defined-data"><i class="fa fa-check"></i><b>15.4.10</b> User-defined data structures</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:user-samplers"><i class="fa fa-check"></i><b>15.5</b> Example: writing user-defined samplers to extend NIMBLE’s MCMC engine</a>
<ul>
<li class="chapter" data-level="15.5.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#user-defined-samplers-and-posterior-predictive-nodes"><i class="fa fa-check"></i><b>15.5.1</b> User-defined samplers and posterior predictive nodes</a></li>
</ul></li>
<li class="chapter" data-level="15.6" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#copying-nimblefunctions-and-nimble-models"><i class="fa fa-check"></i><b>15.6</b> Copying nimbleFunctions (and NIMBLE models)</a></li>
<li class="chapter" data-level="15.7" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:debugging"><i class="fa fa-check"></i><b>15.7</b> Debugging nimbleFunctions</a></li>
<li class="chapter" data-level="15.8" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#timing-nimblefunctions-with-run.time"><i class="fa fa-check"></i><b>15.8</b> Timing nimbleFunctions with <em>run.time</em></a></li>
<li class="chapter" data-level="15.9" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#clearing-and-unloading-compiled-objects"><i class="fa fa-check"></i><b>15.9</b> Clearing and unloading compiled objects</a></li>
<li class="chapter" data-level="15.10" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#reducing-memory-usage"><i class="fa fa-check"></i><b>15.10</b> Reducing memory usage</a></li>
</ul></li>
<li class="part"><span><b>V Automatic Derivatives in NIMBLE</b></span></li>
<li class="chapter" data-level="16" data-path="cha-AD.html"><a href="cha-AD.html"><i class="fa fa-check"></i><b>16</b> Automatic Derivatives</a>
<ul>
<li class="chapter" data-level="16.1" data-path="cha-AD.html"><a href="cha-AD.html#sec:use-derivs"><i class="fa fa-check"></i><b>16.1</b> How to turn on derivatives in a model</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="cha-AD.html"><a href="cha-AD.html#finish-setting-up-the-glmm-example"><i class="fa fa-check"></i><b>16.1.1</b> Finish setting up the GLMM example</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="cha-AD.html"><a href="cha-AD.html#how-to-use-laplace-approximation"><i class="fa fa-check"></i><b>16.2</b> How to use Laplace approximation</a></li>
<li class="chapter" data-level="16.3" data-path="cha-AD.html"><a href="cha-AD.html#how-to-support-derivatives-in-user-defined-functions-and-distributions"><i class="fa fa-check"></i><b>16.3</b> How to support derivatives in user-defined functions and distributions</a></li>
<li class="chapter" data-level="16.4" data-path="cha-AD.html"><a href="cha-AD.html#what-operations-are-and-arent-supported-for-ad"><i class="fa fa-check"></i><b>16.4</b> What operations are and aren’t supported for AD</a></li>
<li class="chapter" data-level="16.5" data-path="cha-AD.html"><a href="cha-AD.html#basics-of-obtaining-derivatives-in-nimblefunctions"><i class="fa fa-check"></i><b>16.5</b> Basics of obtaining derivatives in <code>nimbleFunctions</code></a>
<ul>
<li class="chapter" data-level="16.5.1" data-path="cha-AD.html"><a href="cha-AD.html#checking-derivatives-with-uncompiled-execution"><i class="fa fa-check"></i><b>16.5.1</b> Checking derivatives with uncompiled execution</a></li>
<li class="chapter" data-level="16.5.2" data-path="cha-AD.html"><a href="cha-AD.html#holding-some-local-variables-out-of-derivative-tracking"><i class="fa fa-check"></i><b>16.5.2</b> Holding some local variables out of derivative tracking</a></li>
<li class="chapter" data-level="16.5.3" data-path="cha-AD.html"><a href="cha-AD.html#using-ad-with-multiple-nimblefunctions"><i class="fa fa-check"></i><b>16.5.3</b> Using AD with multiple nimbleFunctions</a></li>
<li class="chapter" data-level="16.5.4" data-path="cha-AD.html"><a href="cha-AD.html#understanding-more-about-how-ad-works-taping-of-operations"><i class="fa fa-check"></i><b>16.5.4</b> Understanding more about how AD works: <em>taping</em> of operations</a></li>
<li class="chapter" data-level="16.5.5" data-path="cha-AD.html"><a href="cha-AD.html#resetting-a-nimderivs-call"><i class="fa fa-check"></i><b>16.5.5</b> Resetting a <code>nimDerivs</code> call</a></li>
<li class="chapter" data-level="16.5.6" data-path="cha-AD.html"><a href="cha-AD.html#a-note-on-performance-benchmarking"><i class="fa fa-check"></i><b>16.5.6</b> A note on performance benchmarking</a></li>
</ul></li>
<li class="chapter" data-level="16.6" data-path="cha-AD.html"><a href="cha-AD.html#advanced-uses-double-taping"><i class="fa fa-check"></i><b>16.6</b> Advanced uses: double taping</a></li>
<li class="chapter" data-level="16.7" data-path="cha-AD.html"><a href="cha-AD.html#derivatives-involving-model-calculations"><i class="fa fa-check"></i><b>16.7</b> Derivatives involving model calculations</a>
<ul>
<li class="chapter" data-level="16.7.1" data-path="cha-AD.html"><a href="cha-AD.html#method-1-nimderivs-of-modelcalculate"><i class="fa fa-check"></i><b>16.7.1</b> Method 1: <code>nimDerivs</code> of <code>model$calculate</code></a></li>
<li class="chapter" data-level="16.7.2" data-path="cha-AD.html"><a href="cha-AD.html#method-2-nimderivs-of-a-method-that-calls-modelcalculate"><i class="fa fa-check"></i><b>16.7.2</b> Method 2: <code>nimDerivs</code> of a method that calls <code>model$calculate</code></a></li>
</ul></li>
<li class="chapter" data-level="16.8" data-path="cha-AD.html"><a href="cha-AD.html#sec:parameter-transform"><i class="fa fa-check"></i><b>16.8</b> Parameter transformations</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="example-maximum-likelihood-estimation-using-optim-with-gradients-from-nimderivs..html"><a href="example-maximum-likelihood-estimation-using-optim-with-gradients-from-nimderivs..html"><i class="fa fa-check"></i><b>17</b> Example: maximum likelihood estimation using <code>optim</code> with gradients from <code>nimDerivs</code>.</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="cha-algos-provided" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Sequential Monte Carlo, Particle MCMC, Iterated Filtering, and MCEM<a href="cha-algos-provided.html#cha-algos-provided" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>The NIMBLE algorithm library is growing and currently includes a suite of sequential Monte Carlo (particle filtering) algorithms, particle MCMC for combining particle filters with MCMC, iterated filtering version 2 and Monte Carlo expectation maximization (MCEM) for maximum likelihood estimation, and k-fold cross-validation.</p>
<div id="particle-filters-sequential-monte-carlo-and-iterated-filtering" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Particle filters / sequential Monte Carlo and iterated filtering<a href="cha-algos-provided.html#particle-filters-sequential-monte-carlo-and-iterated-filtering" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>As of Version 0.10.0 of NIMBLE, all of NIMBLE’s sequential Monte Carlo/particle filtering functionality lives in the <code>nimbleSMC</code> package. Please load this package before trying to use these algorithms.</p>
<div id="filtering-algorithms" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Filtering algorithms<a href="cha-algos-provided.html#filtering-algorithms" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>NIMBLE includes algorithms for four different types of sequential Monte Carlo (also known as particle filters), which can be used to sample from the latent states and approximate the log likelihood of a state-space model. These include the bootstrap filter, the auxiliary particle filter, the Liu-West filter, and the ensemble Kalman filter. The iterated filtering version 2 (IF2) is a related method for maximum-likelihood estimation. Each of these is built with the eponymous functions <code>buildBootstrapFilter</code>, <code>buildAuxiliaryFilter</code>, <code>buildLiuWestFilter</code>, <code>buildEnsembleKF</code>, and <code>buildIteratedFilter2</code>. Each method requires setup arguments <code>model</code> and <code>nodes</code>; the latter should be a character vector specifying latent model nodes. In addition, each method can be customized using a <code>control</code> list argument. Details on the control options and specifics of the algorithms can be found in the help pages for the functions.</p>
<p>Once built, each filter can be run by specifying the number of particles. Each filter has a modelValues object named <code>mvEWSamples</code> that is populated with equally-weighted samples from the posterior distribution of the latent states (and in the case of the Liu-West filter, the posterior distribution of the top level parameters as well) as the filter is run. The bootstrap, auxiliary, and Liu-West filters, as well as the IF2 method, also have another modelValues object, <code>mvWSamples</code>. This has unequally-weighted samples from the posterior distribution of the latent states, along with weights for each particle. In addition, the bootstrap and auxiliary particle filters return estimates of the log-likelihood of the given state-space model.</p>
<p>We first create a linear state-space model to use as an example for our particle filter algorithms.</p>
<div class="sourceCode" id="cb198"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb198-1"><a href="cha-algos-provided.html#cb198-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Building a simple linear state-space model. </span></span>
<span id="cb198-2"><a href="cha-algos-provided.html#cb198-2" aria-hidden="true" tabindex="-1"></a><span class="co"># x is latent space, y is observed data</span></span>
<span id="cb198-3"><a href="cha-algos-provided.html#cb198-3" aria-hidden="true" tabindex="-1"></a>timeModelCode <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb198-4"><a href="cha-algos-provided.html#cb198-4" aria-hidden="true" tabindex="-1"></a>  x[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(mu_0, <span class="dv">1</span>)</span>
<span id="cb198-5"><a href="cha-algos-provided.html#cb198-5" aria-hidden="true" tabindex="-1"></a>  y[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(x[<span class="dv">1</span>], <span class="dv">1</span>)</span>
<span id="cb198-6"><a href="cha-algos-provided.html#cb198-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>t){</span>
<span id="cb198-7"><a href="cha-algos-provided.html#cb198-7" aria-hidden="true" tabindex="-1"></a>    x[i] <span class="sc">~</span> <span class="fu">dnorm</span>(x[i<span class="dv">-1</span>] <span class="sc">*</span> a <span class="sc">+</span> b, <span class="dv">1</span>)</span>
<span id="cb198-8"><a href="cha-algos-provided.html#cb198-8" aria-hidden="true" tabindex="-1"></a>    y[i] <span class="sc">~</span> <span class="fu">dnorm</span>(x[i] <span class="sc">*</span> c, <span class="dv">1</span>)</span>
<span id="cb198-9"><a href="cha-algos-provided.html#cb198-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb198-10"><a href="cha-algos-provided.html#cb198-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb198-11"><a href="cha-algos-provided.html#cb198-11" aria-hidden="true" tabindex="-1"></a>  a <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb198-12"><a href="cha-algos-provided.html#cb198-12" aria-hidden="true" tabindex="-1"></a>  b <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb198-13"><a href="cha-algos-provided.html#cb198-13" aria-hidden="true" tabindex="-1"></a>  c <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">1</span>,<span class="dv">1</span>)</span>
<span id="cb198-14"><a href="cha-algos-provided.html#cb198-14" aria-hidden="true" tabindex="-1"></a>  mu_0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb198-15"><a href="cha-algos-provided.html#cb198-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb198-16"><a href="cha-algos-provided.html#cb198-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-17"><a href="cha-algos-provided.html#cb198-17" aria-hidden="true" tabindex="-1"></a><span class="co"># simulate some data</span></span>
<span id="cb198-18"><a href="cha-algos-provided.html#cb198-18" aria-hidden="true" tabindex="-1"></a>t <span class="ot">&lt;-</span> <span class="dv">25</span>; mu_0 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb198-19"><a href="cha-algos-provided.html#cb198-19" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span> ,mu_0, <span class="dv">1</span>)</span>
<span id="cb198-20"><a href="cha-algos-provided.html#cb198-20" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, x, <span class="dv">1</span>)</span>
<span id="cb198-21"><a href="cha-algos-provided.html#cb198-21" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fl">0.5</span>; b <span class="ot">&lt;-</span> <span class="dv">1</span>; c <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb198-22"><a href="cha-algos-provided.html#cb198-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>t){</span>
<span id="cb198-23"><a href="cha-algos-provided.html#cb198-23" aria-hidden="true" tabindex="-1"></a>  x[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, x[i<span class="dv">-1</span>] <span class="sc">*</span> a <span class="sc">+</span> b, <span class="dv">1</span>)</span>
<span id="cb198-24"><a href="cha-algos-provided.html#cb198-24" aria-hidden="true" tabindex="-1"></a>  y[i] <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, x[i] <span class="sc">*</span> c, <span class="dv">1</span>)</span>
<span id="cb198-25"><a href="cha-algos-provided.html#cb198-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb198-26"><a href="cha-algos-provided.html#cb198-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-27"><a href="cha-algos-provided.html#cb198-27" aria-hidden="true" tabindex="-1"></a><span class="co"># build the model</span></span>
<span id="cb198-28"><a href="cha-algos-provided.html#cb198-28" aria-hidden="true" tabindex="-1"></a>rTimeModel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(timeModelCode, <span class="at">constants =</span> <span class="fu">list</span>(<span class="at">t =</span> t), </span>
<span id="cb198-29"><a href="cha-algos-provided.html#cb198-29" aria-hidden="true" tabindex="-1"></a>                          data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">y =</span> y), <span class="at">check =</span> <span class="cn">FALSE</span> )</span>
<span id="cb198-30"><a href="cha-algos-provided.html#cb198-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-31"><a href="cha-algos-provided.html#cb198-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Set parameter values and compile the model</span></span>
<span id="cb198-32"><a href="cha-algos-provided.html#cb198-32" aria-hidden="true" tabindex="-1"></a>rTimeModel<span class="sc">$</span>a <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb198-33"><a href="cha-algos-provided.html#cb198-33" aria-hidden="true" tabindex="-1"></a>rTimeModel<span class="sc">$</span>b <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb198-34"><a href="cha-algos-provided.html#cb198-34" aria-hidden="true" tabindex="-1"></a>rTimeModel<span class="sc">$</span>c <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb198-35"><a href="cha-algos-provided.html#cb198-35" aria-hidden="true" tabindex="-1"></a>rTimeModel<span class="sc">$</span>mu_0 <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb198-36"><a href="cha-algos-provided.html#cb198-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb198-37"><a href="cha-algos-provided.html#cb198-37" aria-hidden="true" tabindex="-1"></a>cTimeModel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(rTimeModel)</span></code></pre></div>
<div id="bootstrap-filter" class="section level4 hasAnchor" number="8.1.1.1">
<h4><span class="header-section-number">8.1.1.1</span> Bootstrap filter<a href="cha-algos-provided.html#bootstrap-filter" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Here is an example of building and running the bootstrap filter.</p>
<div class="sourceCode" id="cb199"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb199-1"><a href="cha-algos-provided.html#cb199-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build bootstrap filter</span></span>
<span id="cb199-2"><a href="cha-algos-provided.html#cb199-2" aria-hidden="true" tabindex="-1"></a>rBootF <span class="ot">&lt;-</span> <span class="fu">buildBootstrapFilter</span>(rTimeModel, <span class="st">&quot;x&quot;</span>, </span>
<span id="cb199-3"><a href="cha-algos-provided.html#cb199-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">control =</span> <span class="fu">list</span>(<span class="at">thresh =</span> <span class="fl">0.8</span>, <span class="at">saveAll =</span> <span class="cn">TRUE</span>, </span>
<span id="cb199-4"><a href="cha-algos-provided.html#cb199-4" aria-hidden="true" tabindex="-1"></a>                                              <span class="at">smoothing =</span> <span class="cn">FALSE</span>))</span>
<span id="cb199-5"><a href="cha-algos-provided.html#cb199-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile filter   </span></span>
<span id="cb199-6"><a href="cha-algos-provided.html#cb199-6" aria-hidden="true" tabindex="-1"></a>cBootF <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(rBootF,<span class="at">project =</span> rTimeModel)</span>
<span id="cb199-7"><a href="cha-algos-provided.html#cb199-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Set number of particles</span></span>
<span id="cb199-8"><a href="cha-algos-provided.html#cb199-8" aria-hidden="true" tabindex="-1"></a>parNum <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb199-9"><a href="cha-algos-provided.html#cb199-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Run bootstrap filter, which returns estimate of model log-likelihood</span></span>
<span id="cb199-10"><a href="cha-algos-provided.html#cb199-10" aria-hidden="true" tabindex="-1"></a>bootLLEst <span class="ot">&lt;-</span> cBootF<span class="sc">$</span><span class="fu">run</span>(parNum)</span>
<span id="cb199-11"><a href="cha-algos-provided.html#cb199-11" aria-hidden="true" tabindex="-1"></a><span class="co"># The bootstrap filter can also return an estimate of the effective </span></span>
<span id="cb199-12"><a href="cha-algos-provided.html#cb199-12" aria-hidden="true" tabindex="-1"></a><span class="co"># sample size (ESS) at each time point</span></span>
<span id="cb199-13"><a href="cha-algos-provided.html#cb199-13" aria-hidden="true" tabindex="-1"></a>bootESS <span class="ot">&lt;-</span> cBootF<span class="sc">$</span><span class="fu">returnESS</span>()</span></code></pre></div>
</div>
<div id="auxiliary-particle-filter" class="section level4 hasAnchor" number="8.1.1.2">
<h4><span class="header-section-number">8.1.1.2</span> Auxiliary particle filter<a href="cha-algos-provided.html#auxiliary-particle-filter" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Next, we provide an example of building and running the auxiliary particle filter. Note that a filter cannot be built on a model that already has a filter specialized to it, so we create a new copy of our state space model first.</p>
<div class="sourceCode" id="cb200"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb200-1"><a href="cha-algos-provided.html#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy our state-space model for use with the auxiliary filter</span></span>
<span id="cb200-2"><a href="cha-algos-provided.html#cb200-2" aria-hidden="true" tabindex="-1"></a>auxTimeModel <span class="ot">&lt;-</span> rTimeModel<span class="sc">$</span><span class="fu">newModel</span>(<span class="at">replicate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb200-3"><a href="cha-algos-provided.html#cb200-3" aria-hidden="true" tabindex="-1"></a><span class="fu">compileNimble</span>(auxTimeModel)</span>
<span id="cb200-4"><a href="cha-algos-provided.html#cb200-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build auxiliary filter</span></span>
<span id="cb200-5"><a href="cha-algos-provided.html#cb200-5" aria-hidden="true" tabindex="-1"></a>rAuxF <span class="ot">&lt;-</span> <span class="fu">buildAuxiliaryFilter</span>(auxTimeModel, <span class="st">&quot;x&quot;</span>, </span>
<span id="cb200-6"><a href="cha-algos-provided.html#cb200-6" aria-hidden="true" tabindex="-1"></a>                              <span class="at">control =</span> <span class="fu">list</span>(<span class="at">thresh =</span> <span class="fl">0.5</span>, <span class="at">saveAll =</span> <span class="cn">TRUE</span>))</span>
<span id="cb200-7"><a href="cha-algos-provided.html#cb200-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile filter   </span></span>
<span id="cb200-8"><a href="cha-algos-provided.html#cb200-8" aria-hidden="true" tabindex="-1"></a>cAuxF <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(rAuxF,<span class="at">project =</span> auxTimeModel)</span>
<span id="cb200-9"><a href="cha-algos-provided.html#cb200-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Run auxiliary filter, which returns estimate of model log-likelihood</span></span>
<span id="cb200-10"><a href="cha-algos-provided.html#cb200-10" aria-hidden="true" tabindex="-1"></a>auxLLEst <span class="ot">&lt;-</span> cAuxF<span class="sc">$</span><span class="fu">run</span>(parNum)</span>
<span id="cb200-11"><a href="cha-algos-provided.html#cb200-11" aria-hidden="true" tabindex="-1"></a><span class="co"># The auxiliary filter can also return an estimate of the effective </span></span>
<span id="cb200-12"><a href="cha-algos-provided.html#cb200-12" aria-hidden="true" tabindex="-1"></a><span class="co"># sample size (ESS) at each time point</span></span>
<span id="cb200-13"><a href="cha-algos-provided.html#cb200-13" aria-hidden="true" tabindex="-1"></a>auxESS <span class="ot">&lt;-</span> cAuxF<span class="sc">$</span><span class="fu">returnESS</span>()</span></code></pre></div>
</div>
<div id="liu-and-west-filter" class="section level4 hasAnchor" number="8.1.1.3">
<h4><span class="header-section-number">8.1.1.3</span> Liu and West filter<a href="cha-algos-provided.html#liu-and-west-filter" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Now we give an example of building and running the Liu and West filter, which can sample from the posterior distribution of top-level parameters as well as latent states. Note that the Liu-West filter ofen performs poorly and is provided primarily for didactic purposes. The Liu and West filter accepts an additional <code>params</code> argument, specifying the top-level parameters to be sampled.</p>
<div class="sourceCode" id="cb201"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb201-1"><a href="cha-algos-provided.html#cb201-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy model</span></span>
<span id="cb201-2"><a href="cha-algos-provided.html#cb201-2" aria-hidden="true" tabindex="-1"></a>LWTimeModel <span class="ot">&lt;-</span> rTimeModel<span class="sc">$</span><span class="fu">newModel</span>(<span class="at">replicate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb201-3"><a href="cha-algos-provided.html#cb201-3" aria-hidden="true" tabindex="-1"></a><span class="fu">compileNimble</span>(LWTimeModel)</span>
<span id="cb201-4"><a href="cha-algos-provided.html#cb201-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build Liu-West filter, also </span></span>
<span id="cb201-5"><a href="cha-algos-provided.html#cb201-5" aria-hidden="true" tabindex="-1"></a><span class="co"># specifying which top level parameters to estimate</span></span>
<span id="cb201-6"><a href="cha-algos-provided.html#cb201-6" aria-hidden="true" tabindex="-1"></a>rLWF <span class="ot">&lt;-</span> <span class="fu">buildLiuWestFilter</span>(LWTimeModel, <span class="st">&quot;x&quot;</span>, <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>),</span>
<span id="cb201-7"><a href="cha-algos-provided.html#cb201-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">control =</span> <span class="fu">list</span>(<span class="at">saveAll =</span> <span class="cn">FALSE</span>))     </span></code></pre></div>
<pre><code>## Warning in buildLiuWestFilter(LWTimeModel, &quot;x&quot;, params = c(&quot;a&quot;, &quot;b&quot;, &quot;c&quot;), :
## The Liu-West filter ofen performs poorly and is provided primarily for didactic
## purposes.</code></pre>
<div class="sourceCode" id="cb203"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb203-1"><a href="cha-algos-provided.html#cb203-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compile filter   </span></span>
<span id="cb203-2"><a href="cha-algos-provided.html#cb203-2" aria-hidden="true" tabindex="-1"></a>cLWF <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(rLWF,<span class="at">project =</span> LWTimeModel)</span>
<span id="cb203-3"><a href="cha-algos-provided.html#cb203-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Run Liu-West filter</span></span>
<span id="cb203-4"><a href="cha-algos-provided.html#cb203-4" aria-hidden="true" tabindex="-1"></a>cLWF<span class="sc">$</span><span class="fu">run</span>(parNum)</span></code></pre></div>
</div>
<div id="ensemble-kalman-filter" class="section level4 hasAnchor" number="8.1.1.4">
<h4><span class="header-section-number">8.1.1.4</span> Ensemble Kalman filter<a href="cha-algos-provided.html#ensemble-kalman-filter" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Next we give an example of building and running the ensemble Kalman filter, which can sample from the posterior distribution of latent states.</p>
<div class="sourceCode" id="cb204"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb204-1"><a href="cha-algos-provided.html#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Copy model</span></span>
<span id="cb204-2"><a href="cha-algos-provided.html#cb204-2" aria-hidden="true" tabindex="-1"></a>ENKFTimeModel <span class="ot">&lt;-</span> rTimeModel<span class="sc">$</span><span class="fu">newModel</span>(<span class="at">replicate =</span> <span class="cn">TRUE</span>)</span>
<span id="cb204-3"><a href="cha-algos-provided.html#cb204-3" aria-hidden="true" tabindex="-1"></a><span class="fu">compileNimble</span>(ENKFTimeModel)</span>
<span id="cb204-4"><a href="cha-algos-provided.html#cb204-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build and compile ensemble Kalman filter</span></span>
<span id="cb204-5"><a href="cha-algos-provided.html#cb204-5" aria-hidden="true" tabindex="-1"></a>rENKF <span class="ot">&lt;-</span> <span class="fu">buildEnsembleKF</span>(ENKFTimeModel, <span class="st">&quot;x&quot;</span>,</span>
<span id="cb204-6"><a href="cha-algos-provided.html#cb204-6" aria-hidden="true" tabindex="-1"></a>                         <span class="at">control =</span> <span class="fu">list</span>(<span class="at">saveAll =</span> <span class="cn">FALSE</span>))  </span>
<span id="cb204-7"><a href="cha-algos-provided.html#cb204-7" aria-hidden="true" tabindex="-1"></a>cENKF <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(rENKF,<span class="at">project =</span> ENKFTimeModel)</span>
<span id="cb204-8"><a href="cha-algos-provided.html#cb204-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Run ensemble Kalman filter</span></span>
<span id="cb204-9"><a href="cha-algos-provided.html#cb204-9" aria-hidden="true" tabindex="-1"></a>cENKF<span class="sc">$</span><span class="fu">run</span>(parNum)</span></code></pre></div>
<p>Once each filter has been run, we can extract samples from the posterior distribution of our latent states as follows:</p>
<div class="sourceCode" id="cb205"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb205-1"><a href="cha-algos-provided.html#cb205-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Equally-weighted samples (available from all filters)</span></span>
<span id="cb205-2"><a href="cha-algos-provided.html#cb205-2" aria-hidden="true" tabindex="-1"></a>bootEWSamp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cBootF<span class="sc">$</span>mvEWSamples) <span class="co"># alternative: as.list</span></span>
<span id="cb205-3"><a href="cha-algos-provided.html#cb205-3" aria-hidden="true" tabindex="-1"></a>auxEWSamp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cAuxF<span class="sc">$</span>mvEWSamples)</span>
<span id="cb205-4"><a href="cha-algos-provided.html#cb205-4" aria-hidden="true" tabindex="-1"></a>LWFEWSamp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cLWF<span class="sc">$</span>mvEWSamples)</span>
<span id="cb205-5"><a href="cha-algos-provided.html#cb205-5" aria-hidden="true" tabindex="-1"></a>ENKFEWSamp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cENKF<span class="sc">$</span>mvEWSamples)</span>
<span id="cb205-6"><a href="cha-algos-provided.html#cb205-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-7"><a href="cha-algos-provided.html#cb205-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Unequally-weighted samples, along with weights (available </span></span>
<span id="cb205-8"><a href="cha-algos-provided.html#cb205-8" aria-hidden="true" tabindex="-1"></a><span class="co"># from bootstrap, auxiliary, and Liu and West filters)</span></span>
<span id="cb205-9"><a href="cha-algos-provided.html#cb205-9" aria-hidden="true" tabindex="-1"></a>bootWSamp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cBootF<span class="sc">$</span>mvWSamples, <span class="st">&quot;x&quot;</span>)</span>
<span id="cb205-10"><a href="cha-algos-provided.html#cb205-10" aria-hidden="true" tabindex="-1"></a>bootWts <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cBootF<span class="sc">$</span>mvWSamples, <span class="st">&quot;wts&quot;</span>)</span>
<span id="cb205-11"><a href="cha-algos-provided.html#cb205-11" aria-hidden="true" tabindex="-1"></a>auxWSamp <span class="ot">&lt;-</span>  <span class="fu">as.matrix</span>(xAuxF<span class="sc">$</span>mvWSamples, <span class="st">&quot;x&quot;</span>)</span>
<span id="cb205-12"><a href="cha-algos-provided.html#cb205-12" aria-hidden="true" tabindex="-1"></a>auxWts <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cAuxF<span class="sc">$</span>mvWSamples, <span class="st">&quot;wts&quot;</span>)</span>
<span id="cb205-13"><a href="cha-algos-provided.html#cb205-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb205-14"><a href="cha-algos-provided.html#cb205-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Liu and West filter also returns samples </span></span>
<span id="cb205-15"><a href="cha-algos-provided.html#cb205-15" aria-hidden="true" tabindex="-1"></a><span class="co"># from posterior distribution of top-level parameters:</span></span>
<span id="cb205-16"><a href="cha-algos-provided.html#cb205-16" aria-hidden="true" tabindex="-1"></a>aEWSamp <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(cLWF<span class="sc">$</span>mvEWSamples, <span class="st">&quot;a&quot;</span>)</span></code></pre></div>
</div>
<div id="iterated-filtering-2-if2" class="section level4 hasAnchor" number="8.1.1.5">
<h4><span class="header-section-number">8.1.1.5</span> Iterated filtering 2 (IF2)<a href="cha-algos-provided.html#iterated-filtering-2-if2" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>The IF2 method accomplishes maximum likelihood estimation using a scheme wherein both latent states and parameters are represented by particles that are weighted and resampled during the iterations. Iterations include perturbations to the parameter particles following a schedule of decreasing magnitude to yield convergence to the MLE.</p>
<p>Here we apply IF2 to Nile River flow data, specifying a changepoint in the year the Aswan Dam was constructed, as the dam altered river flows.</p>
<div class="sourceCode" id="cb206"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb206-1"><a href="cha-algos-provided.html#cb206-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(FKF)</span>
<span id="cb206-2"><a href="cha-algos-provided.html#cb206-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-3"><a href="cha-algos-provided.html#cb206-3" aria-hidden="true" tabindex="-1"></a>flowCode <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb206-4"><a href="cha-algos-provided.html#cb206-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>n)</span>
<span id="cb206-5"><a href="cha-algos-provided.html#cb206-5" aria-hidden="true" tabindex="-1"></a>        y[t] <span class="sc">~</span> <span class="fu">dnorm</span>(x[t], <span class="at">sd =</span> sigmaMeasurements)</span>
<span id="cb206-6"><a href="cha-algos-provided.html#cb206-6" aria-hidden="true" tabindex="-1"></a>    x[<span class="dv">1</span>] <span class="sc">~</span> <span class="fu">dnorm</span>(x0, <span class="at">sd =</span> sigmaInnovations)    </span>
<span id="cb206-7"><a href="cha-algos-provided.html#cb206-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(t <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span>n)</span>
<span id="cb206-8"><a href="cha-algos-provided.html#cb206-8" aria-hidden="true" tabindex="-1"></a>        x[t] <span class="sc">~</span> <span class="fu">dnorm</span>((t<span class="dv">-1</span><span class="sc">==</span><span class="dv">28</span>)<span class="sc">*</span>meanShift1899 <span class="sc">+</span> x[t<span class="dv">-1</span>], <span class="at">sd =</span> sigmaInnovations)</span>
<span id="cb206-9"><a href="cha-algos-provided.html#cb206-9" aria-hidden="true" tabindex="-1"></a>    logSigmaInnovations <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">100</span>)</span>
<span id="cb206-10"><a href="cha-algos-provided.html#cb206-10" aria-hidden="true" tabindex="-1"></a>    logSigmaMeasurements <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">100</span>)</span>
<span id="cb206-11"><a href="cha-algos-provided.html#cb206-11" aria-hidden="true" tabindex="-1"></a>    sigmaInnovations <span class="ot">&lt;-</span> <span class="fu">exp</span>(logSigmaInnovations)</span>
<span id="cb206-12"><a href="cha-algos-provided.html#cb206-12" aria-hidden="true" tabindex="-1"></a>    sigmaMeasurements <span class="ot">&lt;-</span> <span class="fu">exp</span>(logSigmaMeasurements)</span>
<span id="cb206-13"><a href="cha-algos-provided.html#cb206-13" aria-hidden="true" tabindex="-1"></a>    x0 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">1120</span>, <span class="at">var =</span> <span class="dv">100</span>)</span>
<span id="cb206-14"><a href="cha-algos-provided.html#cb206-14" aria-hidden="true" tabindex="-1"></a>    meanShift1899 <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> <span class="dv">100</span>)</span>
<span id="cb206-15"><a href="cha-algos-provided.html#cb206-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb206-16"><a href="cha-algos-provided.html#cb206-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb206-17"><a href="cha-algos-provided.html#cb206-17" aria-hidden="true" tabindex="-1"></a>flowModel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(flowCode, <span class="at">data =</span> <span class="fu">list</span>(<span class="at">y =</span> Nile),</span>
<span id="cb206-18"><a href="cha-algos-provided.html#cb206-18" aria-hidden="true" tabindex="-1"></a>                 <span class="at">constants =</span> <span class="fu">list</span>(<span class="at">n =</span> <span class="fu">length</span>(Nile)),</span>
<span id="cb206-19"><a href="cha-algos-provided.html#cb206-19" aria-hidden="true" tabindex="-1"></a>                 <span class="at">inits =</span> <span class="fu">list</span>(<span class="at">logSigmaInnovations =</span> <span class="fu">log</span>(<span class="fu">sd</span>(Nile)),</span>
<span id="cb206-20"><a href="cha-algos-provided.html#cb206-20" aria-hidden="true" tabindex="-1"></a>                              <span class="at">logSigmaMeasurements =</span> <span class="fu">log</span>(<span class="fu">sd</span>(Nile)),</span>
<span id="cb206-21"><a href="cha-algos-provided.html#cb206-21" aria-hidden="true" tabindex="-1"></a>                              <span class="at">meanShift1899 =</span> <span class="sc">-</span><span class="dv">100</span>))</span></code></pre></div>
<p>Note that the prior distributions for the parameters are not used by IF2, except possibly to obtain boundaries of valid parameter values (not the case here).</p>
<p>Now we build the filter, specifying user-controlled standard deviations (in this case the same as the perturbation <code>sigma</code> values) for use in generating the initial particles for the parameters via the <code>control</code> list.</p>
<div class="sourceCode" id="cb207"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb207-1"><a href="cha-algos-provided.html#cb207-1" aria-hidden="true" tabindex="-1"></a>filter <span class="ot">&lt;-</span> <span class="fu">buildIteratedFilter2</span>(<span class="at">model =</span> flowModel,</span>
<span id="cb207-2"><a href="cha-algos-provided.html#cb207-2" aria-hidden="true" tabindex="-1"></a>                           <span class="at">nodes =</span> <span class="st">&#39;x&#39;</span>,</span>
<span id="cb207-3"><a href="cha-algos-provided.html#cb207-3" aria-hidden="true" tabindex="-1"></a>                           <span class="at">params =</span> <span class="fu">c</span>(<span class="st">&#39;logSigmaInnovations&#39;</span>,</span>
<span id="cb207-4"><a href="cha-algos-provided.html#cb207-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">&#39;logSigmaMeasurements&#39;</span>,</span>
<span id="cb207-5"><a href="cha-algos-provided.html#cb207-5" aria-hidden="true" tabindex="-1"></a>                                      <span class="st">&#39;meanShift1899&#39;</span>),</span>
<span id="cb207-6"><a href="cha-algos-provided.html#cb207-6" aria-hidden="true" tabindex="-1"></a>                           <span class="at">baselineNode =</span> <span class="st">&#39;x0&#39;</span>,</span>
<span id="cb207-7"><a href="cha-algos-provided.html#cb207-7" aria-hidden="true" tabindex="-1"></a>                           <span class="at">control =</span> <span class="fu">list</span>(<span class="at">sigma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">5</span>),</span>
<span id="cb207-8"><a href="cha-algos-provided.html#cb207-8" aria-hidden="true" tabindex="-1"></a>                                          <span class="at">initParamSigma =</span> <span class="fu">c</span>(<span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="dv">5</span>)))</span>
<span id="cb207-9"><a href="cha-algos-provided.html#cb207-9" aria-hidden="true" tabindex="-1"></a>cFlowModel <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(flowModel)</span>
<span id="cb207-10"><a href="cha-algos-provided.html#cb207-10" aria-hidden="true" tabindex="-1"></a>cFilter  <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(filter, <span class="at">project =</span> flowModel)</span></code></pre></div>
<p>We now run the algorithm with 1000 particles for 100 iterations with the schedule parameter equal to 0.2.</p>
<p>In addition to the estimates, we can extract the values of the log-likelihood, the estimates and the standard deviation of the parameter particles as they evolve over the iterations, in order to assess convergence.</p>
<div class="sourceCode" id="cb208"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb208-1"><a href="cha-algos-provided.html#cb208-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb208-2"><a href="cha-algos-provided.html#cb208-2" aria-hidden="true" tabindex="-1"></a>est <span class="ot">&lt;-</span> cFilter<span class="sc">$</span><span class="fu">run</span>(<span class="at">m =</span> <span class="dv">1000</span>, <span class="at">niter =</span> <span class="dv">100</span>, <span class="at">alpha =</span> <span class="fl">0.2</span>)</span>
<span id="cb208-3"><a href="cha-algos-provided.html#cb208-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb208-4"><a href="cha-algos-provided.html#cb208-4" aria-hidden="true" tabindex="-1"></a>cFilter<span class="sc">$</span>estimates[<span class="dv">95</span><span class="sc">:</span><span class="dv">100</span>,] <span class="do">## Last 5 iterations of parameter values</span></span></code></pre></div>
<pre><code>##              [,1]     [,2]      [,3]
## [1,]  0.013306153 4.822613 -269.7837
## [2,] -0.013961938 4.857470 -271.4965
## [3,]  0.002183997 4.850475 -271.1919
## [4,]  0.015598044 4.851961 -272.3889
## [5,] -0.005571944 4.842719 -272.6390
## [6,]  0.042982317 4.837347 -271.1800</code></pre>
<div class="sourceCode" id="cb210"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb210-1"><a href="cha-algos-provided.html#cb210-1" aria-hidden="true" tabindex="-1"></a>cFilter<span class="sc">$</span>logLik[<span class="dv">90</span><span class="sc">:</span><span class="dv">100</span>] <span class="do">## Last 5 iterations of log likelihood values</span></span></code></pre></div>
<pre><code>##  [1] -627.0497 -626.9570 -626.9856 -626.9954 -626.7448 -626.7521 -626.8472
##  [8] -626.7398 -626.9869 -627.1354 -626.6648</code></pre>
<p>Comparing to use of the the Kalman Filter from the FKF package, we see the log-likelihood is fairly similar:</p>
<div class="sourceCode" id="cb212"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb212-1"><a href="cha-algos-provided.html#cb212-1" aria-hidden="true" tabindex="-1"></a>dtpred <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="at">ncol =</span> <span class="fu">length</span>(Nile))</span>
<span id="cb212-2"><a href="cha-algos-provided.html#cb212-2" aria-hidden="true" tabindex="-1"></a>dtpred[<span class="dv">28</span>] <span class="ot">&lt;-</span> est[<span class="dv">3</span>]</span>
<span id="cb212-3"><a href="cha-algos-provided.html#cb212-3" aria-hidden="true" tabindex="-1"></a>ct <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>)</span>
<span id="cb212-4"><a href="cha-algos-provided.html#cb212-4" aria-hidden="true" tabindex="-1"></a>Zt <span class="ot">&lt;-</span> Tt <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">1</span>)</span>
<span id="cb212-5"><a href="cha-algos-provided.html#cb212-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb212-6"><a href="cha-algos-provided.html#cb212-6" aria-hidden="true" tabindex="-1"></a>fkfResult <span class="ot">&lt;-</span> <span class="fu">fkf</span>(<span class="at">HHt =</span> <span class="fu">matrix</span>(<span class="fu">exp</span>(<span class="dv">2</span><span class="sc">*</span>est[<span class="dv">1</span>])),</span>
<span id="cb212-7"><a href="cha-algos-provided.html#cb212-7" aria-hidden="true" tabindex="-1"></a>                 <span class="at">GGt =</span> <span class="fu">matrix</span>(<span class="fu">exp</span>(<span class="dv">2</span><span class="sc">*</span>est[<span class="dv">2</span>])),</span>
<span id="cb212-8"><a href="cha-algos-provided.html#cb212-8" aria-hidden="true" tabindex="-1"></a>                 <span class="at">yt =</span> <span class="fu">rbind</span>(Nile),</span>
<span id="cb212-9"><a href="cha-algos-provided.html#cb212-9" aria-hidden="true" tabindex="-1"></a>                 <span class="at">a0 =</span> <span class="dv">1120</span>,</span>
<span id="cb212-10"><a href="cha-algos-provided.html#cb212-10" aria-hidden="true" tabindex="-1"></a>                 <span class="at">P0 =</span> <span class="fu">matrix</span>(<span class="dv">100</span>),</span>
<span id="cb212-11"><a href="cha-algos-provided.html#cb212-11" aria-hidden="true" tabindex="-1"></a>                 <span class="at">dt =</span> dtpred, <span class="at">ct =</span> ct, <span class="at">Zt =</span> Zt, <span class="at">Tt =</span> Tt)</span>
<span id="cb212-12"><a href="cha-algos-provided.html#cb212-12" aria-hidden="true" tabindex="-1"></a>fkfResult<span class="sc">$</span>logLik</span></code></pre></div>
<pre><code>## [1] -626.5521</code></pre>
</div>
</div>
<div id="sec:particle-mcmc" class="section level3 hasAnchor" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> Particle MCMC (PMCMC)<a href="cha-algos-provided.html#sec:particle-mcmc" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Particle MCMC (PMCMC) is a method that uses MCMC for top-level model
parameters and uses a particle filter to approximate the time-series
likelihood for use in determining MCMC acceptance probabilities
<span class="citation">(<a href="references.html#ref-Andrieu_Doucet_Holenstein_2010" role="doc-biblioref">Andrieu, Doucet, and Holenstein 2010</a>)</span>. NIMBLE implements PMCMC by
providing random-walk Metropolis-Hastings samplers for model
parameters that make use of particle filters in this way. These
samplers can use NIMBLE’s bootstrap filter or auxiliary particle
filter, or they can use a user-defined filter. Whichever filter is
specified will be used to obtain estimates of the likelihood of the
state-space model (marginalizing over the latent states), which is
used for calculation of the Metropolis-Hastings acceptance
probability. The <code>RW_PF</code> sampler uses a univariate normal
proposal distribution, and can be used to sample scalar top-level
parameters. The <code>RW_PF_block</code> sampler uses a multivariate normal
proposal distribution and can be used to jointly sample vectors of
top-level parameters. The PMCMC samplers can be specified with a call
to <code>addSampler</code> with <code>type = "RW_PF"</code> or <code>type = "RW_PF_block"</code>,
a syntax similar to the other MCMC samplers listed
in Section <a href="cha-mcmc.html#sec:samplers-provided">7.11</a>.</p>
<p>The <code>RW_PF</code> sampler and <code>RW_PF_block</code> sampler can be
customized using the <code>control</code> list argument to set the adaptive
properties of the sampler and options for the particle filter
algorithm to be used. In addition, providing
<code>pfOptimizeNparticles=TRUE</code> in the <code>control</code> list will use an
experimental algorithm to estimate the optimal number of particles to
use in the particle filter. See <code>help(samplers)</code> for details. The
MCMC configuration for the <code>timeModel</code> in the previous section will
serve as an example for the use of our PMCMC sampler. Here we use the
identity matrix as our proposal covariance matrix.</p>
<div class="sourceCode" id="cb214"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb214-1"><a href="cha-algos-provided.html#cb214-1" aria-hidden="true" tabindex="-1"></a>timeConf <span class="ot">&lt;-</span> <span class="fu">configureMCMC</span>(rTimeModel, <span class="at">nodes =</span> <span class="cn">NULL</span>) <span class="co"># empty MCMC configuration</span></span>
<span id="cb214-2"><a href="cha-algos-provided.html#cb214-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb214-3"><a href="cha-algos-provided.html#cb214-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Add random walk PMCMC sampler with particle number optimization.</span></span>
<span id="cb214-4"><a href="cha-algos-provided.html#cb214-4" aria-hidden="true" tabindex="-1"></a>timeConf<span class="sc">$</span><span class="fu">addSampler</span>(<span class="at">target =</span> <span class="fu">c</span>(<span class="st">&quot;a&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;c&quot;</span>, <span class="st">&quot;mu_0&quot;</span>), <span class="at">type =</span> <span class="st">&quot;RW_PF_block&quot;</span>,</span>
<span id="cb214-5"><a href="cha-algos-provided.html#cb214-5" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">propCov=</span> <span class="fu">diag</span>(<span class="dv">4</span>), <span class="at">adaptScaleOnly =</span> <span class="cn">FALSE</span>,</span>
<span id="cb214-6"><a href="cha-algos-provided.html#cb214-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">latents =</span> <span class="st">&quot;x&quot;</span>, <span class="at">pfOptimizeNparticles =</span> <span class="cn">TRUE</span>))</span></code></pre></div>
<p>The <code>type = "RW_PF"</code> and <code>type = "RW_PF*block"</code> samplers
default to using a bootstrap filter. The adapatation control
parameters <code>adaptive</code>, <code>adaptInterval</code>, and
<code>adaptScaleOnly</code> work in the same way as for an <code>RW</code> and <code>RW*block</code> samplers.
However, it is not clear if the same approach to adaptation works well
for PMCMC, so one should consider turning off adaptation and using
a well-chosen proposal covariance.</p>
<p>It is also possible that more efficient results
can be obtained by using a custom filtering algorithm. Choice
of filtering algorithm can be controlled by the <code>pfType</code> control
list entry. The <code>pfType</code> entry can be set either to
<code>'bootstrap'</code> (the default), <code>'auxiliary'</code>, or the name of a
user-defined nimbleFunction that returns a likelihood approximation.</p>
<p>Any user-defined filtering nimbleFunction named in the <code>pfType</code>
control list entry must satsify the following:</p>
<ol style="list-style-type: decimal">
<li><p>The nimbleFunction must be the result of a call to
<code>nimbleFunction()</code>.</p></li>
<li><p>The <code>nimbleFunction</code> must have setup code that accepts the
following (and only the following) arguments:</p>
<ul>
<li><code>model</code>, the NIMBLE model object that the MCMC algorithm is
defined on.</li>
<li><code>latents</code>, a character vector specifying the latent model
nodes over which the particle filter will stochastically integrate
over to estimate the log-likelihood function.</li>
<li><code>control</code>, an <code>R</code> <code>list</code> object. Note that the
<code>control</code> list can be used to pass in any additional information
or arguments that the custom filter may require.</li>
</ul></li>
<li><p>The <code>nimbleFunction</code> must have a <code>run</code> function that
accepts a single integer arugment (the number of particles to use),
and returns a scalar double (the log-likelihood estimate).</p></li>
<li><p>The <code>nimbleFunction</code> must define, in setup code, a
<code>modelValues</code> object named <code>mvEWSamples</code> that is used to
contain equally weighted samples of the latent states (that is, the
<code>latents</code> argument to the setup function). Each time the
<code>run()</code> method of the <code>nimbleFunction</code> is called with number
of particles <code>m</code>, the <code>mvEWSamples</code> <code>modelValues</code> object
should be resized to be of size <code>m</code> via a call to
<code>resize(mvEWSamples, m)</code>.</p></li>
</ol>
</div>
</div>
<div id="monte-carlo-expectation-maximization-mcem" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Monte Carlo Expectation Maximization (MCEM)<a href="cha-algos-provided.html#monte-carlo-expectation-maximization-mcem" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Suppose we have a model with missing data (or a layer of latent
variables that can be treated as missing data), and we would like to
maximize the marginal likelihood of the model, integrating over the
missing data. A brute-force method for doing this is MCEM. This is
an EM algorithm in which the missing data are simulated via Monte
Carlo (often MCMC, when the full conditional distributions cannot be
directly sampled from) at each iteration. MCEM can be slow, and
there are other methods for maximizing marginal likelihoods that can
be implemented in NIMBLE. The reason we started with MCEM is to
explore the flexibility of NIMBLE and illustrate the ability to combine
R and NIMBLE to run an algorithm, with R managing the highest-level processing
of the algorithm and calling nimbleFunctions for computations.</p>
<p>NIMBLE provides an ascent-based MCEM algorithm, created using <code>buildMCEM</code>, that automatically determines when the algorithm has converged by examining
the size of the changes in the likelihood between each iteration. Additionally, the MCEM algorithm can provide an estimate of the asymptotic covariance matrix of the parameters. An example of calculating the asymptotic covariance can be found in Section <a href="cha-algos-provided.html#sec:estimate-mcem-cov">8.2.1</a>.</p>
<p>We will revisit the <em>pump</em> example to illustrate the use of
NIMBLE’s MCEM algorithm.
<!--- % newPump didn't exist so I'm creating it in some non-echoed code. --></p>
<div class="sourceCode" id="cb215"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb215-1"><a href="cha-algos-provided.html#cb215-1" aria-hidden="true" tabindex="-1"></a>pump <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(<span class="at">code =</span> pumpCode, <span class="at">name =</span> <span class="st">&quot;pump&quot;</span>, <span class="at">constants =</span> pumpConsts,</span>
<span id="cb215-2"><a href="cha-algos-provided.html#cb215-2" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> pumpData, <span class="at">inits =</span> pumpInits, <span class="at">check =</span> <span class="cn">FALSE</span>)</span>
<span id="cb215-3"><a href="cha-algos-provided.html#cb215-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-4"><a href="cha-algos-provided.html#cb215-4" aria-hidden="true" tabindex="-1"></a><span class="fu">compileNimble</span>(pump)</span>
<span id="cb215-5"><a href="cha-algos-provided.html#cb215-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb215-6"><a href="cha-algos-provided.html#cb215-6" aria-hidden="true" tabindex="-1"></a><span class="co"># build an MCEM algorithm with ascent-based convergence criterion</span></span>
<span id="cb215-7"><a href="cha-algos-provided.html#cb215-7" aria-hidden="true" tabindex="-1"></a>pumpMCEM <span class="ot">&lt;-</span> <span class="fu">buildMCEM</span>(<span class="at">model =</span> pump,</span>
<span id="cb215-8"><a href="cha-algos-provided.html#cb215-8" aria-hidden="true" tabindex="-1"></a>                      <span class="at">latentNodes =</span> <span class="st">&quot;theta&quot;</span>, <span class="at">burnIn =</span> <span class="dv">300</span>,</span>
<span id="cb215-9"><a href="cha-algos-provided.html#cb215-9" aria-hidden="true" tabindex="-1"></a>                      <span class="at">mcmcControl =</span> <span class="fu">list</span>(<span class="at">adaptInterval =</span> <span class="dv">100</span>),</span>
<span id="cb215-10"><a href="cha-algos-provided.html#cb215-10" aria-hidden="true" tabindex="-1"></a>                      <span class="at">boxConstraints =</span> <span class="fu">list</span>( <span class="fu">list</span>( <span class="fu">c</span>(<span class="st">&quot;alpha&quot;</span>, <span class="st">&quot;beta&quot;</span>), </span>
<span id="cb215-11"><a href="cha-algos-provided.html#cb215-11" aria-hidden="true" tabindex="-1"></a>                                                  <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="cn">Inf</span>) ) ), </span>
<span id="cb215-12"><a href="cha-algos-provided.html#cb215-12" aria-hidden="true" tabindex="-1"></a>                      <span class="at">buffer =</span> <span class="fl">1e-6</span>)</span></code></pre></div>
<p>The first argument <code>buildMCEM</code>, <code>model</code>, is a NIMBLE model, which can be
either the uncompiled or compiled version. At the moment, the model provided cannot be part of another MCMC sampler.</p>
<p>Initial values for the parameters are taken to be the values in the model at the time <code>buildMCEM</code> is called, unless the values in the compiled model are changed before running the MCEM.</p>
<p>The ascent-based MCEM algorithm has a number of control options:</p>
<p>The <code>latentNodes</code> argument should indicate the nodes that will be
integrated over (sampled via MCMC), rather than
maximized. These
nodes must be stochastic, not deterministic! <code>latentNodes</code> will
be expanded as described in Section <a href="cha-using-models.html#sec:arbitr-coll-nodes">13.3.1.1</a>. I.e.,
either <code>latentNodes = "x"</code> or <code>latentNodes = c("x[1]", "x[2]")</code>
will treat <code>x[1]</code> and <code>x[2]</code> as latent nodes if
<code>x</code> is a vector of two values. All other non-data nodes will be
maximized over. Note that <code>latentNodes</code> can include discrete nodes,
but the nodes to be maximized cannot.</p>
<p>The <code>burnIn</code> argument indicates the number of samples from the MCMC for the E-step that should be discarded when computing the expected likelihood in the M-step. Note that <code>burnIn</code> can be set to values lower than in standard MCMC computations, as each iteration will start where the last left off.</p>
<p>The <code>mcmcControl</code> argument will be passed to <code>configureMCMC</code> to define the MCMC to be used.</p>
<p>The MCEM algorithm automatically detects box constraints for the nodes that will
be optimized, using NIMBLE’s <code>getBounds</code> function. It is also possible for a user to manually specify constraints via the <code>boxConstraints</code> argument.
Each constraint given should be a list
in which the first element is the names of the nodes or variables
that the constraint will be applied to and the second element is a
vector of length two, in which the first value is the lower limit and
the second is the upper limit. Values of <code>Inf</code> and <code>-Inf</code> are allowed. If a node is not listed, its constraints will be automatically determined by NIMBLE. These constraint arguments are passed as the <code>lower</code> and <code>upper</code> arguments to R’s <code>optim</code> function, using <code>method = "L-BFGS-B"</code>. Note that NIMBLE will give a warning if a user-provided constraint is more extreme than the constraint determined by NIMBLE.</p>
<p>The value of the <code>buffer</code> argument shrinks the
<code>boxConstraints</code> by this amount. This can help protect against
non-finite values occurring when a parameter is on the boundary.</p>
<p>In addition, the MCEM has some extra control options that can be used to further tune the convergence criterion. See <code>help(buildMCEM)</code> for more information.</p>
<p>The <code>buildMCEM</code> function returns a list with two elements. The first element is a function called <code>run</code>, which will use the MCEM algorithm to estimate the MLEs. The second function is called <code>estimateCov</code>, and is described in Section <a href="cha-algos-provided.html#sec:estimate-mcem-cov">8.2.1</a>. The <code>run</code> function can be run as follows. There is only one run-time argument, <code>initM</code>, which is the number of MCMC iterations to use when the algorithm is initialized.</p>
<div class="sourceCode" id="cb216"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb216-1"><a href="cha-algos-provided.html#cb216-1" aria-hidden="true" tabindex="-1"></a>pumpMLE <span class="ot">&lt;-</span> pumpMCEM<span class="sc">$</span><span class="fu">run</span>(<span class="at">initM =</span> <span class="dv">1000</span>)</span></code></pre></div>
<pre><code>## Iteration Number: 1.
## Current number of MCMC iterations: 1000.
## Parameter Estimates: 
##     alpha      beta 
## 0.8219803 1.1492317 
## Convergence Criterion: 1.001.
## Iteration Number: 2.
## Current number of MCMC iterations: 1000.
## Parameter Estimates: 
##    alpha     beta 
## 0.818586 1.237039 
## Convergence Criterion: 0.02393763.
## Iteration Number: 3.
## Current number of MCMC iterations: 1000.
## Parameter Estimates: 
##     alpha      beta 
## 0.8274042 1.2673636 
## Convergence Criterion: 0.002330748.
## Iteration Number: 4.
## Current number of MCMC iterations: 3845.
## Parameter Estimates: 
##     alpha      beta 
## 0.8270797 1.2730042 
## Convergence Criterion: 0.0002820885.</code></pre>
<div class="sourceCode" id="cb218"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb218-1"><a href="cha-algos-provided.html#cb218-1" aria-hidden="true" tabindex="-1"></a>pumpMLE</span></code></pre></div>
<pre><code>##     alpha      beta 
## 0.8270797 1.2730042</code></pre>
<p>Direct maximization after analytically integrating over the latent nodes (possible for this model but often not feasible) gives estimates of <span class="math inline">\(\hat\alpha=0.823\)</span> and <span class="math inline">\(\hat\beta = 1.261\)</span>, so the MCEM seems to do pretty well, though tightening the convergence criteria may be warranted in actual usage.</p>
<div id="sec:estimate-mcem-cov" class="section level3 hasAnchor" number="8.2.1">
<h3><span class="header-section-number">8.2.1</span> Estimating the asymptotic covariance From MCEM<a href="cha-algos-provided.html#sec:estimate-mcem-cov" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The second element of the list returned by a call to <code>buildMCEM</code> is a function called <code>estimateCov</code>, which estimates the asymptotic covariance of the parameters at their MLE values. If the <code>run</code> function has been called previously, the <code>estimateCov</code> function will automatically use the MLE values produced by the <code>run</code> function to estimate the covariance. Alternatively, a user can supply their own MLE values using the <code>MLEs</code> argument, which allows the covariance to be estimated without having called the <code>run</code> function. More details about the <code>estimateCov</code> function can be found by calling <code>help(buildMCEM)</code>. Below is an example of using the <code>estimateCov</code> function.</p>
<div class="sourceCode" id="cb220"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb220-1"><a href="cha-algos-provided.html#cb220-1" aria-hidden="true" tabindex="-1"></a>pumpCov <span class="ot">&lt;-</span> pumpMCEM<span class="sc">$</span><span class="fu">estimateCov</span>()</span>
<span id="cb220-2"><a href="cha-algos-provided.html#cb220-2" aria-hidden="true" tabindex="-1"></a>pumpCov</span></code></pre></div>
<pre><code>##           alpha      beta
## alpha 0.1283888 0.2180972
## beta  0.2180972 0.6377524</code></pre>
<div class="sourceCode" id="cb222"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb222-1"><a href="cha-algos-provided.html#cb222-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively, you can manually specify the MLE values as a named vector.</span></span>
<span id="cb222-2"><a href="cha-algos-provided.html#cb222-2" aria-hidden="true" tabindex="-1"></a>pumpCov <span class="ot">&lt;-</span> pumpMCEM<span class="sc">$</span><span class="fu">estimateCov</span>(<span class="at">MLEs =</span> <span class="fu">c</span>(<span class="at">alpha =</span> <span class="fl">0.823</span>, <span class="at">beta =</span> <span class="fl">1.261</span>))</span></code></pre></div>

<!--- % See http://yihui.name/knitr/demo/child/ for documentation on the parent/child document system of knitr -->
<!---  
% Rscript -e "library(knitr);  knit2pdf('includesSpatialOnly.Rnw')"; open -a "Google Chrome" includesSpatialOnly.pdf
-->
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="cha-mcmc.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="cha-spatial.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["NimbleUserManual.pdf", "NimbleUserManual.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"toc_depth": 3
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
