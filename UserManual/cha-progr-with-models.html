<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 15 Writing nimbleFunctions to interact with models | NimbleUserManual.knit</title>
  <meta name="description" content="This is the NIMBLE User Manual." />
  <meta name="generator" content="bookdown 0.36 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 15 Writing nimbleFunctions to interact with models | NimbleUserManual.knit" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="/nimble-icon.png" />
  <meta property="og:description" content="This is the NIMBLE User Manual." />
  <meta name="github-repo" content="nimble-dev/nimble" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 15 Writing nimbleFunctions to interact with models | NimbleUserManual.knit" />
  
  <meta name="twitter:description" content="This is the NIMBLE User Manual." />
  <meta name="twitter:image" content="/nimble-icon.png" />




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="cha-data-structures.html"/>
<link rel="next" href="cha-AD.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<img src="./nimble-icon.png"
     width=100>
<li><a href="./cha-welcome-nimble.html">NIMBLE User Manual, Version 1.1.0</a></li>
<li><a href="https://github.com/nimble-dev/nimble">NIMBLE Development Team</a></li>
<li><a href="https://R-nimble.org">https://R-nimble.org</a></li>

<li class="divider"></li>
<li class="part"><span><b>I Introduction</b></span></li>
<li class="chapter" data-level="1" data-path="cha-welcome-nimble.html"><a href="cha-welcome-nimble.html"><i class="fa fa-check"></i><b>1</b> Welcome to NIMBLE</a>
<ul>
<li class="chapter" data-level="1.1" data-path="cha-welcome-nimble.html"><a href="cha-welcome-nimble.html#sec:what-is-nimble"><i class="fa fa-check"></i><b>1.1</b> What does NIMBLE do?</a></li>
<li class="chapter" data-level="1.2" data-path="cha-welcome-nimble.html"><a href="cha-welcome-nimble.html#how-to-use-this-manual"><i class="fa fa-check"></i><b>1.2</b> How to use this manual</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html"><i class="fa fa-check"></i><b>2</b> Lightning introduction</a>
<ul>
<li class="chapter" data-level="2.1" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:brief-example"><i class="fa fa-check"></i><b>2.1</b> A brief example</a></li>
<li class="chapter" data-level="2.2" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:creating-model"><i class="fa fa-check"></i><b>2.2</b> Creating a model</a></li>
<li class="chapter" data-level="2.3" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:compiling-model"><i class="fa fa-check"></i><b>2.3</b> Compiling the model</a></li>
<li class="chapter" data-level="2.4" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:intro-runMCMC"><i class="fa fa-check"></i><b>2.4</b> One-line invocation of MCMC</a></li>
<li class="chapter" data-level="2.5" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:creating-mcmc"><i class="fa fa-check"></i><b>2.5</b> Creating, compiling and running a basic MCMC configuration</a></li>
<li class="chapter" data-level="2.6" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:customizing-mcmc"><i class="fa fa-check"></i><b>2.6</b> Customizing the MCMC</a></li>
<li class="chapter" data-level="2.7" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:running-mcem"><i class="fa fa-check"></i><b>2.7</b> Running MCEM</a></li>
<li class="chapter" data-level="2.8" data-path="cha-lightning-intro.html"><a href="cha-lightning-intro.html#sec:creating-your-own"><i class="fa fa-check"></i><b>2.8</b> Creating your own functions</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html"><i class="fa fa-check"></i><b>3</b> More introduction</a>
<ul>
<li class="chapter" data-level="3.1" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html#nimble-adopts-and-extends-the-bugs-language-for-specifying-models"><i class="fa fa-check"></i><b>3.1</b> NIMBLE adopts and extends the BUGS language for specifying models</a></li>
<li class="chapter" data-level="3.2" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html#sec:nimble-lang-writ"><i class="fa fa-check"></i><b>3.2</b> nimbleFunctions for writing algorithms</a></li>
<li class="chapter" data-level="3.3" data-path="cha-more-introduction.html"><a href="cha-more-introduction.html#sec:nimble-algor-libr"><i class="fa fa-check"></i><b>3.3</b> The NIMBLE algorithm library</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html"><i class="fa fa-check"></i><b>4</b> Installing NIMBLE</a>
<ul>
<li class="chapter" data-level="4.1" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#sec:requ-run-nimble"><i class="fa fa-check"></i><b>4.1</b> Requirements to run NIMBLE</a></li>
<li class="chapter" data-level="4.2" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#sec:compiler"><i class="fa fa-check"></i><b>4.2</b> Installing a C++ compiler for NIMBLE to use</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#macos"><i class="fa fa-check"></i><b>4.2.1</b> MacOS</a></li>
<li class="chapter" data-level="4.2.2" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#linux"><i class="fa fa-check"></i><b>4.2.2</b> Linux</a></li>
<li class="chapter" data-level="4.2.3" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#windows"><i class="fa fa-check"></i><b>4.2.3</b> Windows</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#installing-the-nimble-package"><i class="fa fa-check"></i><b>4.3</b> Installing the NIMBLE package</a></li>
<li class="chapter" data-level="4.4" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#troubleshooting-installation-problems"><i class="fa fa-check"></i><b>4.4</b> Troubleshooting installation problems</a></li>
<li class="chapter" data-level="4.5" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#customizing-your-installation"><i class="fa fa-check"></i><b>4.5</b> Customizing your installation</a>
<ul>
<li class="chapter" data-level="4.5.1" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#using-your-own-copy-of-eigen"><i class="fa fa-check"></i><b>4.5.1</b> Using your own copy of Eigen</a></li>
<li class="chapter" data-level="4.5.2" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#using-libnimble"><i class="fa fa-check"></i><b>4.5.2</b> Using libnimble</a></li>
<li class="chapter" data-level="4.5.3" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#sec:blas"><i class="fa fa-check"></i><b>4.5.3</b> BLAS and LAPACK</a></li>
<li class="chapter" data-level="4.5.4" data-path="cha-installing-nimble.html"><a href="cha-installing-nimble.html#customizing-compilation-of-the-nimble-generated-c"><i class="fa fa-check"></i><b>4.5.4</b> Customizing compilation of the NIMBLE-generated C++</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Models in NIMBLE</b></span></li>
<li class="chapter" data-level="5" data-path="cha-writing-models.html"><a href="cha-writing-models.html"><i class="fa fa-check"></i><b>5</b> Writing models in NIMBLE’s dialect of BUGS</a>
<ul>
<li class="chapter" data-level="5.1" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:supp-feat-bugs"><i class="fa fa-check"></i><b>5.1</b> Comparison to BUGS dialects supported by WinBUGS, OpenBUGS and JAGS</a>
<ul>
<li class="chapter" data-level="5.1.1" data-path="cha-writing-models.html"><a href="cha-writing-models.html#supported-features-of-bugs-and-jags"><i class="fa fa-check"></i><b>5.1.1</b> Supported features of BUGS and JAGS</a></li>
<li class="chapter" data-level="5.1.2" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:extensions-bugs"><i class="fa fa-check"></i><b>5.1.2</b> NIMBLE’s Extensions to BUGS and JAGS</a></li>
<li class="chapter" data-level="5.1.3" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:not-yet-supported"><i class="fa fa-check"></i><b>5.1.3</b> Not-supported features of BUGS and JAGS</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="cha-writing-models.html"><a href="cha-writing-models.html#writing-models"><i class="fa fa-check"></i><b>5.2</b> Writing models</a>
<ul>
<li class="chapter" data-level="5.2.1" data-path="cha-writing-models.html"><a href="cha-writing-models.html#declaring-stochastic-and-deterministic-nodes"><i class="fa fa-check"></i><b>5.2.1</b> Declaring stochastic and deterministic nodes</a></li>
<li class="chapter" data-level="5.2.2" data-path="cha-writing-models.html"><a href="cha-writing-models.html#sec:more-kinds-bugs"><i class="fa fa-check"></i><b>5.2.2</b> More kinds of BUGS declarations</a></li>
<li class="chapter" data-level="5.2.3" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:vectorized-versus-scalar-declarations"><i class="fa fa-check"></i><b>5.2.3</b> Vectorized versus scalar declarations</a></li>
<li class="chapter" data-level="5.2.4" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:dists-and-functions"><i class="fa fa-check"></i><b>5.2.4</b> Available distributions</a></li>
<li class="chapter" data-level="5.2.5" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:BUGS-lang-fxns"><i class="fa fa-check"></i><b>5.2.5</b> Available BUGS language functions</a></li>
<li class="chapter" data-level="5.2.6" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:BUGS-link"><i class="fa fa-check"></i><b>5.2.6</b> Available link functions</a></li>
<li class="chapter" data-level="5.2.7" data-path="cha-writing-models.html"><a href="cha-writing-models.html#subsec:trunc"><i class="fa fa-check"></i><b>5.2.7</b> Truncation, censoring, and constraints</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="cha-building-models.html"><a href="cha-building-models.html"><i class="fa fa-check"></i><b>6</b> Building and using models</a>
<ul>
<li class="chapter" data-level="6.1" data-path="cha-building-models.html"><a href="cha-building-models.html#creating-model-objects"><i class="fa fa-check"></i><b>6.1</b> Creating model objects</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="cha-building-models.html"><a href="cha-building-models.html#using-nimblemodel-to-create-a-model"><i class="fa fa-check"></i><b>6.1.1</b> Using <em>nimbleModel</em> to create a model</a></li>
<li class="chapter" data-level="6.1.2" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:readBUGSmodel"><i class="fa fa-check"></i><b>6.1.2</b> Creating a model from standard BUGS and JAGS input files</a></li>
<li class="chapter" data-level="6.1.3" data-path="cha-building-models.html"><a href="cha-building-models.html#sub:multiple-instances"><i class="fa fa-check"></i><b>6.1.3</b> Making multiple instances from the same model definition</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:nodes-and-variables"><i class="fa fa-check"></i><b>6.2</b> NIMBLE models are objects you can query and manipulate</a>
<ul>
<li class="chapter" data-level="6.2.1" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:what-are-nodes-and-variables"><i class="fa fa-check"></i><b>6.2.1</b> What are variables and nodes?</a></li>
<li class="chapter" data-level="6.2.2" data-path="cha-building-models.html"><a href="cha-building-models.html#determining-the-nodes-and-variables-in-a-model"><i class="fa fa-check"></i><b>6.2.2</b> Determining the nodes and variables in a model</a></li>
<li class="chapter" data-level="6.2.3" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:accessing-nodes"><i class="fa fa-check"></i><b>6.2.3</b> Accessing nodes</a></li>
<li class="chapter" data-level="6.2.4" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:how-nodes-are"><i class="fa fa-check"></i><b>6.2.4</b> How nodes are named</a></li>
<li class="chapter" data-level="6.2.5" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:why-use-node"><i class="fa fa-check"></i><b>6.2.5</b> Why use node names?</a></li>
<li class="chapter" data-level="6.2.6" data-path="cha-building-models.html"><a href="cha-building-models.html#sec:cdisdata"><i class="fa fa-check"></i><b>6.2.6</b> Checking if a node holds data</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="cha-building-models.html"><a href="cha-building-models.html#using-models-in-parallel"><i class="fa fa-check"></i><b>6.3</b> Using models in parallel</a></li>
</ul></li>
<li class="part"><span><b>III Algorithms in NIMBLE</b></span></li>
<li class="chapter" data-level="7" data-path="cha-mcmc.html"><a href="cha-mcmc.html"><i class="fa fa-check"></i><b>7</b> MCMC</a>
<ul>
<li class="chapter" data-level="7.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:nimbleMCMC"><i class="fa fa-check"></i><b>7.1</b> One-line invocation of MCMC: <em>nimbleMCMC</em></a></li>
<li class="chapter" data-level="7.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:mcmc-configuration"><i class="fa fa-check"></i><b>7.2</b> The MCMC configuration</a>
<ul>
<li class="chapter" data-level="7.2.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:default-mcmc-conf"><i class="fa fa-check"></i><b>7.2.1</b> Default MCMC configuration</a></li>
<li class="chapter" data-level="7.2.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:customizing-mcmc-conf"><i class="fa fa-check"></i><b>7.2.2</b> Customizing the MCMC configuration</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:build-compile-mcmc"><i class="fa fa-check"></i><b>7.3</b> Building and compiling the MCMC</a></li>
<li class="chapter" data-level="7.4" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:initMCMC"><i class="fa fa-check"></i><b>7.4</b> Initializing MCMC</a></li>
<li class="chapter" data-level="7.5" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:runMCMC"><i class="fa fa-check"></i><b>7.5</b> User-friendly execution of MCMC algorithms: <em>runMCMC</em></a></li>
<li class="chapter" data-level="7.6" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:executing-the-mcmc-algorithm"><i class="fa fa-check"></i><b>7.6</b> Running the MCMC</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:mcmc-rerun"><i class="fa fa-check"></i><b>7.6.1</b> Rerunning versus restarting an MCMC</a></li>
<li class="chapter" data-level="7.6.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:sampler-time"><i class="fa fa-check"></i><b>7.6.2</b> Measuring sampler computation times: <em>getTimes</em></a></li>
<li class="chapter" data-level="7.6.3" data-path="cha-mcmc.html"><a href="cha-mcmc.html#assessing-the-adaption-process-of-rw-and-rw_block-samplers"><i class="fa fa-check"></i><b>7.6.3</b> Assessing the adaption process of <em>RW</em> and <em>RW_block</em> samplers</a></li>
</ul></li>
<li class="chapter" data-level="7.7" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:extracting-samples"><i class="fa fa-check"></i><b>7.7</b> Extracting MCMC samples</a></li>
<li class="chapter" data-level="7.8" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:WAIC"><i class="fa fa-check"></i><b>7.8</b> Calculating WAIC</a></li>
<li class="chapter" data-level="7.9" data-path="cha-mcmc.html"><a href="cha-mcmc.html#k-fold-cross-validation"><i class="fa fa-check"></i><b>7.9</b> k-fold cross-validation</a></li>
<li class="chapter" data-level="7.10" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:rjmcmc"><i class="fa fa-check"></i><b>7.10</b> Variable selection using Reversible Jump MCMC</a>
<ul>
<li class="chapter" data-level="7.10.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:rjmcmc-indicator"><i class="fa fa-check"></i><b>7.10.1</b> Using indicator variables</a></li>
<li class="chapter" data-level="7.10.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:rjmcmc-no-indicator"><i class="fa fa-check"></i><b>7.10.2</b> Without indicator variables</a></li>
</ul></li>
<li class="chapter" data-level="7.11" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:samplers-provided"><i class="fa fa-check"></i><b>7.11</b> Samplers provided with NIMBLE</a>
<ul>
<li class="chapter" data-level="7.11.1" data-path="cha-mcmc.html"><a href="cha-mcmc.html#conjugate-gibbs-samplers"><i class="fa fa-check"></i><b>7.11.1</b> Conjugate (‘Gibbs’) samplers</a></li>
<li class="chapter" data-level="7.11.2" data-path="cha-mcmc.html"><a href="cha-mcmc.html#subsec:HMC"><i class="fa fa-check"></i><b>7.11.2</b> Hamiltonian Monte Carlo (HMC)</a></li>
<li class="chapter" data-level="7.11.3" data-path="cha-mcmc.html"><a href="cha-mcmc.html#particle-filter-samplers"><i class="fa fa-check"></i><b>7.11.3</b> Particle filter samplers</a></li>
<li class="chapter" data-level="7.11.4" data-path="cha-mcmc.html"><a href="cha-mcmc.html#customized-log-likelihood-evaluations-rw_llfunction-sampler"><i class="fa fa-check"></i><b>7.11.4</b> Customized log-likelihood evaluations: <em>RW_llFunction sampler</em></a></li>
</ul></li>
<li class="chapter" data-level="7.12" data-path="cha-mcmc.html"><a href="cha-mcmc.html#sec:mcmc-example-litters"><i class="fa fa-check"></i><b>7.12</b> Detailed MCMC example: <em>litters</em></a></li>
<li class="chapter" data-level="7.13" data-path="cha-mcmc.html"><a href="cha-mcmc.html#mcmc-suite-compare-mcmcs"><i class="fa fa-check"></i><b>7.13</b> Comparing different MCMCs with <em>MCMCsuite</em> and <em>compareMCMCs</em></a></li>
<li class="chapter" data-level="7.14" data-path="cha-mcmc.html"><a href="cha-mcmc.html#running-mcmc-chains-in-parallel"><i class="fa fa-check"></i><b>7.14</b> Running MCMC chains in parallel</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html"><i class="fa fa-check"></i><b>8</b> Sequential Monte Carlo, Particle MCMC, Iterated Filtering, and MCEM</a>
<ul>
<li class="chapter" data-level="8.1" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#particle-filters-sequential-monte-carlo-and-iterated-filtering"><i class="fa fa-check"></i><b>8.1</b> Particle filters / sequential Monte Carlo and iterated filtering</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#filtering-algorithms"><i class="fa fa-check"></i><b>8.1.1</b> Filtering algorithms</a></li>
<li class="chapter" data-level="8.1.2" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#sec:particle-mcmc"><i class="fa fa-check"></i><b>8.1.2</b> Particle MCMC (PMCMC)</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#monte-carlo-expectation-maximization-mcem"><i class="fa fa-check"></i><b>8.2</b> Monte Carlo Expectation Maximization (MCEM)</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="cha-algos-provided.html"><a href="cha-algos-provided.html#sec:estimate-mcem-cov"><i class="fa fa-check"></i><b>8.2.1</b> Estimating the asymptotic covariance From MCEM</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="cha-spatial.html"><a href="cha-spatial.html"><i class="fa fa-check"></i><b>9</b> Spatial models</a>
<ul>
<li class="chapter" data-level="9.1" data-path="cha-spatial.html"><a href="cha-spatial.html#intrinsic-gaussian-car-model-dcar_normal"><i class="fa fa-check"></i><b>9.1</b> Intrinsic Gaussian CAR model: <em>dcar_normal</em></a>
<ul>
<li class="chapter" data-level="9.1.1" data-path="cha-spatial.html"><a href="cha-spatial.html#specification-and-density"><i class="fa fa-check"></i><b>9.1.1</b> Specification and density</a></li>
<li class="chapter" data-level="9.1.2" data-path="cha-spatial.html"><a href="cha-spatial.html#example"><i class="fa fa-check"></i><b>9.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="9.2" data-path="cha-spatial.html"><a href="cha-spatial.html#proper-gaussian-car-model-dcar_proper"><i class="fa fa-check"></i><b>9.2</b> Proper Gaussian CAR model: <em>dcar_proper</em></a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="cha-spatial.html"><a href="cha-spatial.html#specification-and-density-1"><i class="fa fa-check"></i><b>9.2.1</b> Specification and density</a></li>
<li class="chapter" data-level="9.2.2" data-path="cha-spatial.html"><a href="cha-spatial.html#example-1"><i class="fa fa-check"></i><b>9.2.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="cha-spatial.html"><a href="cha-spatial.html#sec:spatial-mcmc-sampling-car"><i class="fa fa-check"></i><b>9.3</b> MCMC Sampling of CAR models</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="cha-spatial.html"><a href="cha-spatial.html#initial-values"><i class="fa fa-check"></i><b>9.3.1</b> Initial values</a></li>
<li class="chapter" data-level="9.3.2" data-path="cha-spatial.html"><a href="cha-spatial.html#zero-neighbor-regions"><i class="fa fa-check"></i><b>9.3.2</b> Zero-neighbor regions</a></li>
<li class="chapter" data-level="9.3.3" data-path="cha-spatial.html"><a href="cha-spatial.html#zero-mean-constraint"><i class="fa fa-check"></i><b>9.3.3</b> Zero-mean constraint</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="10" data-path="cha-bnp.html"><a href="cha-bnp.html"><i class="fa fa-check"></i><b>10</b> Bayesian nonparametric models</a>
<ul>
<li class="chapter" data-level="10.1" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:bnpmixtures"><i class="fa fa-check"></i><b>10.1</b> Bayesian nonparametric mixture models</a></li>
<li class="chapter" data-level="10.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:crp"><i class="fa fa-check"></i><b>10.2</b> Chinese Restaurant Process model</a>
<ul>
<li class="chapter" data-level="10.2.1" data-path="cha-bnp.html"><a href="cha-bnp.html#specification-and-density-2"><i class="fa fa-check"></i><b>10.2.1</b> Specification and density</a></li>
<li class="chapter" data-level="10.2.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:excrp"><i class="fa fa-check"></i><b>10.2.2</b> Example</a></li>
<li class="chapter" data-level="10.2.3" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:extensionscrp"><i class="fa fa-check"></i><b>10.2.3</b> Extensions</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:sb"><i class="fa fa-check"></i><b>10.3</b> Stick-breaking model</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="cha-bnp.html"><a href="cha-bnp.html#specification-and-function"><i class="fa fa-check"></i><b>10.3.1</b> Specification and function</a></li>
<li class="chapter" data-level="10.3.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:exsb"><i class="fa fa-check"></i><b>10.3.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="cha-bnp.html"><a href="cha-bnp.html#mcmc-sampling-of-bnp-models"><i class="fa fa-check"></i><b>10.4</b> MCMC sampling of BNP models</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:mcmcdcrp"><i class="fa fa-check"></i><b>10.4.1</b> Sampling CRP models</a></li>
<li class="chapter" data-level="10.4.2" data-path="cha-bnp.html"><a href="cha-bnp.html#sec:mcmcsb"><i class="fa fa-check"></i><b>10.4.2</b> Sampling stick-breaking models</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Programming with NIMBLE</b></span></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="11" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html"><i class="fa fa-check"></i><b>11</b> Writing simple nimbleFunctions</a>
<ul>
<li class="chapter" data-level="11.1" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:RC-intro"><i class="fa fa-check"></i><b>11.1</b> Introduction to simple nimbleFunctions</a></li>
<li class="chapter" data-level="11.2" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:r-fiunctions-implemented"><i class="fa fa-check"></i><b>11.2</b> R functions (or variants) implemented in NIMBLE</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#finding-help-for-nimbles-versions-of-r-functions"><i class="fa fa-check"></i><b>11.2.1</b> Finding help for NIMBLE’s versions of R functions</a></li>
<li class="chapter" data-level="11.2.2" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#basic-operations"><i class="fa fa-check"></i><b>11.2.2</b> Basic operations</a></li>
<li class="chapter" data-level="11.2.3" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:basic-math-linear"><i class="fa fa-check"></i><b>11.2.3</b> Math and linear algebra</a></li>
<li class="chapter" data-level="11.2.4" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:nimble-dist-funs"><i class="fa fa-check"></i><b>11.2.4</b> Distribution functions</a></li>
<li class="chapter" data-level="11.2.5" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:basic-flow-control"><i class="fa fa-check"></i><b>11.2.5</b> Flow control: <em>if-then-else</em>, <em>for</em>, <em>while</em>, and <em>stop</em></a></li>
<li class="chapter" data-level="11.2.6" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:print"><i class="fa fa-check"></i><b>11.2.6</b> <em>print</em> and <em>cat</em></a></li>
<li class="chapter" data-level="11.2.7" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:check-user-interr"><i class="fa fa-check"></i><b>11.2.7</b> Checking for user interrupts: <em>checkInterrupt</em></a></li>
<li class="chapter" data-level="11.2.8" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#optimization-optim-and-nimoptim"><i class="fa fa-check"></i><b>11.2.8</b> Optimization: <em>optim</em> and <em>nimOptim</em></a></li>
<li class="chapter" data-level="11.2.9" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#integration-integrate-and-nimintegrate"><i class="fa fa-check"></i><b>11.2.9</b> Integration: <em>integrate</em> and <em>nimIntegrate</em></a></li>
<li class="chapter" data-level="11.2.10" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:altern-keyw-some"><i class="fa fa-check"></i><b>11.2.10</b> ‘nim’ synonyms for some functions</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:how-nimble-handles"><i class="fa fa-check"></i><b>11.3</b> How NIMBLE handles types of variables</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:nimbleList-RCFuns"><i class="fa fa-check"></i><b>11.3.1</b> nimbleList data structures</a></li>
<li class="chapter" data-level="11.3.2" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:how-types-work"><i class="fa fa-check"></i><b>11.3.2</b> How numeric types work</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:decl-argum-return"><i class="fa fa-check"></i><b>11.4</b> Declaring argument and return types</a></li>
<li class="chapter" data-level="11.5" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:comp-nimbl-pass"><i class="fa fa-check"></i><b>11.5</b> Compiled nimbleFunctions pass arguments by reference</a></li>
<li class="chapter" data-level="11.6" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:calling-external-code"><i class="fa fa-check"></i><b>11.6</b> Calling external compiled code</a></li>
<li class="chapter" data-level="11.7" data-path="cha-RCfunctions.html"><a href="cha-RCfunctions.html#sec:calling-R-code"><i class="fa fa-check"></i><b>11.7</b> Calling uncompiled R functions from compiled nimbleFunctions</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="cha-user-defined.html"><a href="cha-user-defined.html"><i class="fa fa-check"></i><b>12</b> Creating user-defined BUGS distributions and functions</a>
<ul>
<li class="chapter" data-level="12.1" data-path="cha-user-defined.html"><a href="cha-user-defined.html#sec:user-functions"><i class="fa fa-check"></i><b>12.1</b> User-defined functions</a></li>
<li class="chapter" data-level="12.2" data-path="cha-user-defined.html"><a href="cha-user-defined.html#sec:user-distributions"><i class="fa fa-check"></i><b>12.2</b> User-defined distributions</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="cha-user-defined.html"><a href="cha-user-defined.html#sec:registerDistributions"><i class="fa fa-check"></i><b>12.2.1</b> Using <em>registerDistributions</em> for alternative parameterizations and providing other information</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="cha-using-models.html"><a href="cha-using-models.html"><i class="fa fa-check"></i><b>13</b> Working with NIMBLE models</a>
<ul>
<li class="chapter" data-level="13.1" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:accessing-variables"><i class="fa fa-check"></i><b>13.1</b> The variables and nodes in a NIMBLE model</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:get-nodes"><i class="fa fa-check"></i><b>13.1.1</b> Determining the nodes in a model</a></li>
<li class="chapter" data-level="13.1.2" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:introduced-nodes"><i class="fa fa-check"></i><b>13.1.2</b> Understanding lifted nodes</a></li>
<li class="chapter" data-level="13.1.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:cdgetdependencies"><i class="fa fa-check"></i><b>13.1.3</b> Determining dependencies in a model</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:nodeInfo"><i class="fa fa-check"></i><b>13.2</b> Accessing information about nodes and variables</a>
<ul>
<li class="chapter" data-level="13.2.1" data-path="cha-using-models.html"><a href="cha-using-models.html#getting-distributional-information-about-a-node"><i class="fa fa-check"></i><b>13.2.1</b> Getting distributional information about a node</a></li>
<li class="chapter" data-level="13.2.2" data-path="cha-using-models.html"><a href="cha-using-models.html#getting-information-about-a-distribution"><i class="fa fa-check"></i><b>13.2.2</b> Getting information about a distribution</a></li>
<li class="chapter" data-level="13.2.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:getParam"><i class="fa fa-check"></i><b>13.2.3</b> Getting distribution parameter values for a node</a></li>
<li class="chapter" data-level="13.2.4" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:getBound"><i class="fa fa-check"></i><b>13.2.4</b> Getting distribution bounds for a node</a></li>
</ul></li>
<li class="chapter" data-level="13.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:cdcalc-cdsim-cdgetl"><i class="fa fa-check"></i><b>13.3</b> Carrying out model calculations</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="cha-using-models.html"><a href="cha-using-models.html#core-model-operations-calculation-and-simulation"><i class="fa fa-check"></i><b>13.3.1</b> Core model operations: calculation and simulation</a></li>
<li class="chapter" data-level="13.3.2" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:cdsimn-cdcalcn-cdget"><i class="fa fa-check"></i><b>13.3.2</b> Pre-defined nimbleFunctions for operating on model nodes: <em>simNodes</em>, <em>calcNodes</em>, and <em>getLogProbNodes</em></a></li>
<li class="chapter" data-level="13.3.3" data-path="cha-using-models.html"><a href="cha-using-models.html#sec:access-log-prob"><i class="fa fa-check"></i><b>13.3.3</b> Accessing log probabilities via <em>logProb</em> variables</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="cha-data-structures.html"><a href="cha-data-structures.html"><i class="fa fa-check"></i><b>14</b> Data structures in NIMBLE</a>
<ul>
<li class="chapter" data-level="14.1" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:modelValues-struct"><i class="fa fa-check"></i><b>14.1</b> The modelValues data structure</a>
<ul>
<li class="chapter" data-level="14.1.1" data-path="cha-data-structures.html"><a href="cha-data-structures.html#creating-modelvalues-objects"><i class="fa fa-check"></i><b>14.1.1</b> Creating modelValues objects</a></li>
<li class="chapter" data-level="14.1.2" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:access-cont-modelv"><i class="fa fa-check"></i><b>14.1.2</b> Accessing contents of modelValues</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:nimbleLists"><i class="fa fa-check"></i><b>14.2</b> The nimbleList data structure</a>
<ul>
<li class="chapter" data-level="14.2.1" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:predef-nimbleLists"><i class="fa fa-check"></i><b>14.2.1</b> Pre-defined nimbleList types</a></li>
<li class="chapter" data-level="14.2.2" data-path="cha-data-structures.html"><a href="cha-data-structures.html#sec:eigen-nimFunctions"><i class="fa fa-check"></i><b>14.2.2</b> Using <em>eigen</em> and <em>svd</em> in nimbleFunctions</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html"><i class="fa fa-check"></i><b>15</b> Writing nimbleFunctions to interact with models</a>
<ul>
<li class="chapter" data-level="15.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:writ-nimble-funct"><i class="fa fa-check"></i><b>15.1</b> Overview</a></li>
<li class="chapter" data-level="15.2" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:using-comp-nimbl"><i class="fa fa-check"></i><b>15.2</b> Using and compiling nimbleFunctions</a></li>
<li class="chapter" data-level="15.3" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#writing-setup-code"><i class="fa fa-check"></i><b>15.3</b> Writing setup code</a>
<ul>
<li class="chapter" data-level="15.3.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#useful-tools-for-setup-functions"><i class="fa fa-check"></i><b>15.3.1</b> Useful tools for setup functions</a></li>
<li class="chapter" data-level="15.3.2" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:access-modify-numer"><i class="fa fa-check"></i><b>15.3.2</b> Accessing and modifying numeric values from setup</a></li>
<li class="chapter" data-level="15.3.3" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#determining-numeric-types-in-nimblefunctions"><i class="fa fa-check"></i><b>15.3.3</b> Determining numeric types in nimbleFunctions</a></li>
<li class="chapter" data-level="15.3.4" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:determ-pers-texttts"><i class="fa fa-check"></i><b>15.3.4</b> Control of setup outputs</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:nimble-lang-comp"><i class="fa fa-check"></i><b>15.4</b> Writing run code</a>
<ul>
<li class="chapter" data-level="15.4.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:driv-models:-calc"><i class="fa fa-check"></i><b>15.4.1</b> Driving models: <em>calculate</em>, <em>calculateDiff</em>, <em>simulate</em>, <em>getLogProb</em></a></li>
<li class="chapter" data-level="15.4.2" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#getting-and-setting-variable-and-node-values"><i class="fa fa-check"></i><b>15.4.2</b> Getting and setting variable and node values</a></li>
<li class="chapter" data-level="15.4.3" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#getting-parameter-values-and-node-bounds"><i class="fa fa-check"></i><b>15.4.3</b> Getting parameter values and node bounds</a></li>
<li class="chapter" data-level="15.4.4" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:access-model-modelv"><i class="fa fa-check"></i><b>15.4.4</b> Using modelValues objects</a></li>
<li class="chapter" data-level="15.4.5" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:using-model-variable"><i class="fa fa-check"></i><b>15.4.5</b> Using model variables and modelValues in expressions</a></li>
<li class="chapter" data-level="15.4.6" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:incl-other-meth"><i class="fa fa-check"></i><b>15.4.6</b> Including other methods in a nimbleFunction</a></li>
<li class="chapter" data-level="15.4.7" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:using-other-nimbl"><i class="fa fa-check"></i><b>15.4.7</b> Using other nimbleFunctions</a></li>
<li class="chapter" data-level="15.4.8" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:virt-nimbl-nimbl"><i class="fa fa-check"></i><b>15.4.8</b> Virtual nimbleFunctions and nimbleFunctionLists</a></li>
<li class="chapter" data-level="15.4.9" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#character-objects"><i class="fa fa-check"></i><b>15.4.9</b> Character objects</a></li>
<li class="chapter" data-level="15.4.10" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:user-defined-data"><i class="fa fa-check"></i><b>15.4.10</b> User-defined data structures</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:user-samplers"><i class="fa fa-check"></i><b>15.5</b> Example: writing user-defined samplers to extend NIMBLE’s MCMC engine</a>
<ul>
<li class="chapter" data-level="15.5.1" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#user-defined-samplers-and-posterior-predictive-nodes"><i class="fa fa-check"></i><b>15.5.1</b> User-defined samplers and posterior predictive nodes</a></li>
</ul></li>
<li class="chapter" data-level="15.6" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#copying-nimblefunctions-and-nimble-models"><i class="fa fa-check"></i><b>15.6</b> Copying nimbleFunctions (and NIMBLE models)</a></li>
<li class="chapter" data-level="15.7" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#sec:debugging"><i class="fa fa-check"></i><b>15.7</b> Debugging nimbleFunctions</a></li>
<li class="chapter" data-level="15.8" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#timing-nimblefunctions-with-run.time"><i class="fa fa-check"></i><b>15.8</b> Timing nimbleFunctions with <em>run.time</em></a></li>
<li class="chapter" data-level="15.9" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#clearing-and-unloading-compiled-objects"><i class="fa fa-check"></i><b>15.9</b> Clearing and unloading compiled objects</a></li>
<li class="chapter" data-level="15.10" data-path="cha-progr-with-models.html"><a href="cha-progr-with-models.html#reducing-memory-usage"><i class="fa fa-check"></i><b>15.10</b> Reducing memory usage</a></li>
</ul></li>
<li class="part"><span><b>V Automatic Derivatives in NIMBLE</b></span></li>
<li class="chapter" data-level="16" data-path="cha-AD.html"><a href="cha-AD.html"><i class="fa fa-check"></i><b>16</b> Automatic Derivatives</a>
<ul>
<li class="chapter" data-level="16.1" data-path="cha-AD.html"><a href="cha-AD.html#sec:use-derivs"><i class="fa fa-check"></i><b>16.1</b> How to turn on derivatives in a model</a>
<ul>
<li class="chapter" data-level="16.1.1" data-path="cha-AD.html"><a href="cha-AD.html#finish-setting-up-the-glmm-example"><i class="fa fa-check"></i><b>16.1.1</b> Finish setting up the GLMM example</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="cha-AD.html"><a href="cha-AD.html#how-to-use-laplace-approximation"><i class="fa fa-check"></i><b>16.2</b> How to use Laplace approximation</a></li>
<li class="chapter" data-level="16.3" data-path="cha-AD.html"><a href="cha-AD.html#sec:AD-user-def"><i class="fa fa-check"></i><b>16.3</b> How to support derivatives in user-defined functions and distributions</a></li>
<li class="chapter" data-level="16.4" data-path="cha-AD.html"><a href="cha-AD.html#what-operations-are-and-arent-supported-for-ad"><i class="fa fa-check"></i><b>16.4</b> What operations are and aren’t supported for AD</a></li>
<li class="chapter" data-level="16.5" data-path="cha-AD.html"><a href="cha-AD.html#basics-of-obtaining-derivatives-in-nimblefunctions"><i class="fa fa-check"></i><b>16.5</b> Basics of obtaining derivatives in <code>nimbleFunctions</code></a>
<ul>
<li class="chapter" data-level="16.5.1" data-path="cha-AD.html"><a href="cha-AD.html#checking-derivatives-with-uncompiled-execution"><i class="fa fa-check"></i><b>16.5.1</b> Checking derivatives with uncompiled execution</a></li>
<li class="chapter" data-level="16.5.2" data-path="cha-AD.html"><a href="cha-AD.html#holding-some-local-variables-out-of-derivative-tracking"><i class="fa fa-check"></i><b>16.5.2</b> Holding some local variables out of derivative tracking</a></li>
<li class="chapter" data-level="16.5.3" data-path="cha-AD.html"><a href="cha-AD.html#sec:AD-multiple-NF"><i class="fa fa-check"></i><b>16.5.3</b> Using AD with multiple nimbleFunctions</a></li>
<li class="chapter" data-level="16.5.4" data-path="cha-AD.html"><a href="cha-AD.html#understanding-more-about-how-ad-works-taping-of-operations"><i class="fa fa-check"></i><b>16.5.4</b> Understanding more about how AD works: <em>taping</em> of operations</a></li>
<li class="chapter" data-level="16.5.5" data-path="cha-AD.html"><a href="cha-AD.html#resetting-a-nimderivs-call"><i class="fa fa-check"></i><b>16.5.5</b> Resetting a <code>nimDerivs</code> call</a></li>
<li class="chapter" data-level="16.5.6" data-path="cha-AD.html"><a href="cha-AD.html#a-note-on-performance-benchmarking"><i class="fa fa-check"></i><b>16.5.6</b> A note on performance benchmarking</a></li>
</ul></li>
<li class="chapter" data-level="16.6" data-path="cha-AD.html"><a href="cha-AD.html#advanced-uses-double-taping"><i class="fa fa-check"></i><b>16.6</b> Advanced uses: double taping</a></li>
<li class="chapter" data-level="16.7" data-path="cha-AD.html"><a href="cha-AD.html#derivatives-involving-model-calculations"><i class="fa fa-check"></i><b>16.7</b> Derivatives involving model calculations</a>
<ul>
<li class="chapter" data-level="16.7.1" data-path="cha-AD.html"><a href="cha-AD.html#method-1-nimderivs-of-modelcalculate"><i class="fa fa-check"></i><b>16.7.1</b> Method 1: <code>nimDerivs</code> of <code>model$calculate</code></a></li>
<li class="chapter" data-level="16.7.2" data-path="cha-AD.html"><a href="cha-AD.html#method-2-nimderivs-of-a-method-that-calls-modelcalculate"><i class="fa fa-check"></i><b>16.7.2</b> Method 2: <code>nimDerivs</code> of a method that calls <code>model$calculate</code></a></li>
</ul></li>
<li class="chapter" data-level="16.8" data-path="cha-AD.html"><a href="cha-AD.html#sec:parameter-transform"><i class="fa fa-check"></i><b>16.8</b> Parameter transformations</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="example-maximum-likelihood-estimation-using-optim-with-gradients-from-nimderivs..html"><a href="example-maximum-likelihood-estimation-using-optim-with-gradients-from-nimderivs..html"><i class="fa fa-check"></i><b>17</b> Example: maximum likelihood estimation using <code>optim</code> with gradients from <code>nimDerivs</code>.</a></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="cha-progr-with-models" class="section level1 hasAnchor" number="15">
<h1><span class="header-section-number">Chapter 15</span> Writing nimbleFunctions to interact with models<a href="cha-progr-with-models.html#cha-progr-with-models" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="sec:writ-nimble-funct" class="section level2 hasAnchor" number="15.1">
<h2><span class="header-section-number">15.1</span> Overview<a href="cha-progr-with-models.html#sec:writ-nimble-funct" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>When you write an R function, you say what the input arguments are,
you provide the code for execution, and in that code you give the
value to be returned<a href="#fn29" class="footnote-ref" id="fnref29"><sup>29</sup></a>. Using the
<code>function</code> keyword in R triggers the operation of
creating an object that is the function.</p>
<p>Creating nimbleFunctions is similar, but there
are two kinds of code and two steps of execution:</p>
<ol style="list-style-type: decimal">
<li><p><em>Setup</em> code is provided as a regular R function, but the
programmer does not control what it returns. Typically the inputs to
<em>setup</em> code are objects like a model, a vector of nodes,
a modelValues object or a modelValues configuration, or another nimbleFunction. The setup code,
as its name implies, sets up information for run-time code. It is
executed in R, so it can use any aspect of R.</p></li>
<li><p><em>Run</em> code is provided in the NIMBLE language, which was
introduced in Chapter <a href="cha-RCfunctions.html#cha-RCfunctions">11</a>. This is
similar to a narrow subset of R, but it is important to remember
that it is different – defined by what can be compiled – and much more limited. <em>Run</em> code can
use the objects created by the <em>setup</em> code. In addition,
some information on variable types must be provided for input
arguments, the return value, and in some circumstances for local
variables. There are two
kinds of <em>run</em> code:</p>
<ol style="list-style-type: lower-alpha">
<li>There is always a primary function, given as the argument <code>run</code><a href="#fn30" class="footnote-ref" id="fnref30"><sup>30</sup></a>.</li>
<li>There can optionally be other functions, or ‘methods’ in the
language of object-oriented programming, that share the same
objects created by the <em>setup</em> function.</li>
</ol></li>
</ol>
<p>Here is a small example to fix ideas:</p>
<div class="sourceCode" id="cb394"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb394-1"><a href="cha-progr-with-models.html#cb394-1" aria-hidden="true" tabindex="-1"></a>logProbCalcPlus <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb394-2"><a href="cha-progr-with-models.html#cb394-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(model, node) {</span>
<span id="cb394-3"><a href="cha-progr-with-models.html#cb394-3" aria-hidden="true" tabindex="-1"></a>        dependentNodes <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">getDependencies</span>(node)</span>
<span id="cb394-4"><a href="cha-progr-with-models.html#cb394-4" aria-hidden="true" tabindex="-1"></a>        valueToAdd <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb394-5"><a href="cha-progr-with-models.html#cb394-5" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb394-6"><a href="cha-progr-with-models.html#cb394-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">P =</span> <span class="fu">double</span>(<span class="dv">0</span>)) {</span>
<span id="cb394-7"><a href="cha-progr-with-models.html#cb394-7" aria-hidden="true" tabindex="-1"></a>        model[[node]] <span class="ot">&lt;&lt;-</span> P <span class="sc">+</span> valueToAdd</span>
<span id="cb394-8"><a href="cha-progr-with-models.html#cb394-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(model<span class="sc">$</span><span class="fu">calculate</span>(dependentNodes))</span>
<span id="cb394-9"><a href="cha-progr-with-models.html#cb394-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">0</span>))</span>
<span id="cb394-10"><a href="cha-progr-with-models.html#cb394-10" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb394-11"><a href="cha-progr-with-models.html#cb394-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb394-12"><a href="cha-progr-with-models.html#cb394-12" aria-hidden="true" tabindex="-1"></a>code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb394-13"><a href="cha-progr-with-models.html#cb394-13" aria-hidden="true" tabindex="-1"></a>    a <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb394-14"><a href="cha-progr-with-models.html#cb394-14" aria-hidden="true" tabindex="-1"></a>    b <span class="sc">~</span> <span class="fu">dnorm</span>(a, <span class="dv">1</span>)</span>
<span id="cb394-15"><a href="cha-progr-with-models.html#cb394-15" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb394-16"><a href="cha-progr-with-models.html#cb394-16" aria-hidden="true" tabindex="-1"></a>testModel <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(code, <span class="at">check =</span> <span class="cn">FALSE</span>)</span>
<span id="cb394-17"><a href="cha-progr-with-models.html#cb394-17" aria-hidden="true" tabindex="-1"></a>logProbCalcPlusA <span class="ot">&lt;-</span> <span class="fu">logProbCalcPlus</span>(testModel, <span class="st">&quot;a&quot;</span>)</span>
<span id="cb394-18"><a href="cha-progr-with-models.html#cb394-18" aria-hidden="true" tabindex="-1"></a>testModel<span class="sc">$</span>b <span class="ot">&lt;-</span> <span class="fl">1.5</span></span>
<span id="cb394-19"><a href="cha-progr-with-models.html#cb394-19" aria-hidden="true" tabindex="-1"></a>logProbCalcPlusA<span class="sc">$</span><span class="fu">run</span>(<span class="fl">0.25</span>) </span></code></pre></div>
<pre><code>## [1] -2.650377</code></pre>
<div class="sourceCode" id="cb396"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb396-1"><a href="cha-progr-with-models.html#cb396-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dnorm</span>(<span class="fl">1.25</span>,<span class="dv">0</span>,<span class="dv">1</span>,<span class="cn">TRUE</span>)<span class="sc">+</span><span class="fu">dnorm</span>(<span class="fl">1.5</span>,<span class="fl">1.25</span>,<span class="dv">1</span>,<span class="cn">TRUE</span>) <span class="co"># direct validation</span></span></code></pre></div>
<pre><code>## [1] -2.650377</code></pre>
<div class="sourceCode" id="cb398"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb398-1"><a href="cha-progr-with-models.html#cb398-1" aria-hidden="true" tabindex="-1"></a>testModel<span class="sc">$</span>a  <span class="co"># &quot;a&quot; was set to 0.5 + valueToAdd</span></span></code></pre></div>
<pre><code>## [1] 1.25</code></pre>
<p>The call to the R function called <code>nimbleFunction</code> returns a
function, similarly to defining a function in R. That function,
<code>logProbCalcPlus</code>, takes arguments for its <code>setup</code> function,
executes it, and returns an object, <code>logProbCalcPlusA</code>, that has a
<em>run</em> member function (method) accessed by <code>$run</code>. In this case, the
<code>setup</code> function obtains the stochastic dependencies of the
<code>node</code> using the <code>getDependencies</code> member function of the model
(see Section <a href="cha-using-models.html#sec:cdgetdependencies">13.1.3</a>) and stores them in
<code>dependentNodes</code>. In this way, <code>logProbCalcPlus</code> can adapt to any
model. It also creates a variable, <code>valueToAdd</code>, that can be used by the nimbleFunction.</p>
<p>The object <code>logProbCalcPlusA</code>, returned by <code>logProbCalcPlus</code>,
is permanently bound to the results of the processed <code>setup</code>
function. In this case, <code>logProbCalcPlusA$run</code> takes a scalar input value, <code>P</code>,
assigns <code>P + valueToAdd</code> to
the given node in the model, and returns the sum of the log
probabilities of that node and its stochastic
dependencies<a href="#fn31" class="footnote-ref" id="fnref31"><sup>31</sup></a>. We say <code>logProbCalcPlusA</code> is an ‘instance’ of
<code>logProbCalcPlus</code> that is
‘specialized’ or ‘bound’ to <code>a</code> and <code>testModel</code>. Usually, the
<code>setup</code> code will be where information about the model
structure is determined, and then the <code>run</code> code can use that
information without repeatedly, redundantly recomputing it. A
nimbleFunction can
be called repeatedly (one can think of it as a generator), each time returning a specialized
nimbleFunction.</p>
<p>Readers familiar with object-oriented programming may find it useful
to think in terms of class definitions and objects. <code>nimbleFunction</code>
creates a class definition. Each specialized nimbleFunction is one object
in the class. The setup arguments are used to define member data in
the object.</p>
</div>
<div id="sec:using-comp-nimbl" class="section level2 hasAnchor" number="15.2">
<h2><span class="header-section-number">15.2</span> Using and compiling nimbleFunctions<a href="cha-progr-with-models.html#sec:using-comp-nimbl" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To compile the nimbleFunction, together with its model, we use <code>compileNimble</code>:</p>
<div class="sourceCode" id="cb400"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb400-1"><a href="cha-progr-with-models.html#cb400-1" aria-hidden="true" tabindex="-1"></a>CnfDemo <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(testModel, logProbCalcPlusA)</span>
<span id="cb400-2"><a href="cha-progr-with-models.html#cb400-2" aria-hidden="true" tabindex="-1"></a>CtestModel <span class="ot">&lt;-</span> CnfDemo<span class="sc">$</span>testModel</span>
<span id="cb400-3"><a href="cha-progr-with-models.html#cb400-3" aria-hidden="true" tabindex="-1"></a>ClogProbCalcPlusA <span class="ot">&lt;-</span> CnfDemo<span class="sc">$</span>logProbCalcPlusA</span></code></pre></div>
<p>These have been initialized with the values from their uncompiled
versions and can be used in the same way:</p>
<div class="sourceCode" id="cb401"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb401-1"><a href="cha-progr-with-models.html#cb401-1" aria-hidden="true" tabindex="-1"></a>CtestModel<span class="sc">$</span>a      <span class="co"># values were initialized from testModel</span></span></code></pre></div>
<pre><code>## [1] 1.25</code></pre>
<div class="sourceCode" id="cb403"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb403-1"><a href="cha-progr-with-models.html#cb403-1" aria-hidden="true" tabindex="-1"></a>CtestModel<span class="sc">$</span>b</span></code></pre></div>
<pre><code>## [1] 1.5</code></pre>
<div class="sourceCode" id="cb405"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb405-1"><a href="cha-progr-with-models.html#cb405-1" aria-hidden="true" tabindex="-1"></a>lpA <span class="ot">&lt;-</span> ClogProbCalcPlusA<span class="sc">$</span><span class="fu">run</span>(<span class="fl">1.5</span>)</span>
<span id="cb405-2"><a href="cha-progr-with-models.html#cb405-2" aria-hidden="true" tabindex="-1"></a>lpA</span></code></pre></div>
<pre><code>## [1] -5.462877</code></pre>
<div class="sourceCode" id="cb407"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb407-1"><a href="cha-progr-with-models.html#cb407-1" aria-hidden="true" tabindex="-1"></a><span class="co"># verify the answer:</span></span>
<span id="cb407-2"><a href="cha-progr-with-models.html#cb407-2" aria-hidden="true" tabindex="-1"></a><span class="fu">dnorm</span>(CtestModel<span class="sc">$</span>b, CtestModel<span class="sc">$</span>a, <span class="dv">1</span>, <span class="at">log =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> </span>
<span id="cb407-3"><a href="cha-progr-with-models.html#cb407-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dnorm</span>(CtestModel<span class="sc">$</span>a, <span class="dv">0</span>, <span class="dv">1</span>, <span class="at">log =</span> <span class="cn">TRUE</span>) </span></code></pre></div>
<pre><code>## [1] -5.462877</code></pre>
<div class="sourceCode" id="cb409"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb409-1"><a href="cha-progr-with-models.html#cb409-1" aria-hidden="true" tabindex="-1"></a>CtestModel<span class="sc">$</span>a       <span class="co"># a was modified in the compiled model</span></span></code></pre></div>
<pre><code>## [1] 2.5</code></pre>
<div class="sourceCode" id="cb411"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb411-1"><a href="cha-progr-with-models.html#cb411-1" aria-hidden="true" tabindex="-1"></a>testModel<span class="sc">$</span>a        <span class="co"># the uncompiled model was not modified</span></span></code></pre></div>
<pre><code>## [1] 1.25</code></pre>
</div>
<div id="writing-setup-code" class="section level2 hasAnchor" number="15.3">
<h2><span class="header-section-number">15.3</span> Writing setup code<a href="cha-progr-with-models.html#writing-setup-code" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="useful-tools-for-setup-functions" class="section level3 hasAnchor" number="15.3.1">
<h3><span class="header-section-number">15.3.1</span> Useful tools for setup functions<a href="cha-progr-with-models.html#useful-tools-for-setup-functions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The setup function is typically used to determine information on nodes
in a model, set up modelValues or nimbleList objects, set up (nested) nimbleFunctions
or nimbleFunctionLists, and set up any persistent numeric objects.
For example, the setup code of an MCMC nimbleFunction creates the
nimbleFunctionList of sampler nimbleFunctions. The values of numeric
objects created in setup code can be modified by run code and will
persist across calls.</p>
<p>Some of the useful tools and objects to create in setup functions include:</p>
<ul>
<li><strong>vectors of node names, often from a model</strong> Often these are obtained from the
<code>getNodeNames</code>, <code>getDependencies</code>, and other methods of a model,
described in Sections <a href="cha-using-models.html#sec:accessing-variables">13.1</a>-<a href="cha-using-models.html#sec:nodeInfo">13.2</a>.</li>
<li><strong>modelValues objects</strong> These are discussed in Sections <a href="cha-data-structures.html#sec:modelValues-struct">14.1</a> and <a href="cha-progr-with-models.html#sec:access-model-modelv">15.4.4</a>.</li>
<li><strong>nimbleList objects</strong> New instances of <code>nimbleList</code>s can
be created from a nimbleList definition in either setup or run code. See Section <a href="cha-data-structures.html#sec:nimbleLists">14.2</a> for more information.
<!---  Comment: It is actually sketchy that we allow a nimbleList 
  % definition to be created in setup code, because it would  have to
 be the same definition always used by all specializations.  So 
  % I've put the emphasis here on creating nimbleList objects. -PdV --></li>
<li><strong>specializations of other nimbleFunctions</strong> A useful NIMBLE
programming technique is to have one nimbleFunction contain other
nimbleFunctions, which it can use in its run-time code (Section <a href="cha-progr-with-models.html#sec:using-other-nimbl">15.4.7</a>).</li>
<li><strong>lists of other nimbleFunctions</strong> In addition to containing single
other nimbleFunctions, a nimbleFunction can contain a list of other
nimbleFunctions (Section <a href="cha-progr-with-models.html#sec:virt-nimbl-nimbl">15.4.8</a>).</li>
</ul>
<p>If one wants a nimbleFunction that does get specialized but has
empty setup code, use <code>setup = function() {}</code> or <code>setup = TRUE</code>.</p>
</div>
<div id="sec:access-modify-numer" class="section level3 hasAnchor" number="15.3.2">
<h3><span class="header-section-number">15.3.2</span> Accessing and modifying numeric values from setup<a href="cha-progr-with-models.html#sec:access-modify-numer" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>While models and nodes created during setup cannot be
modified<a href="#fn32" class="footnote-ref" id="fnref32"><sup>32</sup></a>,
numeric values and modelValues can be, as illustrated by extending the example from above.</p>
<div class="sourceCode" id="cb413"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb413-1"><a href="cha-progr-with-models.html#cb413-1" aria-hidden="true" tabindex="-1"></a>logProbCalcPlusA<span class="sc">$</span>valueToAdd  <span class="co"># in the uncompiled version</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb415"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb415-1"><a href="cha-progr-with-models.html#cb415-1" aria-hidden="true" tabindex="-1"></a>logProbCalcPlusA<span class="sc">$</span>valueToAdd <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb415-2"><a href="cha-progr-with-models.html#cb415-2" aria-hidden="true" tabindex="-1"></a>ClogProbCalcPlusA<span class="sc">$</span>valueToAdd  <span class="co"># or in the compiled version</span></span></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb417"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb417-1"><a href="cha-progr-with-models.html#cb417-1" aria-hidden="true" tabindex="-1"></a>ClogProbCalcPlusA<span class="sc">$</span>valueToAdd <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb417-2"><a href="cha-progr-with-models.html#cb417-2" aria-hidden="true" tabindex="-1"></a>ClogProbCalcPlusA<span class="sc">$</span><span class="fu">run</span>(<span class="fl">1.5</span>)</span></code></pre></div>
<pre><code>## [1] -16.46288</code></pre>
<div class="sourceCode" id="cb419"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb419-1"><a href="cha-progr-with-models.html#cb419-1" aria-hidden="true" tabindex="-1"></a>CtestModel<span class="sc">$</span>a     <span class="co"># a == 1.5 + 3</span></span></code></pre></div>
<pre><code>## [1] 4.5</code></pre>
</div>
<div id="determining-numeric-types-in-nimblefunctions" class="section level3 hasAnchor" number="15.3.3">
<h3><span class="header-section-number">15.3.3</span> Determining numeric types in nimbleFunctions<a href="cha-progr-with-models.html#determining-numeric-types-in-nimblefunctions" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For numeric variables from the <code>setup</code> function that
appear in the <code>run</code> function or other member functions (or
are declared in <code>setupOutputs</code>), the
type is determined from the values created by the setup
code. The types created by setup code must be
consistent across all specializations of the nimbleFunction. For
example if <code>X</code> is created as a matrix (two-dimensional double) in one
specialization but as a vector (one-dimensional double) in another, there
will be a problem during compilation. The sizes may differ in each specialization.</p>
<p>Treatment of vectors of length one presents special challenges because
they could be treated as scalars or vectors. Currently they are
treated as scalars. If you want a vector, ensure that the length is
greater than one in the setup code and then use <code>setSize</code> in the
run-time code.</p>
</div>
<div id="sec:determ-pers-texttts" class="section level3 hasAnchor" number="15.3.4">
<h3><span class="header-section-number">15.3.4</span> Control of setup outputs<a href="cha-progr-with-models.html#sec:determ-pers-texttts" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Sometimes setup code may create variables that are not used in
run code. By default, NIMBLE inspects run code and omits
variables from setup that do not appear in run code from
compilation. However, sometimes a programmer may want to force a
numeric or character variable to be included in compilation, even if it
is not used directly in run code. As shown below, such variables
can be directly accessed in one nimbleFunction from another, which
provides a way of using nimbleFunctions as general data structures.
To force NIMBLE to include variables during compilation, for
example <code>X</code> and <code>Y</code>, simply include</p>
<div class="sourceCode" id="cb421"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb421-1"><a href="cha-progr-with-models.html#cb421-1" aria-hidden="true" tabindex="-1"></a><span class="fu">setupOutputs</span>(X, Y)</span></code></pre></div>
<p>anywhere in the setup code.</p>
</div>
</div>
<div id="sec:nimble-lang-comp" class="section level2 hasAnchor" number="15.4">
<h2><span class="header-section-number">15.4</span> Writing run code<a href="cha-progr-with-models.html#sec:nimble-lang-comp" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>In Chapter <a href="cha-RCfunctions.html#cha-RCfunctions">11</a> we described the functionality of the NIMBLE language that could be used in run code without setup code (typically in cases where no models or modelValues are needed). Next we explain the additional features that allow use of models and modelValues in the run code.</p>
<div id="sec:driv-models:-calc" class="section level3 hasAnchor" number="15.4.1">
<h3><span class="header-section-number">15.4.1</span> Driving models: <em>calculate</em>, <em>calculateDiff</em>, <em>simulate</em>, <em>getLogProb</em><a href="cha-progr-with-models.html#sec:driv-models:-calc" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>These four functions are the primary ways to operate a model. Their
syntax was explained in Section <a href="cha-using-models.html#sec:cdcalc-cdsim-cdgetl">13.3</a>. Except
for <code>getLogProb</code>, it is usually important for the <code>nodes</code>
vector to be sorted in
topological order. Model member functions such as <code>getDependencies</code> and
<code>expandNodeNames</code> will
always return topoligically sorted node names.</p>
<p>Most R-like indexing of a node vector is allowed within the
argument to <code>calculate</code>, <code>calculateDiff</code>, <code>simulate</code>, and <code>getLogProb</code>. For example, all of the following are allowed:</p>
<div class="sourceCode" id="cb422"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb422-1"><a href="cha-progr-with-models.html#cb422-1" aria-hidden="true" tabindex="-1"></a>myModel<span class="sc">$</span><span class="fu">calculate</span>(nodes)</span>
<span id="cb422-2"><a href="cha-progr-with-models.html#cb422-2" aria-hidden="true" tabindex="-1"></a>myModel<span class="sc">$</span><span class="fu">calculate</span>(nodes[i])</span>
<span id="cb422-3"><a href="cha-progr-with-models.html#cb422-3" aria-hidden="true" tabindex="-1"></a>myModel<span class="sc">$</span><span class="fu">calculate</span>(nodes[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>])</span>
<span id="cb422-4"><a href="cha-progr-with-models.html#cb422-4" aria-hidden="true" tabindex="-1"></a>myModel<span class="sc">$</span><span class="fu">calculate</span>(nodes[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">3</span>)])</span>
<span id="cb422-5"><a href="cha-progr-with-models.html#cb422-5" aria-hidden="true" tabindex="-1"></a>myModel<span class="sc">$</span><span class="fu">calculate</span>(nodes[<span class="dv">2</span><span class="sc">:</span>i])</span>
<span id="cb422-6"><a href="cha-progr-with-models.html#cb422-6" aria-hidden="true" tabindex="-1"></a>myModel<span class="sc">$</span><span class="fu">calculate</span>(nodes[ <span class="fu">values</span>(model, nodes) <span class="sc">+</span> <span class="fl">0.1</span> <span class="sc">&lt;</span> x ])</span></code></pre></div>
<p>Note that in the last line of code, one must have that the length of <code>nodes</code> is
equal to that of <code>values(model, nodes)</code>, which means that all the nodes in <code>nodes</code>
must be scalar nodes.</p>
<p>Also note that one cannot create new vectors of nodes in run code. They
can only be indexed within a call to <code>calculate</code>, <code>calculateDiff</code>,
<code>simulate</code> or <code>getLogProb</code>.</p>
</div>
<div id="getting-and-setting-variable-and-node-values" class="section level3 hasAnchor" number="15.4.2">
<h3><span class="header-section-number">15.4.2</span> Getting and setting variable and node values<a href="cha-progr-with-models.html#getting-and-setting-variable-and-node-values" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div id="using-indexing-with-nodes" class="section level4 hasAnchor" number="15.4.2.1">
<h4><span class="header-section-number">15.4.2.1</span> Using indexing with nodes<a href="cha-progr-with-models.html#using-indexing-with-nodes" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Here is an example that illustrates getting and setting of nodes,
subsets of nodes, or variables. Note the following:</p>
<ul>
<li>In <code>model[[v]]</code>, <code>v</code> can only be a single node or variable name, not a vector of multiple nodes nor an element of such a vector (<code>model[[ nodes[i] ]]</code> does not work). The node itself may be a vector, matrix or array node.</li>
<li>In fact, <code>v</code> can be a node-name-like character string, even if it is not actually a node in the model. See example 4 in the code below.</li>
<li>One can also use <code>model$varName</code>, with the caveat that <code>varName</code> must be a variable name. This usage would only make sense for a nimbleFunction written for models known to have a specific variable. (Note that if <code>a</code> is a scalar node in <code>model</code>, then <code>model[['a']]</code> will be a scalar but <code>model$a</code> will be a vector of length 1.</li>
<li>one should use the <code>&lt;&lt;-</code> global assignment operator to assign into model nodes.</li>
</ul>
<p>Note that NIMBLE does not allow variables to change dimensions. Model nodes are the same, and indeed are more restricted because they can’t change sizes. In addition, NIMBLE distinguishes between scalars and vectors of length 1. These rules, and ways to handle them correctly, are illustrated in the following code as well as in Section <a href="cha-RCfunctions.html#sec:how-nimble-handles">11.3</a>.</p>
<div class="sourceCode" id="cb423"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb423-1"><a href="cha-progr-with-models.html#cb423-1" aria-hidden="true" tabindex="-1"></a>code <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb423-2"><a href="cha-progr-with-models.html#cb423-2" aria-hidden="true" tabindex="-1"></a>    z <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>, <span class="at">sd =</span> sigma)</span>
<span id="cb423-3"><a href="cha-progr-with-models.html#cb423-3" aria-hidden="true" tabindex="-1"></a>    sigma <span class="sc">~</span> <span class="fu">dunif</span>(<span class="dv">0</span>, <span class="dv">10</span>)</span>
<span id="cb423-4"><a href="cha-progr-with-models.html#cb423-4" aria-hidden="true" tabindex="-1"></a>    y[<span class="dv">1</span><span class="sc">:</span>n] <span class="sc">~</span> <span class="fu">dmnorm</span>(zeroes[<span class="dv">1</span><span class="sc">:</span>n], <span class="at">cov =</span> C[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb423-5"><a href="cha-progr-with-models.html#cb423-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb423-6"><a href="cha-progr-with-models.html#cb423-6" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">5</span></span>
<span id="cb423-7"><a href="cha-progr-with-models.html#cb423-7" aria-hidden="true" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">nimbleModel</span>(code, <span class="at">constants =</span> <span class="fu">list</span>(<span class="at">n =</span> n, <span class="at">zeroes =</span> <span class="fu">rep</span>(<span class="dv">0</span>, n),</span>
<span id="cb423-8"><a href="cha-progr-with-models.html#cb423-8" aria-hidden="true" tabindex="-1"></a>                                        <span class="at">C =</span> <span class="fu">diag</span>(n)))</span>
<span id="cb423-9"><a href="cha-progr-with-models.html#cb423-9" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(m)</span>
<span id="cb423-10"><a href="cha-progr-with-models.html#cb423-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb423-11"><a href="cha-progr-with-models.html#cb423-11" aria-hidden="true" tabindex="-1"></a>nfGen <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb423-12"><a href="cha-progr-with-models.html#cb423-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(model) {</span>
<span id="cb423-13"><a href="cha-progr-with-models.html#cb423-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># node1 and node2 would typically be setup arguments, so they could</span></span>
<span id="cb423-14"><a href="cha-progr-with-models.html#cb423-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># have different values for different models.  We are assigning values</span></span>
<span id="cb423-15"><a href="cha-progr-with-models.html#cb423-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># here so the example is clearer.</span></span>
<span id="cb423-16"><a href="cha-progr-with-models.html#cb423-16" aria-hidden="true" tabindex="-1"></a>        node1 <span class="ot">&lt;-</span> <span class="st">&#39;sigma&#39;</span>            <span class="co"># a scalar node </span></span>
<span id="cb423-17"><a href="cha-progr-with-models.html#cb423-17" aria-hidden="true" tabindex="-1"></a>        node2 <span class="ot">&lt;-</span> <span class="st">&#39;y[1:5]&#39;</span>           <span class="co"># a vector node</span></span>
<span id="cb423-18"><a href="cha-progr-with-models.html#cb423-18" aria-hidden="true" tabindex="-1"></a>        notReallyANode <span class="ot">&lt;-</span> <span class="st">&#39;y[2:4]&#39;</span>  <span class="co"># y[2:4] allowed even though not a node!</span></span>
<span id="cb423-19"><a href="cha-progr-with-models.html#cb423-19" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb423-20"><a href="cha-progr-with-models.html#cb423-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">vals =</span> <span class="fu">double</span>(<span class="dv">1</span>)) {</span>
<span id="cb423-21"><a href="cha-progr-with-models.html#cb423-21" aria-hidden="true" tabindex="-1"></a>        tmp0 <span class="ot">&lt;-</span> model[[node1]]           <span class="co"># 1. tmp0 will be a scalar</span></span>
<span id="cb423-22"><a href="cha-progr-with-models.html#cb423-22" aria-hidden="true" tabindex="-1"></a>        tmp1 <span class="ot">&lt;-</span> model[[node2]]           <span class="co"># 2. tmp1 will be a vector</span></span>
<span id="cb423-23"><a href="cha-progr-with-models.html#cb423-23" aria-hidden="true" tabindex="-1"></a>        tmp2 <span class="ot">&lt;-</span> model[[node2]][<span class="dv">1</span>]        <span class="co"># 3. tmp2 will be a scalar</span></span>
<span id="cb423-24"><a href="cha-progr-with-models.html#cb423-24" aria-hidden="true" tabindex="-1"></a>        tmp3 <span class="ot">&lt;-</span> model[[notReallyANode]]  <span class="co"># 4. tmp3 will be a vector</span></span>
<span id="cb423-25"><a href="cha-progr-with-models.html#cb423-25" aria-hidden="true" tabindex="-1"></a>        tmp4 <span class="ot">&lt;-</span> model<span class="sc">$</span>y[<span class="dv">3</span><span class="sc">:</span><span class="dv">4</span>]      <span class="co"># 5. hard-coded access to a model variable</span></span>
<span id="cb423-26"><a href="cha-progr-with-models.html#cb423-26" aria-hidden="true" tabindex="-1"></a>        <span class="co"># 6. node1 is scalar so can be assigned a scalar:</span></span>
<span id="cb423-27"><a href="cha-progr-with-models.html#cb423-27" aria-hidden="true" tabindex="-1"></a>        model[[node1]] <span class="ot">&lt;&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>) </span>
<span id="cb423-28"><a href="cha-progr-with-models.html#cb423-28" aria-hidden="true" tabindex="-1"></a>        model[[node2]][<span class="dv">1</span>] <span class="ot">&lt;&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>) </span>
<span id="cb423-29"><a href="cha-progr-with-models.html#cb423-29" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># 7. an element of node2 can be assigned a scalar </span></span>
<span id="cb423-30"><a href="cha-progr-with-models.html#cb423-30" aria-hidden="true" tabindex="-1"></a>        model[[node2]] <span class="ot">&lt;&lt;-</span> <span class="fu">runif</span>(<span class="fu">length</span>(model[[node2]]))</span>
<span id="cb423-31"><a href="cha-progr-with-models.html#cb423-31" aria-hidden="true" tabindex="-1"></a>                 <span class="co"># 8. a vector can be assigned to the vector node2</span></span>
<span id="cb423-32"><a href="cha-progr-with-models.html#cb423-32" aria-hidden="true" tabindex="-1"></a>        model[[node2]][<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="ot">&lt;&lt;-</span> vals[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] </span>
<span id="cb423-33"><a href="cha-progr-with-models.html#cb423-33" aria-hidden="true" tabindex="-1"></a>             <span class="co"># elements of node2 can be indexed as needed</span></span>
<span id="cb423-34"><a href="cha-progr-with-models.html#cb423-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">1</span>))</span>
<span id="cb423-35"><a href="cha-progr-with-models.html#cb423-35" aria-hidden="true" tabindex="-1"></a>        out <span class="ot">&lt;-</span> model[[node2]] <span class="co"># we can return a vector   </span></span>
<span id="cb423-36"><a href="cha-progr-with-models.html#cb423-36" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(out)</span>
<span id="cb423-37"><a href="cha-progr-with-models.html#cb423-37" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb423-38"><a href="cha-progr-with-models.html#cb423-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb423-39"><a href="cha-progr-with-models.html#cb423-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb423-40"><a href="cha-progr-with-models.html#cb423-40" aria-hidden="true" tabindex="-1"></a>Rnf <span class="ot">&lt;-</span> <span class="fu">nfGen</span>(m)</span>
<span id="cb423-41"><a href="cha-progr-with-models.html#cb423-41" aria-hidden="true" tabindex="-1"></a>Cnf <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(Rnf)</span>
<span id="cb423-42"><a href="cha-progr-with-models.html#cb423-42" aria-hidden="true" tabindex="-1"></a>Cnf<span class="sc">$</span><span class="fu">run</span>(<span class="fu">rnorm</span>(<span class="dv">10</span>))</span></code></pre></div>
<pre><code>## [1]  0.474092599  1.193691666 -0.116395472  0.627634118  0.005961335</code></pre>
<p>Use of <code>[[ ]]</code> allows one to programmatically access a node based on a character variable containing the node name; this character variable would generally be set in setup code. In contrast, use of <code>$</code> hard codes the variable name and would not generally be suitable for nimbleFunctions intended for use with arbitrary models.</p>
</div>
<div id="sec:getting-setting-more" class="section level4 hasAnchor" number="15.4.2.2">
<h4><span class="header-section-number">15.4.2.2</span> Getting and setting more than one model node or variable at a time using <code>values</code><a href="cha-progr-with-models.html#sec:getting-setting-more" class="anchor-section" aria-label="Anchor link to header"></a></h4>
<p>Sometimes it is useful to set a collection of nodes or variables at
one time. For example, one might want a nimbleFunction that will
serve as the objective function for an optimizer. The input to the
nimbleFunction would be a vector, which should be used to fill a
collection of nodes in the model before calculating their log
probabilities. This can be done using <code>values</code>:</p>
<div class="sourceCode" id="cb425"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb425-1"><a href="cha-progr-with-models.html#cb425-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get values from a set of model nodes into a vector</span></span>
<span id="cb425-2"><a href="cha-progr-with-models.html#cb425-2" aria-hidden="true" tabindex="-1"></a>P <span class="ot">&lt;-</span> <span class="fu">values</span>(model, nodes)</span>
<span id="cb425-3"><a href="cha-progr-with-models.html#cb425-3" aria-hidden="true" tabindex="-1"></a><span class="co"># or put values from a vector into a set of model nodes</span></span>
<span id="cb425-4"><a href="cha-progr-with-models.html#cb425-4" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(model, nodes) <span class="ot">&lt;-</span> P</span></code></pre></div>
<p>where the first line would assign the collection of values from <code>nodes</code>
into <code>P</code>, and the second would do the inverse. In both cases, values
from nodes with two or more dimensions are flattened into a vector in
column-wise order.</p>
<p><code>values(model, nodes)</code> may be used as a
vector in other expressions, e.g.,</p>
<div class="sourceCode" id="cb426"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb426-1"><a href="cha-progr-with-models.html#cb426-1" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> A <span class="sc">%*%</span> <span class="fu">values</span>(model, nodes) <span class="sc">+</span> b</span></code></pre></div>
<p>One can also index elements of nodes in the argument to values, in the same manner as discussed for <code>calculate</code> and related functions in Section <a href="cha-progr-with-models.html#sec:driv-models:-calc">15.4.1</a>.</p>
<p>Note again the potential for confusion between scalars and vectors of
length 1. <code>values</code> returns a vector and expects a vector when used
on the left-hand side of an assignment. If only a single value is
being assigned, it must be a vector of length 1, not a scalar. This
can be achieved by wrapping a scalar in <code>c()</code> when necessary.
For example:</p>
<div class="sourceCode" id="cb427"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb427-1"><a href="cha-progr-with-models.html#cb427-1" aria-hidden="true" tabindex="-1"></a><span class="co"># c(rnorm(1)) creates vector of length one:</span></span>
<span id="cb427-2"><a href="cha-progr-with-models.html#cb427-2" aria-hidden="true" tabindex="-1"></a><span class="fu">values</span>(model, nodes[<span class="dv">1</span>]) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>)) </span>
<span id="cb427-3"><a href="cha-progr-with-models.html#cb427-3" aria-hidden="true" tabindex="-1"></a><span class="co"># won&#39;t compile because rnorm(1) is a scalar</span></span>
<span id="cb427-4"><a href="cha-progr-with-models.html#cb427-4" aria-hidden="true" tabindex="-1"></a><span class="co"># values(model, nodes[1]) &lt;- rnorm(1)  </span></span>
<span id="cb427-5"><a href="cha-progr-with-models.html#cb427-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb427-6"><a href="cha-progr-with-models.html#cb427-6" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">values</span>(model, nodes[<span class="dv">1</span>]) <span class="co"># out is a vector</span></span>
<span id="cb427-7"><a href="cha-progr-with-models.html#cb427-7" aria-hidden="true" tabindex="-1"></a>out2 <span class="ot">&lt;-</span> <span class="fu">values</span>(model, nodes[<span class="dv">1</span>])[<span class="dv">1</span>] <span class="co"># out2 is a scalar</span></span></code></pre></div>
</div>
</div>
<div id="getting-parameter-values-and-node-bounds" class="section level3 hasAnchor" number="15.4.3">
<h3><span class="header-section-number">15.4.3</span> Getting parameter values and node bounds<a href="cha-progr-with-models.html#getting-parameter-values-and-node-bounds" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Sections <a href="cha-using-models.html#sec:getParam">13.2.3</a>-<a href="cha-using-models.html#sec:getBound">13.2.4</a> describe how to get the parameter values for a node and the range (bounds) of possible values for the node using <code>getParam</code> and <code>getBound</code>. Both of these can be used in run code.</p>
</div>
<div id="sec:access-model-modelv" class="section level3 hasAnchor" number="15.4.4">
<h3><span class="header-section-number">15.4.4</span> Using modelValues objects<a href="cha-progr-with-models.html#sec:access-model-modelv" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The <code>modelValues</code> structure was introduced in Section
<a href="cha-data-structures.html#sec:modelValues-struct">14.1</a>. Inside nimbleFunctions, modelValues are
designed to easily save values from a model object during the running
of a nimbleFunction. A modelValues object used in run code
must always exist in the setup code, either by passing it in as a
setup argument or creating it in the setup code.</p>
<p>To illustrate this, we will create a nimbleFunction for computing
importance weights for importance sampling. This function will use two
modelValues objects. <code>propModelValues</code> will contain a set of
values simulated from the importance sampling distribution and a field <code>propLL</code>
for their log
probabilities (densities). <code>savedWeights</code> will contain the
difference in log probability (density) between the model and the
<code>propLL</code> value provided for each set of values.</p>
<div class="sourceCode" id="cb428"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb428-1"><a href="cha-progr-with-models.html#cb428-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Accepting modelValues as a setup argument</span></span>
<span id="cb428-2"><a href="cha-progr-with-models.html#cb428-2" aria-hidden="true" tabindex="-1"></a>swConf <span class="ot">&lt;-</span> <span class="fu">modelValuesConf</span>(<span class="at">vars =</span> <span class="st">&quot;w&quot;</span>,</span>
<span id="cb428-3"><a href="cha-progr-with-models.html#cb428-3" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">types =</span> <span class="st">&quot;double&quot;</span>,</span>
<span id="cb428-4"><a href="cha-progr-with-models.html#cb428-4" aria-hidden="true" tabindex="-1"></a>                                    <span class="at">sizes =</span> <span class="dv">1</span>)</span>
<span id="cb428-5"><a href="cha-progr-with-models.html#cb428-5" aria-hidden="true" tabindex="-1"></a>setup <span class="ot">=</span> <span class="cf">function</span>(propModelValues, model, savedWeightsConf){</span>
<span id="cb428-6"><a href="cha-progr-with-models.html#cb428-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Building a modelValues in the setup function </span></span>
<span id="cb428-7"><a href="cha-progr-with-models.html#cb428-7" aria-hidden="true" tabindex="-1"></a>    savedWeights <span class="ot">&lt;-</span> <span class="fu">modelValues</span>(<span class="at">conf =</span> savedWeightsConf)</span>
<span id="cb428-8"><a href="cha-progr-with-models.html#cb428-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># List of nodes to be used in run function</span></span>
<span id="cb428-9"><a href="cha-progr-with-models.html#cb428-9" aria-hidden="true" tabindex="-1"></a>    modelNodes <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">getNodeNames</span>(<span class="at">stochOnly =</span> <span class="cn">TRUE</span>,</span>
<span id="cb428-10"><a href="cha-progr-with-models.html#cb428-10" aria-hidden="true" tabindex="-1"></a>                                     <span class="at">includeData =</span> <span class="cn">FALSE</span>)</span>
<span id="cb428-11"><a href="cha-progr-with-models.html#cb428-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>The simplest way to pass values back and forth between models and
modelValues inside of a nimbleFunction is with <code>copy</code>, which
has the synonym <code>nimCopy</code>. See <code>help(nimCopy)</code> for argument details.
<!--- % This takes arguments  
  %% 
 %   1.[`from`, `to`] which can either be models or modelValues 
  %%   1.[`row`, `rowTo`] which refers to the rows of a
 %   modelValues object, if either `from` or `to` is a 
  %%   modelValues. If `rowTo` is omitted, it is assumed to be equal to `row` if necessary.
 %     1.[`nodes`, `nodesTo`] which is a vector of the names of the nodes 
  %%     to be copied.  The node names will be expanded when variable names are provided.  If
 %     `nodesTo` is omitted it will be set equal to `nodes`. 
  %% 
   TODO: CHECK THESE USAGES --></p>
<p>Alternatively, the values may be accessed via indexing of individual
rows, using the notation <code>mv[var, i]</code>, where <code>mv</code> is a
modelValues object, <code>var</code> is a variable name (not a node name),
and <code>i</code> is a row number. Likewise, the <code>getsize</code> and
<code>resize</code> functions can be used as discussed in Section <a href="cha-data-structures.html#sec:modelValues-struct">14.1</a>. However the function
<code>as.matrix</code> does not work in run code.</p>
<p>Here is a run function to use these modelValues:</p>
<div class="sourceCode" id="cb429"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb429-1"><a href="cha-progr-with-models.html#cb429-1" aria-hidden="true" tabindex="-1"></a>run <span class="ot">=</span> <span class="cf">function</span>(){</span>
<span id="cb429-2"><a href="cha-progr-with-models.html#cb429-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># gets the number of rows of propSamples</span></span>
<span id="cb429-3"><a href="cha-progr-with-models.html#cb429-3" aria-hidden="true" tabindex="-1"></a>    m <span class="ot">&lt;-</span> <span class="fu">getsize</span>(propModelValues)</span>
<span id="cb429-4"><a href="cha-progr-with-models.html#cb429-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb429-5"><a href="cha-progr-with-models.html#cb429-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># resized savedWeights to have the proper rows</span></span>
<span id="cb429-6"><a href="cha-progr-with-models.html#cb429-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">resize</span>(savedWeights, m)</span>
<span id="cb429-7"><a href="cha-progr-with-models.html#cb429-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m){</span>
<span id="cb429-8"><a href="cha-progr-with-models.html#cb429-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Copying from propSamples to model. </span></span>
<span id="cb429-9"><a href="cha-progr-with-models.html#cb429-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Node names of propSamples and model must match!</span></span>
<span id="cb429-10"><a href="cha-progr-with-models.html#cb429-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">nimCopy</span>(<span class="at">from =</span> propModelValues, <span class="at">to =</span> model, <span class="at">row =</span> i,</span>
<span id="cb429-11"><a href="cha-progr-with-models.html#cb429-11" aria-hidden="true" tabindex="-1"></a>                <span class="at">nodes =</span> modelNodes, <span class="at">logProb =</span> <span class="cn">FALSE</span>)</span>
<span id="cb429-12"><a href="cha-progr-with-models.html#cb429-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># calculates the log likelihood of the model</span></span>
<span id="cb429-13"><a href="cha-progr-with-models.html#cb429-13" aria-hidden="true" tabindex="-1"></a>        targLL <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb429-14"><a href="cha-progr-with-models.html#cb429-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># retreaves the saved log likelihood from the proposed model</span></span>
<span id="cb429-15"><a href="cha-progr-with-models.html#cb429-15" aria-hidden="true" tabindex="-1"></a>        propLL <span class="ot">&lt;-</span> propModelValues[<span class="st">&quot;propLL&quot;</span>,i][<span class="dv">1</span>]</span>
<span id="cb429-16"><a href="cha-progr-with-models.html#cb429-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># saves the importance weight for the i-th sample </span></span>
<span id="cb429-17"><a href="cha-progr-with-models.html#cb429-17" aria-hidden="true" tabindex="-1"></a>        savedWeights[<span class="st">&quot;w&quot;</span>, i][<span class="dv">1</span>] <span class="ot">&lt;&lt;-</span> <span class="fu">exp</span>(targLL <span class="sc">-</span> propLL)</span>
<span id="cb429-18"><a href="cha-progr-with-models.html#cb429-18" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb429-19"><a href="cha-progr-with-models.html#cb429-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># does not return anything</span></span>
<span id="cb429-20"><a href="cha-progr-with-models.html#cb429-20" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Once the nimbleFunction is built, the modelValues object can be accessed
using <code>$</code>, which is shown in more detail below. In
fact, since modelValues, like most NIMBLE objects, are reference class
objects, one can get a reference to them before the function is
executed and then use that reference afterwards.</p>
<div class="sourceCode" id="cb430"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb430-1"><a href="cha-progr-with-models.html#cb430-1" aria-hidden="true" tabindex="-1"></a><span class="co"># simple model and modelValues for example use with code above</span></span>
<span id="cb430-2"><a href="cha-progr-with-models.html#cb430-2" aria-hidden="true" tabindex="-1"></a>targetModelCode <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb430-3"><a href="cha-progr-with-models.html#cb430-3" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb430-4"><a href="cha-progr-with-models.html#cb430-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb430-5"><a href="cha-progr-with-models.html#cb430-5" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">1</span>)</span>
<span id="cb430-6"><a href="cha-progr-with-models.html#cb430-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb430-7"><a href="cha-progr-with-models.html#cb430-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-8"><a href="cha-progr-with-models.html#cb430-8" aria-hidden="true" tabindex="-1"></a><span class="co"># code for proposal model</span></span>
<span id="cb430-9"><a href="cha-progr-with-models.html#cb430-9" aria-hidden="true" tabindex="-1"></a>propModelCode <span class="ot">&lt;-</span> <span class="fu">nimbleCode</span>({</span>
<span id="cb430-10"><a href="cha-progr-with-models.html#cb430-10" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">2</span>)</span>
<span id="cb430-11"><a href="cha-progr-with-models.html#cb430-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>)</span>
<span id="cb430-12"><a href="cha-progr-with-models.html#cb430-12" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="sc">~</span> <span class="fu">dnorm</span>(<span class="dv">0</span>,<span class="dv">2</span>)</span>
<span id="cb430-13"><a href="cha-progr-with-models.html#cb430-13" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb430-14"><a href="cha-progr-with-models.html#cb430-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-15"><a href="cha-progr-with-models.html#cb430-15" aria-hidden="true" tabindex="-1"></a><span class="co"># creating the models</span></span>
<span id="cb430-16"><a href="cha-progr-with-models.html#cb430-16" aria-hidden="true" tabindex="-1"></a>targetModel <span class="ot">=</span> <span class="fu">nimbleModel</span>(targetModelCode, <span class="at">check =</span> <span class="cn">FALSE</span>)</span>
<span id="cb430-17"><a href="cha-progr-with-models.html#cb430-17" aria-hidden="true" tabindex="-1"></a>propModel <span class="ot">=</span> <span class="fu">nimbleModel</span>(propModelCode, <span class="at">check =</span> <span class="cn">FALSE</span>)</span>
<span id="cb430-18"><a href="cha-progr-with-models.html#cb430-18" aria-hidden="true" tabindex="-1"></a>cTargetModel <span class="ot">=</span> <span class="fu">compileNimble</span>(targetModel)</span>
<span id="cb430-19"><a href="cha-progr-with-models.html#cb430-19" aria-hidden="true" tabindex="-1"></a>cPropModel <span class="ot">=</span> <span class="fu">compileNimble</span>(propModel)</span>
<span id="cb430-20"><a href="cha-progr-with-models.html#cb430-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-21"><a href="cha-progr-with-models.html#cb430-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-22"><a href="cha-progr-with-models.html#cb430-22" aria-hidden="true" tabindex="-1"></a>sampleMVConf <span class="ot">=</span> <span class="fu">modelValuesConf</span>(<span class="at">vars =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;propLL&quot;</span>), </span>
<span id="cb430-23"><a href="cha-progr-with-models.html#cb430-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">types =</span> <span class="fu">c</span>(<span class="st">&quot;double&quot;</span>, <span class="st">&quot;double&quot;</span>, <span class="st">&quot;double&quot;</span>), </span>
<span id="cb430-24"><a href="cha-progr-with-models.html#cb430-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">sizes =</span> <span class="fu">list</span>(<span class="at">x =</span> <span class="dv">1</span>, <span class="at">y =</span> <span class="dv">4</span>, <span class="at">propLL =</span> <span class="dv">1</span>) )</span>
<span id="cb430-25"><a href="cha-progr-with-models.html#cb430-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-26"><a href="cha-progr-with-models.html#cb430-26" aria-hidden="true" tabindex="-1"></a>sampleMV <span class="ot">&lt;-</span> <span class="fu">modelValues</span>(sampleMVConf)</span>
<span id="cb430-27"><a href="cha-progr-with-models.html#cb430-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-28"><a href="cha-progr-with-models.html#cb430-28" aria-hidden="true" tabindex="-1"></a><span class="co">#   nimbleFunction for generating proposal sample</span></span>
<span id="cb430-29"><a href="cha-progr-with-models.html#cb430-29" aria-hidden="true" tabindex="-1"></a>PropSamp_Gen <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb430-30"><a href="cha-progr-with-models.html#cb430-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(mv, propModel){</span>
<span id="cb430-31"><a href="cha-progr-with-models.html#cb430-31" aria-hidden="true" tabindex="-1"></a>        nodeNames <span class="ot">&lt;-</span> propModel<span class="sc">$</span><span class="fu">getNodeNames</span>()</span>
<span id="cb430-32"><a href="cha-progr-with-models.html#cb430-32" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb430-33"><a href="cha-progr-with-models.html#cb430-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">m =</span> <span class="fu">integer</span>() ){</span>
<span id="cb430-34"><a href="cha-progr-with-models.html#cb430-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">resize</span>(mv, m)</span>
<span id="cb430-35"><a href="cha-progr-with-models.html#cb430-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>m){</span>
<span id="cb430-36"><a href="cha-progr-with-models.html#cb430-36" aria-hidden="true" tabindex="-1"></a>            propModel<span class="sc">$</span><span class="fu">simulate</span>()</span>
<span id="cb430-37"><a href="cha-progr-with-models.html#cb430-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">nimCopy</span>(<span class="at">from =</span> propModel, <span class="at">to =</span> mv, <span class="at">nodes =</span> nodeNames, <span class="at">row =</span> i)</span>
<span id="cb430-38"><a href="cha-progr-with-models.html#cb430-38" aria-hidden="true" tabindex="-1"></a>            mv[<span class="st">&quot;propLL&quot;</span>, i][<span class="dv">1</span>] <span class="ot">&lt;&lt;-</span> propModel<span class="sc">$</span><span class="fu">calculate</span>()</span>
<span id="cb430-39"><a href="cha-progr-with-models.html#cb430-39" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb430-40"><a href="cha-progr-with-models.html#cb430-40" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb430-41"><a href="cha-progr-with-models.html#cb430-41" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb430-42"><a href="cha-progr-with-models.html#cb430-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-43"><a href="cha-progr-with-models.html#cb430-43" aria-hidden="true" tabindex="-1"></a><span class="co"># nimbleFunction for calculating importance weights</span></span>
<span id="cb430-44"><a href="cha-progr-with-models.html#cb430-44" aria-hidden="true" tabindex="-1"></a><span class="co"># uses setup and run functions as defined in previous code chunk</span></span>
<span id="cb430-45"><a href="cha-progr-with-models.html#cb430-45" aria-hidden="true" tabindex="-1"></a>impWeights_Gen <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(<span class="at">setup =</span> setup,</span>
<span id="cb430-46"><a href="cha-progr-with-models.html#cb430-46" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">run =</span> run)</span>
<span id="cb430-47"><a href="cha-progr-with-models.html#cb430-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb430-48"><a href="cha-progr-with-models.html#cb430-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-49"><a href="cha-progr-with-models.html#cb430-49" aria-hidden="true" tabindex="-1"></a><span class="co"># making instances of nimbleFunctions</span></span>
<span id="cb430-50"><a href="cha-progr-with-models.html#cb430-50" aria-hidden="true" tabindex="-1"></a><span class="co"># note that both functions share the same modelValues object</span></span>
<span id="cb430-51"><a href="cha-progr-with-models.html#cb430-51" aria-hidden="true" tabindex="-1"></a>RPropSamp <span class="ot">&lt;-</span> <span class="fu">PropSamp_Gen</span>(sampleMV, propModel)</span>
<span id="cb430-52"><a href="cha-progr-with-models.html#cb430-52" aria-hidden="true" tabindex="-1"></a>RImpWeights <span class="ot">&lt;-</span> <span class="fu">impWeights_Gen</span>(sampleMV, targetModel, swConf)</span>
<span id="cb430-53"><a href="cha-progr-with-models.html#cb430-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-54"><a href="cha-progr-with-models.html#cb430-54" aria-hidden="true" tabindex="-1"></a><span class="co"># compiling </span></span>
<span id="cb430-55"><a href="cha-progr-with-models.html#cb430-55" aria-hidden="true" tabindex="-1"></a>CPropSamp <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(RPropSamp, <span class="at">project =</span> propModel)</span>
<span id="cb430-56"><a href="cha-progr-with-models.html#cb430-56" aria-hidden="true" tabindex="-1"></a>CImpWeights <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(RImpWeights, <span class="at">project =</span> targetModel)</span>
<span id="cb430-57"><a href="cha-progr-with-models.html#cb430-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-58"><a href="cha-progr-with-models.html#cb430-58" aria-hidden="true" tabindex="-1"></a><span class="co"># generating and saving proposal sample of size 10</span></span>
<span id="cb430-59"><a href="cha-progr-with-models.html#cb430-59" aria-hidden="true" tabindex="-1"></a>CPropSamp<span class="sc">$</span><span class="fu">run</span>(<span class="dv">10</span>)</span>
<span id="cb430-60"><a href="cha-progr-with-models.html#cb430-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-61"><a href="cha-progr-with-models.html#cb430-61" aria-hidden="true" tabindex="-1"></a><span class="co"># calculating the importance weights and saving to mv</span></span>
<span id="cb430-62"><a href="cha-progr-with-models.html#cb430-62" aria-hidden="true" tabindex="-1"></a>CImpWeights<span class="sc">$</span><span class="fu">run</span>()</span>
<span id="cb430-63"><a href="cha-progr-with-models.html#cb430-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-64"><a href="cha-progr-with-models.html#cb430-64" aria-hidden="true" tabindex="-1"></a><span class="co"># retrieving the modelValues objects</span></span>
<span id="cb430-65"><a href="cha-progr-with-models.html#cb430-65" aria-hidden="true" tabindex="-1"></a><span class="co"># extracted objects are C-based modelValues objects</span></span>
<span id="cb430-66"><a href="cha-progr-with-models.html#cb430-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-67"><a href="cha-progr-with-models.html#cb430-67" aria-hidden="true" tabindex="-1"></a>savedPropSamp_1 <span class="ot">=</span> CImpWeights<span class="sc">$</span>propModelValues</span>
<span id="cb430-68"><a href="cha-progr-with-models.html#cb430-68" aria-hidden="true" tabindex="-1"></a>savedPropSamp_2 <span class="ot">=</span> CPropSamp<span class="sc">$</span>mv</span>
<span id="cb430-69"><a href="cha-progr-with-models.html#cb430-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-70"><a href="cha-progr-with-models.html#cb430-70" aria-hidden="true" tabindex="-1"></a><span class="co"># Subtle note: savedPropSamp_1 and savedPropSamp_2</span></span>
<span id="cb430-71"><a href="cha-progr-with-models.html#cb430-71" aria-hidden="true" tabindex="-1"></a><span class="co"># both provide interface to the same compiled modelValues objects!</span></span>
<span id="cb430-72"><a href="cha-progr-with-models.html#cb430-72" aria-hidden="true" tabindex="-1"></a><span class="co"># This is because they were both built from sampleMV.</span></span>
<span id="cb430-73"><a href="cha-progr-with-models.html#cb430-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb430-74"><a href="cha-progr-with-models.html#cb430-74" aria-hidden="true" tabindex="-1"></a>savedPropSamp_1[<span class="st">&quot;x&quot;</span>,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] -0.3998956</code></pre>
<div class="sourceCode" id="cb432"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb432-1"><a href="cha-progr-with-models.html#cb432-1" aria-hidden="true" tabindex="-1"></a>savedPropSamp_2[<span class="st">&quot;x&quot;</span>,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] -0.3998956</code></pre>
<div class="sourceCode" id="cb434"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb434-1"><a href="cha-progr-with-models.html#cb434-1" aria-hidden="true" tabindex="-1"></a>savedPropSamp_1[<span class="st">&quot;x&quot;</span>,<span class="dv">1</span>] <span class="ot">&lt;-</span> <span class="dv">0</span> <span class="co"># example of directly setting a value</span></span>
<span id="cb434-2"><a href="cha-progr-with-models.html#cb434-2" aria-hidden="true" tabindex="-1"></a>savedPropSamp_2[<span class="st">&quot;x&quot;</span>,<span class="dv">1</span>]</span></code></pre></div>
<pre><code>## [1] 0</code></pre>
<div class="sourceCode" id="cb436"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb436-1"><a href="cha-progr-with-models.html#cb436-1" aria-hidden="true" tabindex="-1"></a><span class="co"># viewing the saved importance weights</span></span>
<span id="cb436-2"><a href="cha-progr-with-models.html#cb436-2" aria-hidden="true" tabindex="-1"></a>savedWeights <span class="ot">&lt;-</span> CImpWeights<span class="sc">$</span>savedWeights</span>
<span id="cb436-3"><a href="cha-progr-with-models.html#cb436-3" aria-hidden="true" tabindex="-1"></a><span class="fu">unlist</span>(savedWeights[[<span class="st">&quot;w&quot;</span>]])</span></code></pre></div>
<pre><code>##  [1] 0.2673310 1.3081190 0.9378951 0.5024644 1.7765357 3.5155732 0.3893390
##  [8] 0.5530012 0.5085069 2.3890876</code></pre>
<div class="sourceCode" id="cb438"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb438-1"><a href="cha-progr-with-models.html#cb438-1" aria-hidden="true" tabindex="-1"></a><span class="co"># viewing first 3 rows -- note that savedPropSsamp_1[&quot;x&quot;, 1] was altered </span></span>
<span id="cb438-2"><a href="cha-progr-with-models.html#cb438-2" aria-hidden="true" tabindex="-1"></a><span class="fu">as.matrix</span>(savedPropSamp_1)[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, ]</span></code></pre></div>
<pre><code>##      propLL[1]      x[1]       y[1]        y[2]       y[3]        y[4]
## [1,] -3.689026  0.000000  0.4941960  0.62275962 -0.1610471  0.09637918
## [2,] -6.864741  1.303486 -0.9937620 -0.03470697  0.5615520 -0.99986562
## [3,] -6.199326 -1.265670  0.9577035 -0.52875091 -0.7335897 -0.02557756</code></pre>
<p>Importance sampling could also be written using simple vectors for the
weights, but we illustrated putting them in a modelValues object along
with model variables.</p>
</div>
<div id="sec:using-model-variable" class="section level3 hasAnchor" number="15.4.5">
<h3><span class="header-section-number">15.4.5</span> Using model variables and modelValues in expressions<a href="cha-progr-with-models.html#sec:using-model-variable" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Each way of accessing a variable, node, or modelValues can be used amidst mathematical
expressions, including with indexing, or passed to another
nimbleFunction as an argument. For example, the following two
statements would be valid:</p>
<div class="sourceCode" id="cb440"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb440-1"><a href="cha-progr-with-models.html#cb440-1" aria-hidden="true" tabindex="-1"></a>model[[<span class="st">&quot;x[2:8, ]&quot;</span>]][<span class="dv">2</span><span class="sc">:</span><span class="dv">4</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>] <span class="sc">%*%</span> Z</span></code></pre></div>
<p>if Z is a vector or matrix, and</p>
<div class="sourceCode" id="cb441"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb441-1"><a href="cha-progr-with-models.html#cb441-1" aria-hidden="true" tabindex="-1"></a>C[<span class="dv">6</span><span class="sc">:</span><span class="dv">10</span>] <span class="ot">&lt;-</span> mv[v, i][<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, k] <span class="sc">+</span> B</span></code></pre></div>
<p>if B is a vector or matrix.</p>
<p>The NIMBLE language allows scalars, but models defined from BUGS code
are never created as purely
scalar nodes. Instead, a single node such as defined by <code>z ~ dnorm(0, 1)</code> is implemented as a vector of length 1, similar to R.
When using <code>z</code> via <code>model$z</code> or <code>model[["z"]]</code>, NIMBLE
will try to do the right thing by treating this as a scalar. In the
event of problems<a href="#fn33" class="footnote-ref" id="fnref33"><sup>33</sup></a>, a more explicit way to
access <code>z</code> is <code>model$z[1]</code> or <code>model[["z"]][1]</code>.</p>
</div>
<div id="sec:incl-other-meth" class="section level3 hasAnchor" number="15.4.6">
<h3><span class="header-section-number">15.4.6</span> Including other methods in a nimbleFunction<a href="cha-progr-with-models.html#sec:incl-other-meth" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Other methods can be included with the <code>methods</code> argument to
<code>nimbleFunction</code>. These methods can use the objects created in
setup code in just the same ways as the run function. In
fact, the run function is just a default main method name. Any method can then call another method.</p>
<div class="sourceCode" id="cb442"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb442-1"><a href="cha-progr-with-models.html#cb442-1" aria-hidden="true" tabindex="-1"></a>methodsDemo <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb442-2"><a href="cha-progr-with-models.html#cb442-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>() {sharedValue <span class="ot">&lt;-</span> <span class="dv">1</span>},</span>
<span id="cb442-3"><a href="cha-progr-with-models.html#cb442-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>(<span class="dv">1</span>)) {</span>
<span id="cb442-4"><a href="cha-progr-with-models.html#cb442-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&quot;sharedValues = &quot;</span>, sharedValue, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb442-5"><a href="cha-progr-with-models.html#cb442-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">increment</span>()</span>
<span id="cb442-6"><a href="cha-progr-with-models.html#cb442-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&quot;sharedValues = &quot;</span>, sharedValue, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb442-7"><a href="cha-progr-with-models.html#cb442-7" aria-hidden="true" tabindex="-1"></a>        A <span class="ot">&lt;-</span> <span class="fu">times</span>(<span class="dv">5</span>)</span>
<span id="cb442-8"><a href="cha-progr-with-models.html#cb442-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(A <span class="sc">*</span> x)</span>
<span id="cb442-9"><a href="cha-progr-with-models.html#cb442-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">1</span>))</span>
<span id="cb442-10"><a href="cha-progr-with-models.html#cb442-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb442-11"><a href="cha-progr-with-models.html#cb442-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb442-12"><a href="cha-progr-with-models.html#cb442-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">increment =</span> <span class="cf">function</span>() {</span>
<span id="cb442-13"><a href="cha-progr-with-models.html#cb442-13" aria-hidden="true" tabindex="-1"></a>            sharedValue <span class="ot">&lt;&lt;-</span> sharedValue <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb442-14"><a href="cha-progr-with-models.html#cb442-14" aria-hidden="true" tabindex="-1"></a>        },</span>
<span id="cb442-15"><a href="cha-progr-with-models.html#cb442-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">times =</span> <span class="cf">function</span>(<span class="at">factor =</span> <span class="fu">double</span>()) {</span>
<span id="cb442-16"><a href="cha-progr-with-models.html#cb442-16" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(factor <span class="sc">*</span> sharedValue)</span>
<span id="cb442-17"><a href="cha-progr-with-models.html#cb442-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">returnType</span>(<span class="fu">double</span>())</span>
<span id="cb442-18"><a href="cha-progr-with-models.html#cb442-18" aria-hidden="true" tabindex="-1"></a>        }))</span>
<span id="cb442-19"><a href="cha-progr-with-models.html#cb442-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb442-20"><a href="cha-progr-with-models.html#cb442-20" aria-hidden="true" tabindex="-1"></a>methodsDemo1 <span class="ot">&lt;-</span> <span class="fu">methodsDemo</span>()</span>
<span id="cb442-21"><a href="cha-progr-with-models.html#cb442-21" aria-hidden="true" tabindex="-1"></a>methodsDemo1<span class="sc">$</span><span class="fu">run</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## sharedValues = 1
## 
## sharedValues = 2</code></pre>
<pre><code>##  [1]  10  20  30  40  50  60  70  80  90 100</code></pre>
<div class="sourceCode" id="cb445"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb445-1"><a href="cha-progr-with-models.html#cb445-1" aria-hidden="true" tabindex="-1"></a>methodsDemo1<span class="sc">$</span>sharedValue <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb445-2"><a href="cha-progr-with-models.html#cb445-2" aria-hidden="true" tabindex="-1"></a>CmethodsDemo1 <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(methodsDemo1)</span>
<span id="cb445-3"><a href="cha-progr-with-models.html#cb445-3" aria-hidden="true" tabindex="-1"></a>CmethodsDemo1<span class="sc">$</span><span class="fu">run</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## sharedValues = 1
## 
## sharedValues = 2</code></pre>
<pre><code>##  [1]  10  20  30  40  50  60  70  80  90 100</code></pre>
</div>
<div id="sec:using-other-nimbl" class="section level3 hasAnchor" number="15.4.7">
<h3><span class="header-section-number">15.4.7</span> Using other nimbleFunctions<a href="cha-progr-with-models.html#sec:using-other-nimbl" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>One nimbleFunction can use another nimbleFunction that was passed to
it as a setup argument or was created in the setup function. This can
be an effective way to program. When a nimbleFunction needs to
access a setup variable or method of another nimbleFunction, use
<code>$</code>.</p>
<div class="sourceCode" id="cb448"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb448-1"><a href="cha-progr-with-models.html#cb448-1" aria-hidden="true" tabindex="-1"></a>usePreviousDemo <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb448-2"><a href="cha-progr-with-models.html#cb448-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(initialSharedValue) {</span>
<span id="cb448-3"><a href="cha-progr-with-models.html#cb448-3" aria-hidden="true" tabindex="-1"></a>        myMethodsDemo <span class="ot">&lt;-</span> <span class="fu">methodsDemo</span>()</span>
<span id="cb448-4"><a href="cha-progr-with-models.html#cb448-4" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb448-5"><a href="cha-progr-with-models.html#cb448-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>(<span class="dv">1</span>)) {</span>
<span id="cb448-6"><a href="cha-progr-with-models.html#cb448-6" aria-hidden="true" tabindex="-1"></a>        myMethodsDemo<span class="sc">$</span>sharedValue <span class="ot">&lt;&lt;-</span> initialSharedValue</span>
<span id="cb448-7"><a href="cha-progr-with-models.html#cb448-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(myMethodsDemo<span class="sc">$</span>sharedValue)</span>
<span id="cb448-8"><a href="cha-progr-with-models.html#cb448-8" aria-hidden="true" tabindex="-1"></a>        A <span class="ot">&lt;-</span> myMethodsDemo<span class="sc">$</span><span class="fu">run</span>(x[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span>
<span id="cb448-9"><a href="cha-progr-with-models.html#cb448-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(A)</span>
<span id="cb448-10"><a href="cha-progr-with-models.html#cb448-10" aria-hidden="true" tabindex="-1"></a>        B <span class="ot">&lt;-</span> myMethodsDemo<span class="sc">$</span><span class="fu">times</span>(<span class="dv">10</span>)</span>
<span id="cb448-11"><a href="cha-progr-with-models.html#cb448-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(B)</span>
<span id="cb448-12"><a href="cha-progr-with-models.html#cb448-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">returnType</span>(<span class="fu">double</span>())</span>
<span id="cb448-13"><a href="cha-progr-with-models.html#cb448-13" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb448-14"><a href="cha-progr-with-models.html#cb448-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb448-15"><a href="cha-progr-with-models.html#cb448-15" aria-hidden="true" tabindex="-1"></a>usePreviousDemo1 <span class="ot">&lt;-</span> <span class="fu">usePreviousDemo</span>(<span class="dv">2</span>)</span>
<span id="cb448-16"><a href="cha-progr-with-models.html#cb448-16" aria-hidden="true" tabindex="-1"></a>usePreviousDemo1<span class="sc">$</span><span class="fu">run</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## 2
## sharedValues = 2
## 
## sharedValues = 3
## 
## 15 30 45 60 75</code></pre>
<pre><code>## [1] 30</code></pre>
<div class="sourceCode" id="cb451"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb451-1"><a href="cha-progr-with-models.html#cb451-1" aria-hidden="true" tabindex="-1"></a>CusePreviousDemo1 <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(usePreviousDemo1)</span>
<span id="cb451-2"><a href="cha-progr-with-models.html#cb451-2" aria-hidden="true" tabindex="-1"></a>CusePreviousDemo1<span class="sc">$</span><span class="fu">run</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">10</span>)</span></code></pre></div>
<pre><code>## 2
## sharedValues = 2
## 
## sharedValues = 3
## 
## 15
## 30
## 45
## 60
## 75</code></pre>
<pre><code>## [1] 30</code></pre>
<!---  CJP: doesn't seem to be an issue at the moment: Note that the output from the `print` calls in the compiled function match those from the uncompiled function when run in an R session.  It may not be shown here because this document is created with `knitr` and for some reason output printed from C++ does not make it into `knitr` output. -->
</div>
<div id="sec:virt-nimbl-nimbl" class="section level3 hasAnchor" number="15.4.8">
<h3><span class="header-section-number">15.4.8</span> Virtual nimbleFunctions and nimbleFunctionLists<a href="cha-progr-with-models.html#sec:virt-nimbl-nimbl" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Often it is useful for one nimbleFunction to have a list of other
nimbleFunctions, all of whose methods have the same arguments and return
types. For example, NIMBLE’s MCMC engine contains a list of samplers that
are each nimbleFunctions.</p>
<p>To make such a list, NIMBLE provides a way to declare the arguments
and return types of methods: virtual nimbleFunctions created by
<code>nimbleFunctionVirtual</code>. Other nimbleFunctions can inherit from
virtual nimbleFunctions, which in R is called ‘containing’ them.
Readers familiar with object oriented programming will recognize this
as a simple class inheritance system. In Version 1.1.0 it is limited to
simple, single-level inheritance.</p>
<p>Here is how it works:</p>
<div class="sourceCode" id="cb454"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb454-1"><a href="cha-progr-with-models.html#cb454-1" aria-hidden="true" tabindex="-1"></a>baseClass <span class="ot">&lt;-</span> <span class="fu">nimbleFunctionVirtual</span>(</span>
<span id="cb454-2"><a href="cha-progr-with-models.html#cb454-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>(<span class="dv">1</span>)) {<span class="fu">returnType</span>(<span class="fu">double</span>())},</span>
<span id="cb454-3"><a href="cha-progr-with-models.html#cb454-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb454-4"><a href="cha-progr-with-models.html#cb454-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">foo =</span> <span class="cf">function</span>() { <span class="fu">returnType</span>(<span class="fu">double</span>()) }</span>
<span id="cb454-5"><a href="cha-progr-with-models.html#cb454-5" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb454-6"><a href="cha-progr-with-models.html#cb454-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-7"><a href="cha-progr-with-models.html#cb454-7" aria-hidden="true" tabindex="-1"></a>derived1 <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb454-8"><a href="cha-progr-with-models.html#cb454-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">contains =</span> baseClass,</span>
<span id="cb454-9"><a href="cha-progr-with-models.html#cb454-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(){},</span>
<span id="cb454-10"><a href="cha-progr-with-models.html#cb454-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>(<span class="dv">1</span>)) {</span>
<span id="cb454-11"><a href="cha-progr-with-models.html#cb454-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&quot;run 1&quot;</span>)</span>
<span id="cb454-12"><a href="cha-progr-with-models.html#cb454-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">sum</span>(x))</span>
<span id="cb454-13"><a href="cha-progr-with-models.html#cb454-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">returnType</span>(<span class="fu">double</span>())</span>
<span id="cb454-14"><a href="cha-progr-with-models.html#cb454-14" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb454-15"><a href="cha-progr-with-models.html#cb454-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb454-16"><a href="cha-progr-with-models.html#cb454-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">foo =</span> <span class="cf">function</span>() {</span>
<span id="cb454-17"><a href="cha-progr-with-models.html#cb454-17" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>(<span class="st">&quot;foo 1&quot;</span>)</span>
<span id="cb454-18"><a href="cha-progr-with-models.html#cb454-18" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">rnorm</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb454-19"><a href="cha-progr-with-models.html#cb454-19" aria-hidden="true" tabindex="-1"></a>            <span class="fu">returnType</span>(<span class="fu">double</span>())</span>
<span id="cb454-20"><a href="cha-progr-with-models.html#cb454-20" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb454-21"><a href="cha-progr-with-models.html#cb454-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb454-22"><a href="cha-progr-with-models.html#cb454-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb454-23"><a href="cha-progr-with-models.html#cb454-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-24"><a href="cha-progr-with-models.html#cb454-24" aria-hidden="true" tabindex="-1"></a>derived2 <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb454-25"><a href="cha-progr-with-models.html#cb454-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">contains =</span> baseClass,</span>
<span id="cb454-26"><a href="cha-progr-with-models.html#cb454-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(){},</span>
<span id="cb454-27"><a href="cha-progr-with-models.html#cb454-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>(<span class="dv">1</span>)) {</span>
<span id="cb454-28"><a href="cha-progr-with-models.html#cb454-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&quot;run 2&quot;</span>)</span>
<span id="cb454-29"><a href="cha-progr-with-models.html#cb454-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">prod</span>(x))</span>
<span id="cb454-30"><a href="cha-progr-with-models.html#cb454-30" aria-hidden="true" tabindex="-1"></a>        <span class="fu">returnType</span>(<span class="fu">double</span>())</span>
<span id="cb454-31"><a href="cha-progr-with-models.html#cb454-31" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb454-32"><a href="cha-progr-with-models.html#cb454-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(</span>
<span id="cb454-33"><a href="cha-progr-with-models.html#cb454-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">foo =</span> <span class="cf">function</span>() {</span>
<span id="cb454-34"><a href="cha-progr-with-models.html#cb454-34" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>(<span class="st">&quot;foo 2&quot;</span>)</span>
<span id="cb454-35"><a href="cha-progr-with-models.html#cb454-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">100</span>, <span class="dv">200</span>))</span>
<span id="cb454-36"><a href="cha-progr-with-models.html#cb454-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">returnType</span>(<span class="fu">double</span>())</span>
<span id="cb454-37"><a href="cha-progr-with-models.html#cb454-37" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb454-38"><a href="cha-progr-with-models.html#cb454-38" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb454-39"><a href="cha-progr-with-models.html#cb454-39" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb454-40"><a href="cha-progr-with-models.html#cb454-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-41"><a href="cha-progr-with-models.html#cb454-41" aria-hidden="true" tabindex="-1"></a>useThem <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb454-42"><a href="cha-progr-with-models.html#cb454-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>() {</span>
<span id="cb454-43"><a href="cha-progr-with-models.html#cb454-43" aria-hidden="true" tabindex="-1"></a>        nfl <span class="ot">&lt;-</span> <span class="fu">nimbleFunctionList</span>(baseClass)</span>
<span id="cb454-44"><a href="cha-progr-with-models.html#cb454-44" aria-hidden="true" tabindex="-1"></a>        nfl[[<span class="dv">1</span>]] <span class="ot">&lt;-</span> <span class="fu">derived1</span>()</span>
<span id="cb454-45"><a href="cha-progr-with-models.html#cb454-45" aria-hidden="true" tabindex="-1"></a>        nfl[[<span class="dv">2</span>]] <span class="ot">&lt;-</span> <span class="fu">derived2</span>()</span>
<span id="cb454-46"><a href="cha-progr-with-models.html#cb454-46" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb454-47"><a href="cha-progr-with-models.html#cb454-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">x =</span> <span class="fu">double</span>(<span class="dv">1</span>)) {</span>
<span id="cb454-48"><a href="cha-progr-with-models.html#cb454-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(nfl)) {</span>
<span id="cb454-49"><a href="cha-progr-with-models.html#cb454-49" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>( nfl[[i]]<span class="sc">$</span><span class="fu">run</span>(x) )</span>
<span id="cb454-50"><a href="cha-progr-with-models.html#cb454-50" aria-hidden="true" tabindex="-1"></a>            <span class="fu">print</span>( nfl[[i]]<span class="sc">$</span><span class="fu">foo</span>() )</span>
<span id="cb454-51"><a href="cha-progr-with-models.html#cb454-51" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb454-52"><a href="cha-progr-with-models.html#cb454-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb454-53"><a href="cha-progr-with-models.html#cb454-53" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb454-54"><a href="cha-progr-with-models.html#cb454-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb454-55"><a href="cha-progr-with-models.html#cb454-55" aria-hidden="true" tabindex="-1"></a>useThem1 <span class="ot">&lt;-</span> <span class="fu">useThem</span>()</span>
<span id="cb454-56"><a href="cha-progr-with-models.html#cb454-56" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb454-57"><a href="cha-progr-with-models.html#cb454-57" aria-hidden="true" tabindex="-1"></a>useThem1<span class="sc">$</span><span class="fu">run</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)    </span></code></pre></div>
<pre><code>## run 1
## 15
## foo 1
## -0.6264538
## run 2
## 120
## foo 2
## 157.2853</code></pre>
<div class="sourceCode" id="cb456"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb456-1"><a href="cha-progr-with-models.html#cb456-1" aria-hidden="true" tabindex="-1"></a>CuseThem1 <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(useThem1)</span>
<span id="cb456-2"><a href="cha-progr-with-models.html#cb456-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1</span>)</span>
<span id="cb456-3"><a href="cha-progr-with-models.html#cb456-3" aria-hidden="true" tabindex="-1"></a>CuseThem1<span class="sc">$</span><span class="fu">run</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span></code></pre></div>
<pre><code>## run 1
## 15
## foo 1
## -0.626454
## run 2
## 120
## foo 2
## 157.285</code></pre>
<p>One can also use <code>seq_along</code> with nimbleFunctionLists (and only with nimbleFunctionLists). As in R, <code>seq_along(myFunList)</code> is equivalent to
<code>1:length(myFunList)</code> if the length of <code>myFunList</code> is greater
than zero. It is an empty sequence if the length is zero.</p>
<p>Virtual nimbleFunctions cannot define setup values to be inherited.</p>
</div>
<div id="character-objects" class="section level3 hasAnchor" number="15.4.9">
<h3><span class="header-section-number">15.4.9</span> Character objects<a href="cha-progr-with-models.html#character-objects" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>NIMBLE provides limited uses of character objects in run code.
Character vectors created in setup code will be available in
run code, but the only thing you can really do with them is
include them in a <code>print</code> or <code>stop</code> statement.</p>
<p>Note that character vectors of model node and variable names are
processed during compilation. For example, in <code>model[[node]]</code>, <code>node</code>
may be a character object, and the NIMBLE compiler processes this
differently than <code>print("The node name was ", node)</code>. In the
former, the NIMBLE compiler sets up a C++ pointer directly to the
<code>node</code> in the <code>model</code>, so that the character content of
<code>node</code> is never needed in C++. In the latter, <code>node</code> is used as
a C++ string and therefore is needed in C++.</p>
</div>
<div id="sec:user-defined-data" class="section level3 hasAnchor" number="15.4.10">
<h3><span class="header-section-number">15.4.10</span> User-defined data structures<a href="cha-progr-with-models.html#sec:user-defined-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Before the introduction of nimbleLists in Version 0.6-4, NIMBLE did not explicitly have user-defined data structures. An alternative way to create a data structure in NIMBLE is to use nimbleFunctions to achieve a similar effect. To do so, one can define setup code with whatever variables are wanted and ensure
they are compiled using <code>setupOutputs</code>. Here is an example:</p>
<div class="sourceCode" id="cb458"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb458-1"><a href="cha-progr-with-models.html#cb458-1" aria-hidden="true" tabindex="-1"></a>dataNF <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb458-2"><a href="cha-progr-with-models.html#cb458-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>() {</span>
<span id="cb458-3"><a href="cha-progr-with-models.html#cb458-3" aria-hidden="true" tabindex="-1"></a>        X <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb458-4"><a href="cha-progr-with-models.html#cb458-4" aria-hidden="true" tabindex="-1"></a>        Y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb458-5"><a href="cha-progr-with-models.html#cb458-5" aria-hidden="true" tabindex="-1"></a>        Z <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">as.numeric</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">4</span>), <span class="at">nrow =</span> <span class="dv">2</span>) </span>
<span id="cb458-6"><a href="cha-progr-with-models.html#cb458-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">setupOutputs</span>(X, Y, Z)</span>
<span id="cb458-7"><a href="cha-progr-with-models.html#cb458-7" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb458-8"><a href="cha-progr-with-models.html#cb458-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-9"><a href="cha-progr-with-models.html#cb458-9" aria-hidden="true" tabindex="-1"></a>useDataNF <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb458-10"><a href="cha-progr-with-models.html#cb458-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(myDataNF) {},</span>
<span id="cb458-11"><a href="cha-progr-with-models.html#cb458-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">newX =</span> <span class="fu">double</span>(), <span class="at">newY =</span> <span class="fu">double</span>(<span class="dv">1</span>), <span class="at">newZ =</span> <span class="fu">double</span>(<span class="dv">2</span>)) {</span>
<span id="cb458-12"><a href="cha-progr-with-models.html#cb458-12" aria-hidden="true" tabindex="-1"></a>        myDataNF<span class="sc">$</span>X <span class="ot">&lt;&lt;-</span> newX</span>
<span id="cb458-13"><a href="cha-progr-with-models.html#cb458-13" aria-hidden="true" tabindex="-1"></a>        myDataNF<span class="sc">$</span>Y <span class="ot">&lt;&lt;-</span> newY</span>
<span id="cb458-14"><a href="cha-progr-with-models.html#cb458-14" aria-hidden="true" tabindex="-1"></a>        myDataNF<span class="sc">$</span>Z <span class="ot">&lt;&lt;-</span> newZ</span>
<span id="cb458-15"><a href="cha-progr-with-models.html#cb458-15" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb458-16"><a href="cha-progr-with-models.html#cb458-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb458-17"><a href="cha-progr-with-models.html#cb458-17" aria-hidden="true" tabindex="-1"></a>myDataNF <span class="ot">&lt;-</span> <span class="fu">dataNF</span>()</span>
<span id="cb458-18"><a href="cha-progr-with-models.html#cb458-18" aria-hidden="true" tabindex="-1"></a>myUseDataNF <span class="ot">&lt;-</span> <span class="fu">useDataNF</span>(myDataNF)</span>
<span id="cb458-19"><a href="cha-progr-with-models.html#cb458-19" aria-hidden="true" tabindex="-1"></a>myUseDataNF<span class="sc">$</span><span class="fu">run</span>(<span class="fu">as.numeric</span>(<span class="dv">100</span>), <span class="fu">as.numeric</span>(<span class="dv">100</span><span class="sc">:</span><span class="dv">110</span>),</span>
<span id="cb458-20"><a href="cha-progr-with-models.html#cb458-20" aria-hidden="true" tabindex="-1"></a>                <span class="fu">matrix</span>(<span class="fu">as.numeric</span>(<span class="dv">101</span><span class="sc">:</span><span class="dv">120</span>), <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb458-21"><a href="cha-progr-with-models.html#cb458-21" aria-hidden="true" tabindex="-1"></a>myDataNF<span class="sc">$</span>X</span></code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode" id="cb460"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb460-1"><a href="cha-progr-with-models.html#cb460-1" aria-hidden="true" tabindex="-1"></a>myDataNF<span class="sc">$</span>Y</span></code></pre></div>
<pre><code>##  [1] 100 101 102 103 104 105 106 107 108 109 110</code></pre>
<div class="sourceCode" id="cb462"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb462-1"><a href="cha-progr-with-models.html#cb462-1" aria-hidden="true" tabindex="-1"></a>myDataNF<span class="sc">$</span>Z</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,]  101  103  105  107  109  111  113  115  117   119
## [2,]  102  104  106  108  110  112  114  116  118   120</code></pre>
<div class="sourceCode" id="cb464"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb464-1"><a href="cha-progr-with-models.html#cb464-1" aria-hidden="true" tabindex="-1"></a>myUseDataNF<span class="sc">$</span>myDataNF<span class="sc">$</span>X</span></code></pre></div>
<pre><code>## [1] 100</code></pre>
<div class="sourceCode" id="cb466"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb466-1"><a href="cha-progr-with-models.html#cb466-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nimbleOptions</span>(<span class="at">buildInterfacesForCompiledNestedNimbleFunctions =</span> <span class="cn">TRUE</span>)</span>
<span id="cb466-2"><a href="cha-progr-with-models.html#cb466-2" aria-hidden="true" tabindex="-1"></a>CmyUseDataNF <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(myUseDataNF)</span>
<span id="cb466-3"><a href="cha-progr-with-models.html#cb466-3" aria-hidden="true" tabindex="-1"></a>CmyUseDataNF<span class="sc">$</span><span class="fu">run</span>(<span class="sc">-</span><span class="dv">100</span>, <span class="sc">-</span>(<span class="dv">100</span><span class="sc">:</span><span class="dv">110</span>), <span class="fu">matrix</span>(<span class="sc">-</span>(<span class="dv">101</span><span class="sc">:</span><span class="dv">120</span>), <span class="at">nrow =</span> <span class="dv">2</span>))</span>
<span id="cb466-4"><a href="cha-progr-with-models.html#cb466-4" aria-hidden="true" tabindex="-1"></a>CmyDataNF <span class="ot">&lt;-</span> CmyUseDataNF<span class="sc">$</span>myDataNF</span>
<span id="cb466-5"><a href="cha-progr-with-models.html#cb466-5" aria-hidden="true" tabindex="-1"></a>CmyDataNF<span class="sc">$</span>X</span></code></pre></div>
<pre><code>## [1] -100</code></pre>
<div class="sourceCode" id="cb468"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb468-1"><a href="cha-progr-with-models.html#cb468-1" aria-hidden="true" tabindex="-1"></a>CmyDataNF<span class="sc">$</span>Y</span></code></pre></div>
<pre><code>##  [1] -100 -101 -102 -103 -104 -105 -106 -107 -108 -109 -110</code></pre>
<div class="sourceCode" id="cb470"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb470-1"><a href="cha-progr-with-models.html#cb470-1" aria-hidden="true" tabindex="-1"></a>CmyDataNF<span class="sc">$</span>Z</span></code></pre></div>
<pre><code>##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8] [,9] [,10]
## [1,] -101 -103 -105 -107 -109 -111 -113 -115 -117  -119
## [2,] -102 -104 -106 -108 -110 -112 -114 -116 -118  -120</code></pre>
<p>You’ll notice that:</p>
<ul>
<li>After execution of the compiled function, access to
the <code>X</code>, <code>Y</code>, and <code>Z</code> is the same as for the
uncompiled case. This occurs because <code>CmyUseDataNF</code> is an interface
to the compiled version of <code>myUseDataNF</code>, and it provides access to
member objects and functions. In this case, one member object is
<code>myDataNF</code>, which is an interface to the compiled version of
<code>myUseDataNF$myDataNF</code>, which in turn provides access to <code>X</code>,
<code>Y</code>, and <code>Z</code>. To reduce memory use, NIMBLE defaults to
<em>not</em> providing full interfaces to nested nimbleFunctions like
<code>myUseDataNF$myDataNF</code>. In this example we made it provide full
interfaces by setting the
<code>buildInterfacesForCompiledNestedNimbleFunctions</code> option via
<code>nimbleOptions</code> to TRUE. If we had left that option FALSE (its
default value), we could still get to the values of interest using
<code>valueInCompiledNimbleFunction(CmyDataNF, 'X')</code></li>
<li>We need to take care that at the time of compilation, the
<code>X</code>, <code>Y</code> and <code>Z</code> values contain doubles via
<code>as.numeric</code> so that they are not compiled as integer objects.</li>
<li>The <code>myDataNF</code> could be created in the setup code. We just
provided it as a setup argument to illustrate that option.</li>
</ul>
</div>
</div>
<div id="sec:user-samplers" class="section level2 hasAnchor" number="15.5">
<h2><span class="header-section-number">15.5</span> Example: writing user-defined samplers to extend NIMBLE’s MCMC engine<a href="cha-progr-with-models.html#sec:user-samplers" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>One important use of nimbleFunctions is to write additional samplers that can be used in NIMBLE’s MCMC engine. This allows a user to write a custom sampler for one or more nodes in a model, as well as for programmers to provide general samplers for use in addition to the library of samplers provided with NIMBLE.</p>
<p>The following code illustrates how a NIMBLE developer would implement and use a Metropolis-Hastings random walk sampler with fixed proposal standard deviation.</p>
<div class="sourceCode" id="cb472"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb472-1"><a href="cha-progr-with-models.html#cb472-1" aria-hidden="true" tabindex="-1"></a>my_RW <span class="ot">&lt;-</span> <span class="fu">nimbleFunction</span>(</span>
<span id="cb472-2"><a href="cha-progr-with-models.html#cb472-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-3"><a href="cha-progr-with-models.html#cb472-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">contains =</span> sampler_BASE,</span>
<span id="cb472-4"><a href="cha-progr-with-models.html#cb472-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-5"><a href="cha-progr-with-models.html#cb472-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">setup =</span> <span class="cf">function</span>(model, mvSaved, target, control) {</span>
<span id="cb472-6"><a href="cha-progr-with-models.html#cb472-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># proposal standard deviation</span></span>
<span id="cb472-7"><a href="cha-progr-with-models.html#cb472-7" aria-hidden="true" tabindex="-1"></a>        scale <span class="ot">&lt;-</span> <span class="cf">if</span>(<span class="sc">!</span><span class="fu">is.null</span>(control<span class="sc">$</span>scale)) control<span class="sc">$</span>scale <span class="cf">else</span> <span class="dv">1</span></span>
<span id="cb472-8"><a href="cha-progr-with-models.html#cb472-8" aria-hidden="true" tabindex="-1"></a>        calcNodes <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">getDependencies</span>(target)</span>
<span id="cb472-9"><a href="cha-progr-with-models.html#cb472-9" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb472-10"><a href="cha-progr-with-models.html#cb472-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-11"><a href="cha-progr-with-models.html#cb472-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>() {</span>
<span id="cb472-12"><a href="cha-progr-with-models.html#cb472-12" aria-hidden="true" tabindex="-1"></a>        <span class="co"># initial model logProb</span></span>
<span id="cb472-13"><a href="cha-progr-with-models.html#cb472-13" aria-hidden="true" tabindex="-1"></a>        model_lp_initial <span class="ot">&lt;-</span> <span class="fu">getLogProb</span>(model, calcNodes) </span>
<span id="cb472-14"><a href="cha-progr-with-models.html#cb472-14" aria-hidden="true" tabindex="-1"></a>        <span class="co"># generate proposal</span></span>
<span id="cb472-15"><a href="cha-progr-with-models.html#cb472-15" aria-hidden="true" tabindex="-1"></a>        proposal <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>, model[[target]], scale)     </span>
<span id="cb472-16"><a href="cha-progr-with-models.html#cb472-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># store proposal into model</span></span>
<span id="cb472-17"><a href="cha-progr-with-models.html#cb472-17" aria-hidden="true" tabindex="-1"></a>        model[[target]] <span class="ot">&lt;&lt;-</span> proposal                    </span>
<span id="cb472-18"><a href="cha-progr-with-models.html#cb472-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># proposal model logProb</span></span>
<span id="cb472-19"><a href="cha-progr-with-models.html#cb472-19" aria-hidden="true" tabindex="-1"></a>        model_lp_proposed <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">calculate</span>(calcNodes)</span>
<span id="cb472-20"><a href="cha-progr-with-models.html#cb472-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb472-21"><a href="cha-progr-with-models.html#cb472-21" aria-hidden="true" tabindex="-1"></a>        <span class="co"># log-Metropolis-Hastings ratio</span></span>
<span id="cb472-22"><a href="cha-progr-with-models.html#cb472-22" aria-hidden="true" tabindex="-1"></a>        log_MH_ratio <span class="ot">&lt;-</span> model_lp_proposed <span class="sc">-</span> model_lp_initial</span>
<span id="cb472-23"><a href="cha-progr-with-models.html#cb472-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb472-24"><a href="cha-progr-with-models.html#cb472-24" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Metropolis-Hastings step: determine whether or</span></span>
<span id="cb472-25"><a href="cha-progr-with-models.html#cb472-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># not to accept the newly proposed value</span></span>
<span id="cb472-26"><a href="cha-progr-with-models.html#cb472-26" aria-hidden="true" tabindex="-1"></a>        u <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">1</span>)</span>
<span id="cb472-27"><a href="cha-progr-with-models.html#cb472-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(u <span class="sc">&lt;</span> <span class="fu">exp</span>(log_MH_ratio)) jump <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb472-28"><a href="cha-progr-with-models.html#cb472-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>                      jump <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span>
<span id="cb472-29"><a href="cha-progr-with-models.html#cb472-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb472-30"><a href="cha-progr-with-models.html#cb472-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># keep the model and mvSaved objects consistent</span></span>
<span id="cb472-31"><a href="cha-progr-with-models.html#cb472-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(jump) <span class="fu">copy</span>(<span class="at">from =</span> model, <span class="at">to =</span> mvSaved, <span class="at">row =</span> <span class="dv">1</span>, </span>
<span id="cb472-32"><a href="cha-progr-with-models.html#cb472-32" aria-hidden="true" tabindex="-1"></a>                         <span class="at">nodes =</span> calcNodes, <span class="at">logProb =</span> <span class="cn">TRUE</span>)</span>
<span id="cb472-33"><a href="cha-progr-with-models.html#cb472-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>     <span class="fu">copy</span>(<span class="at">from =</span> mvSaved, <span class="at">to =</span> model, <span class="at">row =</span> <span class="dv">1</span>,</span>
<span id="cb472-34"><a href="cha-progr-with-models.html#cb472-34" aria-hidden="true" tabindex="-1"></a>                         <span class="at">nodes =</span> calcNodes, <span class="at">logProb =</span> <span class="cn">TRUE</span>)</span>
<span id="cb472-35"><a href="cha-progr-with-models.html#cb472-35" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb472-36"><a href="cha-progr-with-models.html#cb472-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb472-37"><a href="cha-progr-with-models.html#cb472-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">methods =</span> <span class="fu">list</span>(   <span class="at">reset =</span> <span class="cf">function</span> () {}   )</span>
<span id="cb472-38"><a href="cha-progr-with-models.html#cb472-38" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The name of this sampler function, for the purposes of using it in an<br />
MCMC algorithm, is <code>my_RW</code>. Thus, this sampler can be added
to an exisiting MCMC configuration object <code>conf</code> using:</p>
<div class="sourceCode" id="cb473"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb473-1"><a href="cha-progr-with-models.html#cb473-1" aria-hidden="true" tabindex="-1"></a>mcmcConf<span class="sc">$</span><span class="fu">addSampler</span>(<span class="at">target =</span> <span class="st">&#39;x&#39;</span>, <span class="at">type =</span> <span class="st">&#39;my_RW&#39;</span>,</span>
<span id="cb473-2"><a href="cha-progr-with-models.html#cb473-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">control =</span> <span class="fu">list</span>(<span class="at">scale =</span> <span class="fl">0.1</span>))</span></code></pre></div>
<p>To be used within the MCMC engine, sampler functions definitions must
adhere exactly to the following:</p>
<ul>
<li>The nimbleFunction must include the contains statement <code>contains = sampler_BASE</code>.</li>
<li>The <code>setup</code> function must have the four arguments
<code>model, mvSaved, target, control</code>, in that order.</li>
<li>The <code>run</code> function must accept no arguments, and have
no return value. Further, after execution it must leave the <code>mvSaved</code>
modelValues object as an up-to-date copy of the values and
logProb values in the model object.</li>
<li>The nimbleFunction must have a member method called <code>reset</code>, which takes no arguments
and has no return value.</li>
</ul>
<p>The purpose of the <code>setup</code> function is generally two-fold. First,
to extract control parameters from the <code>control</code> list; in the
example, the proposal standard deviation <code>scale</code>. It is good
practice to specify default values for any control parameters that are
not provided in the <code>control</code> argument, as done in the example. Second, to
generate any sets of nodes needed in the <code>run</code> function. In many
sampling algorithms, as here, <code>calcNodes</code> is used to represent the
target node(s) and dependencies up to the first layer of
stochastic nodes, as this is precisely what is required for
calculating the Metropolis-Hastings acceptance probability. These
probability calculations are done using <code>model$calculate(calcNodes)</code>.</p>
<p>The purpose of the <code>mvSaved</code> modelValues object is to store the state of the model, including both node values and log probability values, as it exists before any changes are made by the sampler. This allows restoration of the state when a proposal is rejected, as can be seen in the example above. When a proposal is accepted, one should copy from the model into the <code>mvSaved</code> object. NIMBLE’s MCMC engine expects that <code>mvSaved</code> contains an up-to-date copy of model values and logProb values at the end of the run code of a sampler.</p>
<p>Note that NIMBLE generally expects the user-defined sampler to be defined in the global environment.
If you define it in a function (which would generally be the case if you are using it in the context of parallelization), one approach would be to assign the user-defined sampler to the global environment in your function:</p>
<div class="sourceCode" id="cb474"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb474-1"><a href="cha-progr-with-models.html#cb474-1" aria-hidden="true" tabindex="-1"></a><span class="fu">assign</span>(<span class="st">&#39;sampler_yourSampler&#39;</span>, sampler_yourSampler, <span class="at">envir =</span> .GlobalEnv)</span></code></pre></div>
<div id="user-defined-samplers-and-posterior-predictive-nodes" class="section level3 hasAnchor" number="15.5.1">
<h3><span class="header-section-number">15.5.1</span> User-defined samplers and posterior predictive nodes<a href="cha-progr-with-models.html#user-defined-samplers-and-posterior-predictive-nodes" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>As of version 0.13.0, NIMBLE’s handling of posterior predictive nodes in MCMC sampling has changed in order to improve MCMC mixing. Samplers for nodes that are not posterior predictive nodes no longer condition on the values of the posterior predictive nodes. This is done by two changes:</p>
<ul>
<li>turning off posterior predictive nodes as dependencies in the use of <code>getDependencies</code> when building an MCMC, and</li>
<li>moving all posterior predictive samplers to be last in the order of samplers used in an MCMC iteration.</li>
</ul>
<p>The first change calls for careful consideration when writing new samplers. It is done by making <code>buildMCMC</code> set a NIMBLE system option (described below) that tells <code>getDependencies</code> to ignore posterior predictive nodes (defined as nodes that are themselves not data and have no data nodes in their entire downstream (descendant) dependency network) before it builds the samplers (i.e., runs the setup code of each sampler). That way, the setup code of all samplers that use <code>getDependencies</code> will automatically comply with the new system.</p>
<p>User-defined samplers that determine dependencies using <code>getDependencies</code> should automatically work in the new system (although it is worth checking). However if a user-defined sampler manually specifies dependencies, and if those dependencies include posterior predictive nodes, the MCMC results could be incorrect. Whether incorrect results occur could depend on other parts of the model structure connected to node(s) sampled by the user-defined sampler (i.e., the target node(s)) and/or posterior predictive nodes. Therefore, it is strongly recommended that all user-defined samplers rely on <code>getDependencies</code> to determine which nodes depend on the target node(s).</p>
<p>There are several new NIMBLE system options available to take control of the behavior just described.</p>
<ul>
<li><code>getDependenciesIncludesPredictiveNodes</code> determines whether posterior predictive nodes are included in results of <code>getDependencies</code>. This defaults to <code>TRUE</code>, so that outside of building samplers, the behavior of <code>getDependencies</code> should be identical to previous versions of NIMBLE.</li>
<li><code>MCMCusePredictiveDependenciesInCalculations</code> gives the value to which<br />
<code>getDependenciesIncludesPredictiveNodes</code> will be set while building samplers. This defaults to <code>FALSE</code>.</li>
<li><code>MCMCorderPosteriorPredictiveSamplersLast</code> determines whether posterior predictive samplers are moved to the end of the sampler list. This default to <code>TRUE</code>. Behavior prior to version 0.13.0 corresponds to <code>FALSE</code>.</li>
</ul>
<p>Here are some examples of how to use these options:</p>
<ul>
<li>If you want to have MCMC samplers condition on posterior predictive nodes, do <code>nimbleOptions(MCMCusePredictiveDependenciesInCalculations = TRUE)</code>.</li>
<li>If you want to get identical MCMC samplers, including their ordering, as in versions prior to 0.13.0, do <code>nimbleOptions(MCMCusePredictiveDependenciesInCalculations = TRUE)</code> and <code>nimbleOptions(MCMCorderPosteriorPredictiveSamplersLast = FALSE)</code>.</li>
<li>If you want to experiment with the behavior of <code>getDependencies</code> when ignoring posterior predictive nodes, do <code>nimbleOptions(getDependenciesIncludesPredictiveNodes = FALSE)</code>.</li>
</ul>
</div>
</div>
<div id="copying-nimblefunctions-and-nimble-models" class="section level2 hasAnchor" number="15.6">
<h2><span class="header-section-number">15.6</span> Copying nimbleFunctions (and NIMBLE models)<a href="cha-progr-with-models.html#copying-nimblefunctions-and-nimble-models" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>NIMBLE relies heavily on R’s reference class system. When models,
modelValues, and nimbleFunctions with setup code are created, NIMBLE
generates a new, customized reference class definition for each. As a
result, objects of these types are passed by reference and hence
modified in place by most NIMBLE operations. This is necessary to
avoid a great deal of copying and returning and having to reassign
large objects, both in processing models and nimbleFunctions and in
running algorithms.</p>
<p>One cannot generally copy NIMBLE models or nimbleFunctions
(specializations or generators) in a safe fashion, because of the
references to other objects embedded within NIMBLE objects. However,
the model member function <code>newModel</code> will create a new copy of
the model from the same model definition
(Section <a href="cha-building-models.html#sub:multiple-instances">6.1.3</a>). This new model can then be used with
newly instantiated nimbleFunctions.
<!--- % ```{r, copy-model} 
%% newPump <- pumpModel$newModel()
``` --></p>
<p>The reliable way to create new copies of nimbleFunctions is to re-run
the R function called <code>nimbleFunction</code> and record the result in a
new object. For example, say you have a <code>nimbleFunction</code> called
<code>foo</code> and 1000 instances of <code>foo</code> are compiled as part of an
algorithm related to a model called <code>model1</code>. If you then need to use <code>foo</code> in
an algorithm for another model, <code>model2</code>, doing so may work without
any problems. However, there are cases where the NIMBLE compiler will
tell you during compilation that the second set of <code>foo</code> instances
cannot be built from the previous compiled version. A solution is to
re-define <code>foo</code> from the beginning – i.e. call <code>nimbleFunction</code>
again – and then proceed with building and compiling the algorithm
for <code>model2</code>.</p>
</div>
<div id="sec:debugging" class="section level2 hasAnchor" number="15.7">
<h2><span class="header-section-number">15.7</span> Debugging nimbleFunctions<a href="cha-progr-with-models.html#sec:debugging" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>One of the main reasons that NIMBLE provides an R (uncompiled) version
of each nimbleFunction is for debugging. One can call <code>debug</code> on
nimbleFunction methods (in particular the main <em>run</em> method, e.g., <code>debug(mynf$run</code>) and
then step through the code in R using R’s debugger. One can also
insert <code>browser</code> calls into run code and then run the
nimbleFunction from R.</p>
<p>In contrast, directly debugging a compiled nimbleFunction is
difficult, although those familiar with running R through a debugger
and accessing the underlying C code may be able to operate similarly
with NIMBLE code.
We often resort to using <code>print</code> statements for debugging compiled code.
Expert users fluent in C++ may also try setting <code>nimbleOptions(pauseAfterWritingFiles = TRUE)</code> and adding debugging code into the generated C++ files.</p>
</div>
<div id="timing-nimblefunctions-with-run.time" class="section level2 hasAnchor" number="15.8">
<h2><span class="header-section-number">15.8</span> Timing nimbleFunctions with <em>run.time</em><a href="cha-progr-with-models.html#timing-nimblefunctions-with-run.time" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>If your nimbleFunctions are correct but slow to run, you can use benchmarking tools to look for bottlenecks and to compare different implementations.
If your functions are very long-running (say 1ms or more), then standard R benchmarking tools may suffice, e.g. the <code>microbenchmark</code> package</p>
<div class="sourceCode" id="cb475"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb475-1"><a href="cha-progr-with-models.html#cb475-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(microbenchmark)</span>
<span id="cb475-2"><a href="cha-progr-with-models.html#cb475-2" aria-hidden="true" tabindex="-1"></a><span class="fu">microbenchmark</span>(<span class="fu">myCompiledFunVersion1</span>(<span class="fl">1.234</span>),</span>
<span id="cb475-3"><a href="cha-progr-with-models.html#cb475-3" aria-hidden="true" tabindex="-1"></a>               <span class="fu">myCompiledFunVersion2</span>(<span class="fl">1.234</span>))  <span class="co"># Beware R &lt;--&gt; C++ overhead!</span></span></code></pre></div>
<p>If your nimbleFunctions are very fast, say under 1ms, then <code>microbenchmark</code> will be inaccurate due to R-to-C++ conversion overhead (that won’t happen in your actual functions).
To get timing information in C++, NIMBLE provides a <code>run.time</code> function that avoids the R-to-C++ overhead.</p>
<div class="sourceCode" id="cb476"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb476-1"><a href="cha-progr-with-models.html#cb476-1" aria-hidden="true" tabindex="-1"></a>myMicrobenchmark <span class="ot">&lt;-</span> <span class="fu">compileNimble</span>(<span class="fu">nimbleFunction</span>(</span>
<span id="cb476-2"><a href="cha-progr-with-models.html#cb476-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">run =</span> <span class="cf">function</span>(<span class="at">iters =</span> <span class="fu">integer</span>(<span class="dv">0</span>)){</span>
<span id="cb476-3"><a href="cha-progr-with-models.html#cb476-3" aria-hidden="true" tabindex="-1"></a>        time1 <span class="ot">&lt;-</span> <span class="fu">run.time</span>({</span>
<span id="cb476-4"><a href="cha-progr-with-models.html#cb476-4" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iters) <span class="fu">myCompiledFunVersion1</span>(<span class="fl">1.234</span>)</span>
<span id="cb476-5"><a href="cha-progr-with-models.html#cb476-5" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb476-6"><a href="cha-progr-with-models.html#cb476-6" aria-hidden="true" tabindex="-1"></a>        time2 <span class="ot">&lt;-</span> <span class="fu">run.time</span>({</span>
<span id="cb476-7"><a href="cha-progr-with-models.html#cb476-7" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>iters) <span class="fu">myCompiledFunVersion2</span>(<span class="fl">1.234</span>)</span>
<span id="cb476-8"><a href="cha-progr-with-models.html#cb476-8" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb476-9"><a href="cha-progr-with-models.html#cb476-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">return</span>(<span class="fu">c</span>(time1, time2))</span>
<span id="cb476-10"><a href="cha-progr-with-models.html#cb476-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">returnType</span>(<span class="fu">double</span>(<span class="dv">1</span>))</span>
<span id="cb476-11"><a href="cha-progr-with-models.html#cb476-11" aria-hidden="true" tabindex="-1"></a>    }))</span>
<span id="cb476-12"><a href="cha-progr-with-models.html#cb476-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">myMicroBenchmark</span>(<span class="dv">100000</span>))</span></code></pre></div>
</div>
<div id="clearing-and-unloading-compiled-objects" class="section level2 hasAnchor" number="15.9">
<h2><span class="header-section-number">15.9</span> Clearing and unloading compiled objects<a href="cha-progr-with-models.html#clearing-and-unloading-compiled-objects" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Sometimes it is useful to clear all the compiled objects from a
project and unload the shared library produced by your C++ compiler.
To do so, you can use <code>clearCompiled(obj)</code> where <code>obj</code> is a
compiled object such as a compiled model or nimbleFunction (e.g., a
compiled MCMC algorithm). This will clear <em>all</em> compiled objects
associated with your NIMBLE project. For example, if <code>cModel</code> is a
compiled model, <code>clearCompiled(cModel)</code> will clear both the
model and all associated nimbleFunctions such as compiled MCMCs that
use that model. Be careful, use of <code>clearCompiled</code> can be
dangerous. There is some risk that if you have copies of the R
objects that interfaced to compiled C++ objects that have been
removed, and you attempt to use those R objects after clearing their
compiled counterparts, you will crash R. We have tried to
minimize that risk, but we can’t guarantee safe behavior.</p>
</div>
<div id="reducing-memory-usage" class="section level2 hasAnchor" number="15.10">
<h2><span class="header-section-number">15.10</span> Reducing memory usage<a href="cha-progr-with-models.html#reducing-memory-usage" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>NIMBLE can create a lot of objects in its processing, and some of them
use R features such as reference classes that are heavy in memory
usage. We have noticed that building large models can use lots of
memory. To help alleviate this, we provide two options, which can be
controlled via <code>nimbleOptions</code>.</p>
<p>As noted above, the option
<code>buildInterfacesForCompiledNestedNimbleFunctions</code> defaults to FALSE,
which means NIMBLE will not build full interfaces to compiled
nimbleFunctions that ony appear within other nimbleFunctions. If you
want access to all such nimbleFunctions, use the option
<code>buildInterfacesForCompiledNestedNimbleFunctions = TRUE</code>. This will
use more memory but can be useful for debugging.</p>
<p>The option <code>clearNimbleFunctionsAfterCompiling</code> is more drastic, and it is
experimental, so ‘buyer beware’. This will clear much of the
contents of an uncompiled nimbleFunction object after it has been
compiled in an effort to free some memory. We expect to be able to
keep making NIMBLE more efficient – faster execution and lower memory
use – in the future.
<!--- % ### rankSample 
%% \label{sec:ranksample} --></p>

</div>
</div>



<div class="footnotes">
<hr />
<ol start="29">
<li id="fn29"><p>Normally this is the value of the last
evaluated code, or the argument to <code>return</code>.<a href="cha-progr-with-models.html#fnref29" class="footnote-back">↩︎</a></p></li>
<li id="fn30"><p>This can be omitted if you don’t need it.<a href="cha-progr-with-models.html#fnref30" class="footnote-back">↩︎</a></p></li>
<li id="fn31"><p>Note the use of the global assignment operator
to assign into the model. This is necessary for assigning into
variables from the <code>setup</code> function, at least if you want to avoid
warnings from R. These warnings come from R’s reference class
system.<a href="cha-progr-with-models.html#fnref31" class="footnote-back">↩︎</a></p></li>
<li id="fn32"><p>Actually, they can be, but only for uncompiled nimbleFunctions.<a href="cha-progr-with-models.html#fnref32" class="footnote-back">↩︎</a></p></li>
<li id="fn33"><p>Please tell us!<a href="cha-progr-with-models.html#fnref33" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="cha-data-structures.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="cha-AD.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": null,
"text": null
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["NimbleUserManual.pdf", "NimbleUserManual.epub"],
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"toc_depth": 3
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
